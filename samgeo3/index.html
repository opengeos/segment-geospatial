
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://samgeo.gishub.org/samgeo3/">
      
      
        <link rel="prev" href="../samgeo2/">
      
      
        <link rel="next" href="../fast_sam/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>samgeo3 module - segment-geospatial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#samgeo3-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="segment-geospatial" class="md-header__button md-logo" aria-label="segment-geospatial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            segment-geospatial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              samgeo3 module
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/opengeos/segment-geospatial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="segment-geospatial" class="md-nav__button md-logo" aria-label="segment-geospatial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    segment-geospatial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/opengeos/segment-geospatial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/opengeos/segment-geospatial/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Report Issues
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/satellite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Satellite
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/automatic_mask_generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automatic mask generator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/automatic_mask_generator_hq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automatic mask generator hq
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/input_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Input prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/input_prompts_hq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Input prompts hq
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/box_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Box prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/text_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/text_prompts_batch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text prompts batch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/fast_sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fast sam
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/text_swimming_pools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text swimming pools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/arcgis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Arcgis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/maxar_open_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Maxar open data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam2_automatic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam2 automatic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam2_predictor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam2 predictor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam2_video/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam2 video
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam2_box_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam2 box prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam2_point_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam2 point prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam2_text_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam2 text prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/tree_mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tree mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/image_captioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image captioning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_image_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 image segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_image_segmentation_jpg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 image segmentation jpg
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_interactive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 interactive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_batch_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 batch segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_video_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 video segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_video_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 video prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_video_masks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 video masks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_automated_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 automated segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_object_tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 object tracking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_point_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 point prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_point_prompts_batch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 point prompts batch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_box_prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 box prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/sam3_tiled_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sam3 tiled segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/detectree2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Detectree2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Workshops
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workshops
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/purdue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Purdue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/cn_workshop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cn workshop
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/IPPN_2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IPPN 2024
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workshops/AIforGood_2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AIforGood 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../caption/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    caption module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    common module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../samgeo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    samgeo module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../samgeo2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    samgeo2 module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    samgeo3 module
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    samgeo3 module
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3" class="md-nav__link">
    <span class="md-ellipsis">
      
        samgeo3
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3" class="md-nav__link">
    <span class="md-ellipsis">
      
        SamGeo3
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SamGeo3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.__init__--for-text-based-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        For text-based segmentation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.__init__--for-interactive-pointbox-prompts-sam1-style" class="md-nav__link">
    <span class="md-ellipsis">
      
        For interactive point/box prompts (SAM1-style)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_boxes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_boxes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-pixel-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        For pixel coordinates:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-geographic-coordinates-geotiff" class="md-nav__link">
    <span class="md-ellipsis">
      
        For geographic coordinates (GeoTIFF):
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_boxes_inst
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_boxes_inst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--single-box-pixel-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single box (pixel coordinates)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--multiple-boxes-with-geographic-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple boxes with geographic coordinates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-vector-file-geojson-shapefile-etc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a vector file (GeoJSON, Shapefile, etc.)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-geodataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a GeoDataFrame
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_points
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--single-foreground-point-pixel-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single foreground point (pixel coordinates)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--multiple-points-with-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple points with labels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--geographic-coordinates-geotiff" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geographic coordinates (GeoTIFF)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_points_patch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_points_patch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-list-of-geographic-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a list of geographic coordinates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-vector-file-geojson-shapefile-etc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a vector file (GeoJSON, Shapefile, etc.)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-geodataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a GeoDataFrame
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_tiled" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_tiled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst" class="md-nav__link">
    <span class="md-ellipsis">
      
        predict_inst
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict_inst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--single-point-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single point prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--select-best-mask-based-on-score" class="md-nav__link">
    <span class="md-ellipsis">
      
        Select best mask based on score
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--refine-with-additional-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Refine with additional points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--box-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Box prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--combined-box-and-point-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Combined box and point prompt
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        predict_inst_batch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict_inst_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--load-batch-of-images" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load batch of images
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--define-box-prompts-for-each-image" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define box prompts for each image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--predict-masks-for-all-images" class="md-nav__link">
    <span class="md-ellipsis">
      
        Predict masks for all images
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--or-use-point-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Or use point prompts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.raster_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        raster_to_vector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.save_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.save_masks_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_masks_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.save_prediction" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_prediction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.set_confidence_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_confidence_threshold
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.set_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.set_image_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_image_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_anns" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_anns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_anns_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_anns_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_boxes" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_boxes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_canvas" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_canvas
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_inst_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_inst_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_map
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_points" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_points
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video" class="md-nav__link">
    <span class="md-ellipsis">
      
        SamGeo3Video
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SamGeo3Video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __del__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_box_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_box_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_mask_prompt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_mask_prompt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--workflow-use-external-model-sam3-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow: Use external model + SAM3 tracking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-1-get-segmentation-from-another-model-on-first-frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Get segmentation from another model on first frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-2-initialize-sam3-video-tracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Initialize SAM3 video tracker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-3-initialize-tracker-for-external-masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: Initialize tracker for external masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-4-add-external-masks-for-tracking-use-new-obj_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Add external masks for tracking (use new obj_ids)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-5-propagate-to-track-through-video" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5: Propagate to track through video
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_masks_prompt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_masks_prompt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--get-multiple-object-masks-from-external-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get multiple object masks from external model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--initialize-sam3-and-tracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize SAM3 and tracker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--add-all-masks-for-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add all masks for tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_point_prompts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_point_prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-point" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add positive point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-and-negative-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add positive and negative points
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.generate_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.init_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_tracker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.propagate" class="md-nav__link">
    <span class="md-ellipsis">
      
        propagate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.remove_object" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_object
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.save_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.save_video" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_video
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.save_video--with-custom-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom labels
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.set_video" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_video
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_frame
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="show_frame">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frame--with-custom-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom labels
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frames" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_frames
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="show_frames">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frames--with-custom-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom labels
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_video" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_video
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.shutdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        shutdown
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.draw_box_on_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        draw_box_on_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.generate_colors" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_colors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.plot_bbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_bbox
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.plot_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_mask
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fast_sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fast_sam module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hq_sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hq_sam module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../text_sam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    text_sam module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../detectree2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    detectree2 module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3" class="md-nav__link">
    <span class="md-ellipsis">
      
        samgeo3
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3" class="md-nav__link">
    <span class="md-ellipsis">
      
        SamGeo3
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SamGeo3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.__init__--for-text-based-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        For text-based segmentation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.__init__--for-interactive-pointbox-prompts-sam1-style" class="md-nav__link">
    <span class="md-ellipsis">
      
        For interactive point/box prompts (SAM1-style)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_boxes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_boxes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-pixel-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        For pixel coordinates:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-geographic-coordinates-geotiff" class="md-nav__link">
    <span class="md-ellipsis">
      
        For geographic coordinates (GeoTIFF):
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_boxes_inst
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_boxes_inst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--single-box-pixel-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single box (pixel coordinates)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--multiple-boxes-with-geographic-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple boxes with geographic coordinates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-vector-file-geojson-shapefile-etc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a vector file (GeoJSON, Shapefile, etc.)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-geodataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a GeoDataFrame
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_points
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--single-foreground-point-pixel-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single foreground point (pixel coordinates)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--multiple-points-with-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple points with labels
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--geographic-coordinates-geotiff" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geographic coordinates (GeoTIFF)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_by_points_patch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_masks_by_points_patch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-list-of-geographic-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a list of geographic coordinates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-vector-file-geojson-shapefile-etc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a vector file (GeoJSON, Shapefile, etc.)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-geodataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using a GeoDataFrame
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.generate_masks_tiled" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks_tiled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst" class="md-nav__link">
    <span class="md-ellipsis">
      
        predict_inst
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict_inst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--initialize-with-instance-interactivity-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize with instance interactivity enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--single-point-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single point prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--select-best-mask-based-on-score" class="md-nav__link">
    <span class="md-ellipsis">
      
        Select best mask based on score
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--refine-with-additional-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Refine with additional points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--box-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Box prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst--combined-box-and-point-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Combined box and point prompt
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        predict_inst_batch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="predict_inst_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--load-batch-of-images" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load batch of images
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--define-box-prompts-for-each-image" class="md-nav__link">
    <span class="md-ellipsis">
      
        Define box prompts for each image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--predict-masks-for-all-images" class="md-nav__link">
    <span class="md-ellipsis">
      
        Predict masks for all images
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--or-use-point-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Or use point prompts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.raster_to_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        raster_to_vector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.save_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.save_masks_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_masks_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.save_prediction" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_prediction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.set_confidence_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_confidence_threshold
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.set_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.set_image_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_image_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_anns" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_anns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_anns_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_anns_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_boxes" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_boxes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_canvas" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_canvas
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_inst_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_inst_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_map
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3.show_points" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_points
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video" class="md-nav__link">
    <span class="md-ellipsis">
      
        SamGeo3Video
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SamGeo3Video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __del__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_box_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_box_prompt
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_mask_prompt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_mask_prompt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--workflow-use-external-model-sam3-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Workflow: Use external model + SAM3 tracking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-1-get-segmentation-from-another-model-on-first-frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Get segmentation from another model on first frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-2-initialize-sam3-video-tracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Initialize SAM3 video tracker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-3-initialize-tracker-for-external-masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: Initialize tracker for external masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-4-add-external-masks-for-tracking-use-new-obj_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Add external masks for tracking (use new obj_ids)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-5-propagate-to-track-through-video" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5: Propagate to track through video
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_masks_prompt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_masks_prompt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--get-multiple-object-masks-from-external-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get multiple object masks from external model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--initialize-sam3-and-tracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize SAM3 and tracker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--add-all-masks-for-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add all masks for tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_point_prompts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_point_prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-point" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add positive point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-and-negative-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add positive and negative points
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.close" class="md-nav__link">
    <span class="md-ellipsis">
      
        close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.generate_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.init_tracker" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_tracker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.propagate" class="md-nav__link">
    <span class="md-ellipsis">
      
        propagate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.remove_object" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_object
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.save_masks" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_masks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.save_video" class="md-nav__link">
    <span class="md-ellipsis">
      
        save_video
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.save_video--with-custom-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom labels
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.set_video" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_video
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_frame
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="show_frame">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frame--with-custom-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom labels
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frames" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_frames
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="show_frames">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_frames--with-custom-labels" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom labels
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.show_video" class="md-nav__link">
    <span class="md-ellipsis">
      
        show_video
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samgeo.samgeo3.SamGeo3Video.shutdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        shutdown
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.draw_box_on_image" class="md-nav__link">
    <span class="md-ellipsis">
      
        draw_box_on_image
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.generate_colors" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_colors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.plot_bbox" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_bbox
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samgeo.samgeo3.plot_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_mask
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="samgeo3-module">samgeo3 module<a class="headerlink" href="#samgeo3-module" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="samgeo.samgeo3"></a>
    <div class="doc doc-contents first">

        <p>Segmenting remote sensing images with the Segment Anything Model 3 (SAM3).
https://github.com/facebookresearch/sam3</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="samgeo.samgeo3.SamGeo3" class="doc doc-heading">
            <code>SamGeo3</code>


<a href="#samgeo.samgeo3.SamGeo3" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>The main class for segmenting geospatial data with the Segment Anything Model 3 (SAM3).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span>
<span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span>
<span class="normal">3559</span>
<span class="normal">3560</span>
<span class="normal">3561</span>
<span class="normal">3562</span>
<span class="normal">3563</span>
<span class="normal">3564</span>
<span class="normal">3565</span>
<span class="normal">3566</span>
<span class="normal">3567</span>
<span class="normal">3568</span>
<span class="normal">3569</span>
<span class="normal">3570</span>
<span class="normal">3571</span>
<span class="normal">3572</span>
<span class="normal">3573</span>
<span class="normal">3574</span>
<span class="normal">3575</span>
<span class="normal">3576</span>
<span class="normal">3577</span>
<span class="normal">3578</span>
<span class="normal">3579</span>
<span class="normal">3580</span>
<span class="normal">3581</span>
<span class="normal">3582</span>
<span class="normal">3583</span>
<span class="normal">3584</span>
<span class="normal">3585</span>
<span class="normal">3586</span>
<span class="normal">3587</span>
<span class="normal">3588</span>
<span class="normal">3589</span>
<span class="normal">3590</span>
<span class="normal">3591</span>
<span class="normal">3592</span>
<span class="normal">3593</span>
<span class="normal">3594</span>
<span class="normal">3595</span>
<span class="normal">3596</span>
<span class="normal">3597</span>
<span class="normal">3598</span>
<span class="normal">3599</span>
<span class="normal">3600</span>
<span class="normal">3601</span>
<span class="normal">3602</span>
<span class="normal">3603</span>
<span class="normal">3604</span>
<span class="normal">3605</span>
<span class="normal">3606</span>
<span class="normal">3607</span>
<span class="normal">3608</span>
<span class="normal">3609</span>
<span class="normal">3610</span>
<span class="normal">3611</span>
<span class="normal">3612</span>
<span class="normal">3613</span>
<span class="normal">3614</span>
<span class="normal">3615</span>
<span class="normal">3616</span>
<span class="normal">3617</span>
<span class="normal">3618</span>
<span class="normal">3619</span>
<span class="normal">3620</span>
<span class="normal">3621</span>
<span class="normal">3622</span>
<span class="normal">3623</span>
<span class="normal">3624</span>
<span class="normal">3625</span>
<span class="normal">3626</span>
<span class="normal">3627</span>
<span class="normal">3628</span>
<span class="normal">3629</span>
<span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span>
<span class="normal">3637</span>
<span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span>
<span class="normal">3660</span>
<span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span>
<span class="normal">3669</span>
<span class="normal">3670</span>
<span class="normal">3671</span>
<span class="normal">3672</span>
<span class="normal">3673</span>
<span class="normal">3674</span>
<span class="normal">3675</span>
<span class="normal">3676</span>
<span class="normal">3677</span>
<span class="normal">3678</span>
<span class="normal">3679</span>
<span class="normal">3680</span>
<span class="normal">3681</span>
<span class="normal">3682</span>
<span class="normal">3683</span>
<span class="normal">3684</span>
<span class="normal">3685</span>
<span class="normal">3686</span>
<span class="normal">3687</span>
<span class="normal">3688</span>
<span class="normal">3689</span>
<span class="normal">3690</span>
<span class="normal">3691</span>
<span class="normal">3692</span>
<span class="normal">3693</span>
<span class="normal">3694</span>
<span class="normal">3695</span>
<span class="normal">3696</span>
<span class="normal">3697</span>
<span class="normal">3698</span>
<span class="normal">3699</span>
<span class="normal">3700</span>
<span class="normal">3701</span>
<span class="normal">3702</span>
<span class="normal">3703</span>
<span class="normal">3704</span>
<span class="normal">3705</span>
<span class="normal">3706</span>
<span class="normal">3707</span>
<span class="normal">3708</span>
<span class="normal">3709</span>
<span class="normal">3710</span>
<span class="normal">3711</span>
<span class="normal">3712</span>
<span class="normal">3713</span>
<span class="normal">3714</span>
<span class="normal">3715</span>
<span class="normal">3716</span>
<span class="normal">3717</span>
<span class="normal">3718</span>
<span class="normal">3719</span>
<span class="normal">3720</span>
<span class="normal">3721</span>
<span class="normal">3722</span>
<span class="normal">3723</span>
<span class="normal">3724</span>
<span class="normal">3725</span>
<span class="normal">3726</span>
<span class="normal">3727</span>
<span class="normal">3728</span>
<span class="normal">3729</span>
<span class="normal">3730</span>
<span class="normal">3731</span>
<span class="normal">3732</span>
<span class="normal">3733</span>
<span class="normal">3734</span>
<span class="normal">3735</span>
<span class="normal">3736</span>
<span class="normal">3737</span>
<span class="normal">3738</span>
<span class="normal">3739</span>
<span class="normal">3740</span>
<span class="normal">3741</span>
<span class="normal">3742</span>
<span class="normal">3743</span>
<span class="normal">3744</span>
<span class="normal">3745</span>
<span class="normal">3746</span>
<span class="normal">3747</span>
<span class="normal">3748</span>
<span class="normal">3749</span>
<span class="normal">3750</span>
<span class="normal">3751</span>
<span class="normal">3752</span>
<span class="normal">3753</span>
<span class="normal">3754</span>
<span class="normal">3755</span>
<span class="normal">3756</span>
<span class="normal">3757</span>
<span class="normal">3758</span>
<span class="normal">3759</span>
<span class="normal">3760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SamGeo3</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The main class for segmenting geospatial data with the Segment Anything Model 3 (SAM3).&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span>
        <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;facebook/sam3&quot;</span><span class="p">,</span>
        <span class="n">bpe_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">load_from_HF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">enable_segmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">enable_inst_interactivity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compile_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">resolution</span><span class="o">=</span><span class="mi">1008</span><span class="p">,</span>
        <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">mask_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the SamGeo3 class.</span>

<span class="sd">        Args:</span>
<span class="sd">            backend (str): Backend to use (&#39;meta&#39; or &#39;transformers&#39;). Default is &#39;meta&#39;.</span>
<span class="sd">            model_id (str): Model ID for Transformers backend (e.g., &#39;facebook/sam3&#39;).</span>
<span class="sd">                Only used when backend=&#39;transformers&#39;.</span>
<span class="sd">            bpe_path (str, optional): Path to the BPE tokenizer vocabulary (Meta backend only).</span>
<span class="sd">            device (str, optional): Device to load the model on (&#39;cuda&#39; or &#39;cpu&#39;).</span>
<span class="sd">            eval_mode (bool, optional): Whether to set the model to evaluation mode (Meta backend only).</span>
<span class="sd">            checkpoint_path (str, optional): Optional path to model checkpoint (Meta backend only).</span>
<span class="sd">            load_from_HF (bool, optional): Whether to load the model from HuggingFace (Meta backend only).</span>
<span class="sd">            enable_segmentation (bool, optional): Whether to enable segmentation head (Meta backend only).</span>
<span class="sd">            enable_inst_interactivity (bool, optional): Whether to enable instance interactivity</span>
<span class="sd">                (SAM 1 task) (Meta backend only). Set to True to use predict_inst() and</span>
<span class="sd">                predict_inst_batch() methods for interactive point and box prompts.</span>
<span class="sd">                When True, the model loads additional components for SAM1-style</span>
<span class="sd">                interactive instance segmentation. Defaults to False.</span>
<span class="sd">            compile_mode (bool, optional): To enable compilation, set to &quot;default&quot; (Meta backend only).</span>
<span class="sd">            resolution (int, optional): Resolution of the image (Meta backend only).</span>
<span class="sd">            confidence_threshold (float, optional): Confidence threshold for the model.</span>
<span class="sd">            mask_threshold (float, optional): Mask threshold for post-processing (Transformers backend only).</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # For text-based segmentation</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;tree&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # For interactive point/box prompts (SAM1-style)</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">            ...     point_coords=np.array([[520, 375]]),</span>
<span class="sd">            ...     point_labels=np.array([1]),</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">backend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid backend &#39;</span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&#39;. Choose &#39;meta&#39; or &#39;transformers&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SAM3_META_AVAILABLE</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Meta SAM3 is not available. Please install it as:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">pip install segment-geospatial[samgeo3]&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">SAM3_META_IMPORT_ERROR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Underlying import error:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">SAM3_META_IMPORT_ERROR</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;transformers&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SAM3_TRANSFORMERS_AVAILABLE</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Transformers SAM3 is not available. Please install it as:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">pip install transformers torch&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">SAM3_TRANSFORMERS_IMPORT_ERROR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Underlying import error:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">SAM3_TRANSFORMERS_IMPORT_ERROR</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_device</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> device and </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2"> backend&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">confidence_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="s2">&quot;sam3&quot;</span>

        <span class="c1"># Initialize backend-specific components</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_meta_backend</span><span class="p">(</span>
                <span class="n">bpe_path</span><span class="o">=</span><span class="n">bpe_path</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                <span class="n">eval_mode</span><span class="o">=</span><span class="n">eval_mode</span><span class="p">,</span>
                <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span>
                <span class="n">load_from_HF</span><span class="o">=</span><span class="n">load_from_HF</span><span class="p">,</span>
                <span class="n">enable_segmentation</span><span class="o">=</span><span class="n">enable_segmentation</span><span class="p">,</span>
                <span class="n">enable_inst_interactivity</span><span class="o">=</span><span class="n">enable_inst_interactivity</span><span class="p">,</span>
                <span class="n">compile_mode</span><span class="o">=</span><span class="n">compile_mode</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                <span class="n">confidence_threshold</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_transformers_backend</span><span class="p">(</span>
                <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Common attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Batch processing attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_meta_backend</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bpe_path</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">eval_mode</span><span class="p">,</span>
        <span class="n">checkpoint_path</span><span class="p">,</span>
        <span class="n">load_from_HF</span><span class="p">,</span>
        <span class="n">enable_segmentation</span><span class="p">,</span>
        <span class="n">enable_inst_interactivity</span><span class="p">,</span>
        <span class="n">compile_mode</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">,</span>
        <span class="n">confidence_threshold</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize Meta SAM3 backend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bpe_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
            <span class="n">bpe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="s2">&quot;bpe_simple_vocab_16e6.txt.gz&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bpe_path</span><span class="p">):</span>
                <span class="n">bpe_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bpe_path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">bpe_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/giswqs/geospatial/resolve/main/bpe_simple_vocab_16e6.txt.gz&quot;</span>
                <span class="n">bpe_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">bpe_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SAM3_CHECKPOINT_PATH&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SAM3_CHECKPOINT_PATH&quot;</span><span class="p">)</span>
            <span class="n">load_from_HF</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint path </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="n">load_from_HF</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">build_sam3_image_model</span><span class="p">(</span>
            <span class="n">bpe_path</span><span class="o">=</span><span class="n">bpe_path</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">eval_mode</span><span class="o">=</span><span class="n">eval_mode</span><span class="p">,</span>
            <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span>
            <span class="n">load_from_HF</span><span class="o">=</span><span class="n">load_from_HF</span><span class="p">,</span>
            <span class="n">enable_segmentation</span><span class="o">=</span><span class="n">enable_segmentation</span><span class="p">,</span>
            <span class="n">enable_inst_interactivity</span><span class="o">=</span><span class="n">enable_inst_interactivity</span><span class="p">,</span>
            <span class="nb">compile</span><span class="o">=</span><span class="n">compile_mode</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Ensure the model is on the correct device</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">MetaSam3Processor</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">confidence_threshold</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_transformers_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize Transformers SAM3 backend.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sam3Model</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">TransformersSam3Processor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_confidence_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the confidence threshold for the masks.</span>
<span class="sd">        Args:</span>
<span class="sd">            threshold (float): The confidence threshold.</span>
<span class="sd">            state (optional): An optional state object to pass to the processor&#39;s set_confidence_threshold method (Meta backend only).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_confidence_threshold</span><span class="p">(</span>
                <span class="n">threshold</span><span class="p">,</span> <span class="n">state</span>
            <span class="p">)</span>
        <span class="c1"># For transformers backend, the threshold is stored and used during generate_masks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the input image as a numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (Union[str, np.ndarray, Image]): The input image as a path,</span>
<span class="sd">                a numpy array, or an Image.</span>
<span class="sd">            state (optional): An optional state object to pass to the processor&#39;s set_image method (Meta backend only).</span>
<span class="sd">            bands (List[int], optional): List of band indices (1-based) to use for RGB</span>
<span class="sd">                when the input is a GeoTIFF with more than 3 bands. For example,</span>
<span class="sd">                [4, 3, 2] for NIR-R-G false color composite. If None, uses the</span>
<span class="sd">                first 3 bands for multi-band images. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">image</span>

            <span class="c1"># Check if image is a GeoTIFF and handle band selection</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>

                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Validate band indices (1-based)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;bands must contain exactly 3 band indices for RGB.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">band</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Band index </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2"> is out of range. &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;Image has </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands (1-indexed).&quot;</span>
                                <span class="p">)</span>
                        <span class="c1"># Read specified bands (rasterio uses 1-based indexing)</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Read all bands</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="c1"># If more than 3 bands, use first 3</span>
                        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Repeat the first band to make 3 bands: [band1, band2, band1]</span>
                            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># Transpose from (bands, height, width) to (height, width, bands)</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

                    <span class="c1"># Normalize to 8-bit (0-255) range</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">array</span> <span class="o">-=</span> <span class="n">array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">/=</span> <span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">array</span> <span class="o">*=</span> <span class="mi">255</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Input image must be either a path, numpy array, or PIL Image.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Convert to PIL Image for processing</span>
        <span class="n">image_for_processor</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Set image based on backend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="c1"># SAM3&#39;s processor expects PIL Image or tensor with (C, H, W) format</span>
            <span class="c1"># Numpy arrays from cv2 have (H, W, C) format which causes incorrect dimension extraction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span>
                <span class="n">image_for_processor</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
            <span class="c1"># For Transformers backend, we just store the PIL image</span>
            <span class="c1"># Processing will happen during generate_masks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span> <span class="o">=</span> <span class="n">image_for_processor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_image_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">images</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]],</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set multiple images for batch processing.</span>

<span class="sd">        Note: This method is only available for the Meta backend.</span>

<span class="sd">        Args:</span>
<span class="sd">            images (List[Union[str, np.ndarray, Image]]): A list of input images.</span>
<span class="sd">                Each image can be a file path, a numpy array, or a PIL Image.</span>
<span class="sd">            state (dict, optional): An optional state object to pass to the</span>
<span class="sd">                processor&#39;s set_image_batch method.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image_batch([&quot;image1.jpg&quot;, &quot;image2.jpg&quot;, &quot;image3.jpg&quot;])</span>
<span class="sd">            &gt;&gt;&gt; results = sam.generate_masks_batch(&quot;tree&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Batch image processing is only available for the Meta backend. &quot;</span>
                <span class="s2">&quot;Use set_image() for the Transformers backend.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;images must be a non-empty list&quot;</span><span class="p">)</span>

        <span class="c1"># Process each image to PIL format</span>
        <span class="n">pil_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">numpy_images</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
                <span class="n">numpy_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="n">pil_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">numpy_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="n">pil_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">numpy_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
                <span class="n">pil_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Each image must be either a path, numpy array, or PIL Image.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Store batch information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="o">=</span> <span class="n">numpy_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span> <span class="o">=</span> <span class="n">sources</span>

        <span class="c1"># Call the processor&#39;s set_image_batch method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image_batch</span><span class="p">(</span><span class="n">pil_images</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pil_images</span><span class="p">)</span><span class="si">}</span><span class="s2"> images for batch processing.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks for all images in the batch using SAM3.</span>

<span class="sd">        Note: This method is only available for the Meta backend.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The text prompt describing the objects to segment.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out. Defaults to None (no maximum).</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image_batch([&quot;image1.jpg&quot;, &quot;image2.jpg&quot;])</span>
<span class="sd">            &gt;&gt;&gt; results = sam.generate_masks_batch(&quot;building&quot;)</span>
<span class="sd">            &gt;&gt;&gt; for i, result in enumerate(results):</span>
<span class="sd">            ...     print(f&quot;Image {i}: Found {len(result[&#39;masks&#39;])} objects&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Batch mask generation is only available for the Meta backend.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No images set for batch processing. &quot;</span>
                <span class="s2">&quot;Please call set_image_batch() first.&quot;</span>
            <span class="p">)</span>

        <span class="n">batch_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span><span class="p">)</span>

        <span class="c1"># The batch backbone features are computed once, but text prompting</span>
        <span class="c1"># needs to be done per-image since set_text_prompt expects singular</span>
        <span class="c1"># original_height/original_width keys</span>
        <span class="n">backbone_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backbone_out&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
            <span class="c1"># Create a per-image state with the correct singular keys</span>
            <span class="n">image_state</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;original_height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">[</span><span class="s2">&quot;original_heights&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                <span class="s2">&quot;original_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">[</span><span class="s2">&quot;original_widths&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="c1"># Extract backbone features for this specific image</span>
            <span class="c1"># The backbone_out contains batched features, we need to slice them</span>
            <span class="n">image_backbone_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_image_backbone_features</span><span class="p">(</span><span class="n">backbone_out</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">image_state</span><span class="p">[</span><span class="s2">&quot;backbone_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_backbone_out</span>

            <span class="c1"># Reset prompts and set text prompt for this image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">reset_all_prompts</span><span class="p">(</span><span class="n">image_state</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_text_prompt</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">image_state</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>

            <span class="c1"># Build result for this image</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="c1"># Convert tensors to numpy</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_batch_result_to_numpy</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="c1"># Filter by size if needed</span>
            <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_batch_result_by_size</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

            <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="o">=</span> <span class="n">batch_results</span>

        <span class="c1"># Print summary</span>
        <span class="n">total_objects</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">num_images</span><span class="si">}</span><span class="s2"> image(s), found </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="s2"> total object(s).&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_image_backbone_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">backbone_out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">image_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract backbone features for a single image from batched features.</span>

<span class="sd">        Args:</span>
<span class="sd">            backbone_out: Batched backbone output from set_image_batch.</span>
<span class="sd">            image_index: Index of the image to extract features for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing backbone features for a single image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

        <span class="n">image_backbone</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">backbone_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip None values</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;sam2_backbone_out&quot;</span><span class="p">:</span>
                <span class="c1"># Handle nested sam2 backbone output</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">continue</span>

                <span class="n">sam2_out</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">sam2_key</span><span class="p">,</span> <span class="n">sam2_value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sam2_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sam2_out</span><span class="p">[</span><span class="n">sam2_key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">sam2_key</span> <span class="o">==</span> <span class="s2">&quot;backbone_fpn&quot;</span><span class="p">:</span>
                        <span class="c1"># backbone_fpn is a list of feature tensors</span>
                        <span class="n">sam2_out</span><span class="p">[</span><span class="n">sam2_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">feat</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">feat</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">sam2_value</span>
                        <span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sam2_value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                        <span class="n">sam2_out</span><span class="p">[</span><span class="n">sam2_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sam2_value</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sam2_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">sam2_out</span><span class="p">[</span><span class="n">sam2_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">v</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">v</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sam2_value</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sam2_out</span><span class="p">[</span><span class="n">sam2_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sam2_value</span>
                <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sam2_out</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="c1"># Slice the batch dimension</span>
                <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># Handle list of tensors</span>
                <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">v</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Recursively handle nested dicts</span>
                <span class="n">nested</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">nested</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                        <span class="n">nested</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">nested</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">item</span><span class="p">[</span><span class="n">image_index</span> <span class="p">:</span> <span class="n">image_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">item</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nested</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nested</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_backbone</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">image_backbone</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_batch_result_to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert masks, boxes, and scores in a batch result to numpy arrays.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Dictionary containing masks, boxes, scores for one image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with numpy arrays instead of tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

        <span class="c1"># Helper to check if a value is non-empty</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">has_items</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Convert masks</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_items</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
            <span class="n">converted_masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Handle case where masks is a single tensor with batch dimension</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="c1"># If it&#39;s a batched tensor, split into list</span>
                <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">converted_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">converted_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It&#39;s already a list</span>
                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                    <span class="n">converted_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_np</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_masks</span>

        <span class="c1"># Convert boxes</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_items</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
            <span class="n">converted_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="c1"># If it&#39;s a batched tensor [N, 4], split into list</span>
                <span class="k">if</span> <span class="n">boxes</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">converted_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">converted_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                        <span class="n">box_np</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                        <span class="n">box_np</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">box_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">converted_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_np</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_boxes</span>

        <span class="c1"># Convert scores</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_items</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
            <span class="n">converted_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="c1"># If it&#39;s a 1D tensor of scores</span>
                <span class="n">scores_np</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">scores_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">converted_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">scores_np</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores_np</span><span class="p">:</span>
                        <span class="n">converted_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                        <span class="n">score_val</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">score</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;numel&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">score</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="n">score</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
                        <span class="n">score_val</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                        <span class="n">score_val</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">score_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                    <span class="n">converted_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_val</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_scores</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_batch_result_by_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter masks in a batch result by size.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Dictionary containing masks, boxes, scores for one image.</span>
<span class="sd">            min_size: Minimum mask size in pixels.</span>
<span class="sd">            max_size: Maximum mask size in pixels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Filtered result dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">filtered_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">masks</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
            <span class="c1"># Convert mask to numpy if needed</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>

            <span class="c1"># Ensure mask is 2D</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Calculate mask size</span>
            <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

            <span class="c1"># Filter by size</span>
            <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Keep this mask</span>
            <span class="n">filtered_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
                <span class="n">filtered_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
                <span class="n">filtered_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_masks</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_boxes</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_scores</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_masks_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span>
        <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save masks from batch processing to files.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): Directory to save the mask files.</span>
<span class="sd">            prefix (str): Prefix for output filenames. Files will be named</span>
<span class="sd">                &quot;{prefix}_{index}.tif&quot; or &quot;{prefix}_{index}.png&quot;.</span>
<span class="sd">            unique (bool): If True, each mask gets a unique value (1, 2, 3, ...).</span>
<span class="sd">                If False, all masks are combined into a binary mask.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels.</span>
<span class="sd">            dtype (str): Data type for the output array.</span>
<span class="sd">            **kwargs: Additional arguments passed to common.array_to_image().</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: List of paths to saved mask files.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image_batch([&quot;img1.tif&quot;, &quot;img2.tif&quot;])</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_batch(&quot;building&quot;)</span>
<span class="sd">            &gt;&gt;&gt; saved_files = sam.save_masks_batch(&quot;output/&quot;, prefix=&quot;building_mask&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No batch results found. Please run generate_masks_batch() first.&quot;</span>
            <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">):</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">masks</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No masks for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get image dimensions</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to get from first mask</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine dimensions for image </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create combined mask array</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
            <span class="p">)</span>

            <span class="n">valid_mask_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                <span class="c1"># Convert to numpy</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>

                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
                    <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_mask_count</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

                <span class="n">valid_mask_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">valid_mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid masks for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> after filtering.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Convert dtype</span>
            <span class="k">if</span> <span class="n">unique</span> <span class="ow">and</span> <span class="n">valid_mask_count</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> masks exceed </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> range. Consider using uint16 or uint32.&quot;</span>
                <span class="p">)</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

            <span class="c1"># Determine output path and extension</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.png&quot;</span>

            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Save</span>
            <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span>
                <span class="n">mask_array</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> mask(s) for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">saved_files</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_anns_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">show_bbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;anns&quot;</span><span class="p">,</span>
        <span class="n">blend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">ncols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show annotations for all images in the batch.</span>

<span class="sd">        Args:</span>
<span class="sd">            figsize (tuple): Figure size for each subplot.</span>
<span class="sd">            axis (str): Whether to show axis.</span>
<span class="sd">            show_bbox (bool): Whether to show bounding boxes.</span>
<span class="sd">            show_score (bool): Whether to show confidence scores.</span>
<span class="sd">            output_dir (str, optional): Directory to save annotation images.</span>
<span class="sd">                If None, displays the figure.</span>
<span class="sd">            prefix (str): Prefix for output filenames.</span>
<span class="sd">            blend (bool): Whether to show image as background.</span>
<span class="sd">            alpha (float): Alpha value for mask overlay.</span>
<span class="sd">            ncols (int): Number of columns in the grid display.</span>
<span class="sd">            **kwargs: Additional arguments for saving.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No batch results found. Please run generate_masks_batch() first.&quot;</span>
            <span class="p">)</span>

        <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Save each image separately</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_show_single_ann</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                    <span class="n">show_bbox</span><span class="o">=</span><span class="n">show_bbox</span><span class="p">,</span>
                    <span class="n">show_score</span><span class="o">=</span><span class="n">show_score</span><span class="p">,</span>
                    <span class="n">blend</span><span class="o">=</span><span class="n">blend</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Display in grid</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_images</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">num_images</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_show_single_ann</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                    <span class="n">show_bbox</span><span class="o">=</span><span class="n">show_bbox</span><span class="p">,</span>
                    <span class="n">show_score</span><span class="o">=</span><span class="n">show_score</span><span class="p">,</span>
                    <span class="n">blend</span><span class="o">=</span><span class="n">blend</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Hide unused subplots</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_show_single_ann</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">show_bbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">blend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show annotations for a single batch result.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Dictionary containing masks, boxes, scores, and image.</span>
<span class="sd">            figsize: Figure size.</span>
<span class="sd">            axis: Whether to show axis.</span>
<span class="sd">            show_bbox: Whether to show bounding boxes.</span>
<span class="sd">            show_score: Whether to show scores.</span>
<span class="sd">            blend: Whether to blend with original image.</span>
<span class="sd">            alpha: Alpha for mask overlay.</span>
<span class="sd">            output: Path to save the figure.</span>
<span class="sd">            ax: Matplotlib axis to plot on.</span>
<span class="sd">            **kwargs: Additional arguments for saving.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">own_figure</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">own_figure</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">img_pil</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">blend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_pil</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">white_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">white_background</span><span class="p">)</span>

        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">COLORS</span> <span class="o">=</span> <span class="n">generate_colors</span><span class="p">(</span><span class="n">n_colors</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">COLORS</span><span class="p">)]</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">plot_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show_bbox</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_score</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(id=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">prob</span><span class="si">=:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(id=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span>

                <span class="n">box</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                <span class="n">plot_bbox</span><span class="p">(</span>
                    <span class="n">h</span><span class="p">,</span>
                    <span class="n">w</span><span class="p">,</span>
                    <span class="n">box</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                    <span class="n">box_format</span><span class="o">=</span><span class="s2">&quot;XYXY&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">relative_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">own_figure</span><span class="p">:</span>
            <span class="n">save_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bbox_inches&quot;</span><span class="p">:</span> <span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="s2">&quot;pad_inches&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;dpi&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
            <span class="n">save_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">save_kwargs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved annotations to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">own_figure</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks for the input image using SAM3.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The text prompt describing the objects to segment.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">            quiet (bool): If True, suppress progress messages. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: A list of dictionaries containing the generated masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">reset_all_prompts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_text_prompt</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pil_image&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

            <span class="c1"># Prepare inputs</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
                <span class="n">images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Get original sizes for post-processing</span>
            <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_sizes&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">original_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">original_sizes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">original_sizes</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">]]</span>

            <span class="c1"># Run inference</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

            <span class="c1"># Post-process results</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">post_process_instance_segmentation</span><span class="p">(</span>
                <span class="n">outputs</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">,</span>
                <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">,</span>
                <span class="n">target_sizes</span><span class="o">=</span><span class="n">original_sizes</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert results to match Meta backend format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>

        <span class="c1"># Convert tensors to numpy to free GPU memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_results_to_numpy</span><span class="p">()</span>

        <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
        <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please try a different prompt.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_tiled</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint32&quot;</span><span class="p">,</span>
        <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks for large GeoTIFF images using a sliding window approach.</span>

<span class="sd">        This method processes large images tile by tile to avoid GPU memory issues.</span>
<span class="sd">        The tiles are processed with overlap to ensure seamless mask merging at</span>
<span class="sd">        boundaries. Each detected object gets a unique ID that is consistent</span>
<span class="sd">        across the entire image.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str): Path to the input GeoTIFF image.</span>
<span class="sd">            prompt (str): The text prompt describing the objects to segment.</span>
<span class="sd">            output (str): Path to the output GeoTIFF file.</span>
<span class="sd">            tile_size (int): Size of each tile in pixels. Defaults to 1024.</span>
<span class="sd">            overlap (int): Overlap between adjacent tiles in pixels. Defaults to 128.</span>
<span class="sd">                Higher overlap helps with better boundary merging but increases</span>
<span class="sd">                processing time.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">            unique (bool): If True, each mask gets a unique value. If False, binary</span>
<span class="sd">                mask (0 or 1). Defaults to True.</span>
<span class="sd">            dtype (str): Data type for the output array. Use &#39;uint32&#39; for large</span>
<span class="sd">                numbers of objects, &#39;uint16&#39; for up to 65535 objects, or &#39;uint8&#39;</span>
<span class="sd">                for up to 255 objects. Defaults to &#39;uint32&#39;.</span>
<span class="sd">            bands (List[int], optional): List of band indices (1-based) to use for RGB</span>
<span class="sd">                when the input has more than 3 bands. If None, uses first 3 bands.</span>
<span class="sd">            batch_size (int): Number of tiles to process at once (future use).</span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">            verbose (bool): Whether to print progress information. Defaults to True.</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Path to the output GeoTIFF file.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_tiled(</span>
<span class="sd">            ...     source=&quot;large_satellite_image.tif&quot;,</span>
<span class="sd">            ...     prompt=&quot;building&quot;,</span>
<span class="sd">            ...     output=&quot;buildings_mask.tif&quot;,</span>
<span class="sd">            ...     tile_size=1024,</span>
<span class="sd">            ...     overlap=128,</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.windows</span><span class="w"> </span><span class="kn">import</span> <span class="n">Window</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source must be a GeoTIFF file for tiled processing.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source file not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tile_size</span> <span class="o">&lt;=</span> <span class="n">overlap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tile_size must be greater than overlap&quot;</span><span class="p">)</span>

        <span class="c1"># Open the source file to get metadata</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">img_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
            <span class="n">img_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing image: </span><span class="si">{</span><span class="n">img_width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">img_height</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tile size: </span><span class="si">{</span><span class="n">tile_size</span><span class="si">}</span><span class="s2">, Overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate the number of tiles</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">tile_size</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="n">n_tiles_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="n">overlap</span> <span class="o">+</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">n_tiles_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="n">overlap</span> <span class="o">+</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">n_tiles_x</span> <span class="o">*</span> <span class="n">n_tiles_y</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles to process: </span><span class="si">{</span><span class="n">total_tiles</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_tiles_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">n_tiles_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Determine output dtype</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
            <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
            <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
            <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>
            <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">65535</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint32&quot;</span><span class="p">:</span>
            <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>
            <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">4294967295</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>
            <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">4294967295</span>

        <span class="c1"># Create output array in memory (for smaller images) or use memory-mapped file</span>
        <span class="c1"># For very large images, you might want to use rasterio windowed writing</span>
        <span class="n">output_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_dtype</span><span class="p">)</span>

        <span class="c1"># Track unique object IDs across all tiles</span>
        <span class="n">current_max_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_objects</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Process each tile</span>
        <span class="n">tile_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="n">total_tiles</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tiles&quot;</span><span class="p">,</span>
            <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">tile_idx</span> <span class="ow">in</span> <span class="n">tile_iterator</span><span class="p">:</span>
            <span class="c1"># Calculate tile position</span>
            <span class="n">tile_y</span> <span class="o">=</span> <span class="n">tile_idx</span> <span class="o">//</span> <span class="n">n_tiles_x</span>
            <span class="n">tile_x</span> <span class="o">=</span> <span class="n">tile_idx</span> <span class="o">%</span> <span class="n">n_tiles_x</span>

            <span class="c1"># Calculate window coordinates</span>
            <span class="n">x_start</span> <span class="o">=</span> <span class="n">tile_x</span> <span class="o">*</span> <span class="n">step</span>
            <span class="n">y_start</span> <span class="o">=</span> <span class="n">tile_y</span> <span class="o">*</span> <span class="n">step</span>

            <span class="c1"># Ensure we don&#39;t go beyond image bounds</span>
            <span class="n">x_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">img_width</span><span class="p">)</span>
            <span class="n">y_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_start</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">img_height</span><span class="p">)</span>

            <span class="c1"># Adjust start if we&#39;re at the edge</span>
            <span class="k">if</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span> <span class="o">&lt;</span> <span class="n">tile_size</span> <span class="ow">and</span> <span class="n">x_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span> <span class="o">&lt;</span> <span class="n">tile_size</span> <span class="ow">and</span> <span class="n">y_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span>

            <span class="n">window_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>
            <span class="n">window_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>

            <span class="c1"># Read tile from source</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                    <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">tile_data</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">tile_data</span><span class="p">,</span> <span class="n">tile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                        <span class="p">)</span>

            <span class="c1"># Transpose to (height, width, channels)</span>
            <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tile_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="c1"># Normalize to 8-bit</span>
            <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">tile_data</span> <span class="o">-=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tile_data</span> <span class="o">/=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">tile_data</span> <span class="o">*=</span> <span class="mi">255</span>
            <span class="n">tile_image</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Process the tile</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Set image for the tile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">tile_image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">tile_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Don&#39;t need georef for individual tiles</span>

                <span class="c1"># Initialize inference state for this tile</span>
                <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">tile_image</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span> <span class="o">=</span> <span class="n">pil_image</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">pil_image</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For transformers backend, process directly</span>
                    <span class="k">pass</span>

                <span class="c1"># Generate masks for this tile (quiet=True to avoid per-tile messages)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_masks</span><span class="p">(</span>
                    <span class="n">prompt</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># Get masks for this tile</span>
                <span class="n">tile_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span>

                <span class="k">if</span> <span class="n">tile_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Create a mask array for this tile</span>
                    <span class="n">tile_mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_dtype</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">tile_masks</span><span class="p">:</span>
                        <span class="c1"># Convert mask to numpy</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mask_np</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Resize mask to tile size if needed</span>
                        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">):</span>
                            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                                <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">),</span>
                                <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                            <span class="p">)</span>

                        <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

                        <span class="c1"># Filter by size</span>
                        <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
                            <span class="n">current_max_id</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">current_max_id</span> <span class="o">&gt;</span> <span class="n">max_objects</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Maximum number of objects (</span><span class="si">{</span><span class="n">max_objects</span><span class="si">}</span><span class="s2">) exceeded. &quot;</span>
                                    <span class="s2">&quot;Consider using a larger dtype or reducing the number of objects.&quot;</span>
                                <span class="p">)</span>
                            <span class="n">tile_mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_max_id</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tile_mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                        <span class="n">total_objects</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Merge tile mask into output mask</span>
                    <span class="c1"># For overlapping regions, use the tile&#39;s values if they are non-zero</span>
                    <span class="c1"># This simple approach works well for most cases</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_merge_tile_mask</span><span class="p">(</span>
                        <span class="n">output_mask</span><span class="p">,</span>
                        <span class="n">tile_mask_array</span><span class="p">,</span>
                        <span class="n">x_start</span><span class="p">,</span>
                        <span class="n">y_start</span><span class="p">,</span>
                        <span class="n">x_end</span><span class="p">,</span>
                        <span class="n">y_end</span><span class="p">,</span>
                        <span class="n">overlap</span><span class="p">,</span>
                        <span class="n">tile_x</span><span class="p">,</span>
                        <span class="n">tile_y</span><span class="p">,</span>
                        <span class="n">n_tiles_x</span><span class="p">,</span>
                        <span class="n">n_tiles_y</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to process tile (</span><span class="si">{</span><span class="n">tile_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">tile_y</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Clear GPU memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;inference_state&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Additionally clear PyTorch CUDA cache, if available, to free GPU memory</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="c1"># If torch is not installed, skip CUDA cache clearing</span>
                <span class="k">pass</span>
        <span class="c1"># Update output profile</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
                <span class="s2">&quot;compress&quot;</span><span class="p">:</span> <span class="s2">&quot;deflate&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Save the output</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved mask to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total objects found: </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Store result for potential visualization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">output_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_tile_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">tile_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">x_end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y_end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">tile_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_tiles_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_tiles_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge a tile mask into the output mask, handling overlapping regions.</span>

<span class="sd">        For overlapping regions, this uses a blending approach where we prioritize</span>
<span class="sd">        the current tile&#39;s mask in the non-overlapping core region, and for the</span>
<span class="sd">        overlap region, we keep existing values unless they are zero.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_mask: The full output mask array.</span>
<span class="sd">            tile_mask: The mask from the current tile.</span>
<span class="sd">            x_start, y_start: Start coordinates of the tile in the output.</span>
<span class="sd">            x_end, y_end: End coordinates of the tile in the output.</span>
<span class="sd">            overlap: The overlap size.</span>
<span class="sd">            tile_x, tile_y: Tile indices.</span>
<span class="sd">            n_tiles_x, n_tiles_y: Total number of tiles in each direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tile_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>
        <span class="n">tile_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>

        <span class="c1"># Calculate the core region (non-overlapping part)</span>
        <span class="c1"># The overlap should be split between adjacent tiles</span>
        <span class="n">left_overlap</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">tile_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">right_overlap</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">tile_x</span> <span class="o">&lt;</span> <span class="n">n_tiles_x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">top_overlap</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">tile_y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">bottom_overlap</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">tile_y</span> <span class="o">&lt;</span> <span class="n">n_tiles_y</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Core region in tile coordinates</span>
        <span class="n">core_x_start</span> <span class="o">=</span> <span class="n">left_overlap</span>
        <span class="n">core_x_end</span> <span class="o">=</span> <span class="n">tile_width</span> <span class="o">-</span> <span class="n">right_overlap</span>
        <span class="n">core_y_start</span> <span class="o">=</span> <span class="n">top_overlap</span>
        <span class="n">core_y_end</span> <span class="o">=</span> <span class="n">tile_height</span> <span class="o">-</span> <span class="n">bottom_overlap</span>

        <span class="c1"># Copy core region (always overwrite)</span>
        <span class="n">out_y_start</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">core_y_start</span>
        <span class="n">out_y_end</span> <span class="o">=</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">core_y_end</span>
        <span class="n">out_x_start</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">core_x_start</span>
        <span class="n">out_x_end</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">core_x_end</span>

        <span class="n">output_mask</span><span class="p">[</span><span class="n">out_y_start</span><span class="p">:</span><span class="n">out_y_end</span><span class="p">,</span> <span class="n">out_x_start</span><span class="p">:</span><span class="n">out_x_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span>
            <span class="n">core_y_start</span><span class="p">:</span><span class="n">core_y_end</span><span class="p">,</span> <span class="n">core_x_start</span><span class="p">:</span><span class="n">core_x_end</span>
        <span class="p">]</span>

        <span class="c1"># Handle overlap regions - only update if output is zero</span>
        <span class="c1"># Top overlap</span>
        <span class="k">if</span> <span class="n">top_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span><span class="n">y_start</span> <span class="p">:</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">top_overlap</span><span class="p">,</span> <span class="n">out_x_start</span><span class="p">:</span><span class="n">out_x_end</span><span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_overlap</span><span class="p">,</span> <span class="n">core_x_start</span><span class="p">:</span><span class="n">core_x_end</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Bottom overlap</span>
        <span class="k">if</span> <span class="n">bottom_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span><span class="n">out_y_end</span><span class="p">:</span><span class="n">y_end</span><span class="p">,</span> <span class="n">out_x_start</span><span class="p">:</span><span class="n">out_x_end</span><span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="n">core_y_end</span><span class="p">:</span><span class="n">tile_height</span><span class="p">,</span> <span class="n">core_x_start</span><span class="p">:</span><span class="n">core_x_end</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Left overlap</span>
        <span class="k">if</span> <span class="n">left_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span>
                <span class="n">out_y_start</span><span class="p">:</span><span class="n">out_y_end</span><span class="p">,</span> <span class="n">x_start</span> <span class="p">:</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">left_overlap</span>
            <span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="n">core_y_start</span><span class="p">:</span><span class="n">core_y_end</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">left_overlap</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Right overlap</span>
        <span class="k">if</span> <span class="n">right_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span><span class="n">out_y_start</span><span class="p">:</span><span class="n">out_y_end</span><span class="p">,</span> <span class="n">out_x_end</span><span class="p">:</span><span class="n">x_end</span><span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="n">core_y_start</span><span class="p">:</span><span class="n">core_y_end</span><span class="p">,</span> <span class="n">core_x_end</span><span class="p">:</span><span class="n">tile_width</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Corner overlaps</span>
        <span class="c1"># Top-left</span>
        <span class="k">if</span> <span class="n">top_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">left_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span>
                <span class="n">y_start</span> <span class="p">:</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">top_overlap</span><span class="p">,</span> <span class="n">x_start</span> <span class="p">:</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">left_overlap</span>
            <span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_overlap</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">left_overlap</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Top-right</span>
        <span class="k">if</span> <span class="n">top_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">right_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span><span class="n">y_start</span> <span class="p">:</span> <span class="n">y_start</span> <span class="o">+</span> <span class="n">top_overlap</span><span class="p">,</span> <span class="n">out_x_end</span><span class="p">:</span><span class="n">x_end</span><span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_overlap</span><span class="p">,</span> <span class="n">core_x_end</span><span class="p">:</span><span class="n">tile_width</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Bottom-left</span>
        <span class="k">if</span> <span class="n">bottom_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">left_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span><span class="n">out_y_end</span><span class="p">:</span><span class="n">y_end</span><span class="p">,</span> <span class="n">x_start</span> <span class="p">:</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">left_overlap</span><span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="n">core_y_end</span><span class="p">:</span><span class="n">tile_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">left_overlap</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Bottom-right</span>
        <span class="k">if</span> <span class="n">bottom_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">right_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">output_mask</span><span class="p">[</span><span class="n">out_y_end</span><span class="p">:</span><span class="n">y_end</span><span class="p">,</span> <span class="n">out_x_end</span><span class="p">:</span><span class="n">x_end</span><span class="p">]</span>
            <span class="n">tile_region</span> <span class="o">=</span> <span class="n">tile_mask</span><span class="p">[</span><span class="n">core_y_end</span><span class="p">:</span><span class="n">tile_height</span><span class="p">,</span> <span class="n">core_x_end</span><span class="p">:</span><span class="n">tile_width</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_region</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_boxes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">boxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">box_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks using bounding box prompts.</span>

<span class="sd">        Args:</span>
<span class="sd">            boxes (List[List[float]]): List of bounding boxes in XYXY format</span>
<span class="sd">                [[xmin, ymin, xmax, ymax], ...].</span>
<span class="sd">                If box_crs is None: pixel coordinates.</span>
<span class="sd">                If box_crs is specified: coordinates in the given CRS (e.g., &quot;EPSG:4326&quot;).</span>
<span class="sd">            box_labels (List[bool], optional): List of boolean labels for each box.</span>
<span class="sd">                True for positive prompt (include), False for negative prompt (exclude).</span>
<span class="sd">                If None, all boxes are treated as positive prompts.</span>
<span class="sd">            box_crs (str, optional): Coordinate reference system for box coordinates</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot; for lat/lon). Only used if the source image is a GeoTIFF.</span>
<span class="sd">                If None, boxes are assumed to be in pixel coordinates.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary containing masks, boxes, and scores.</span>

<span class="sd">        Example:</span>
<span class="sd">            # For pixel coordinates:</span>
<span class="sd">            boxes = [[100, 200, 300, 400]]</span>
<span class="sd">            sam.generate_masks_by_boxes(boxes)</span>

<span class="sd">            # For geographic coordinates (GeoTIFF):</span>
<span class="sd">            boxes = [[-122.5, 37.7, -122.4, 37.8]]  # [lon_min, lat_min, lon_max, lat_max]</span>
<span class="sd">            sam.generate_masks_by_boxes(boxes, box_crs=&quot;EPSG:4326&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pil_image&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">box_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_labels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of boxes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match number of labels (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">box_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Transform boxes from CRS to pixel coordinates if needed</span>
        <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pixel_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>

                <span class="c1"># Transform min corner</span>
                <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
                <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># Transform max corner</span>
                <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
                <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># Convert to pixel coordinates and ensure correct min/max order</span>
                <span class="c1"># (geographic y increases north, pixel y increases down)</span>
                <span class="n">x1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Ensure we have correct min/max values</span>
                <span class="n">x_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
                <span class="n">y_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>
                <span class="n">x_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
                <span class="n">y_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>

                <span class="n">pixel_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_min_px</span><span class="p">,</span> <span class="n">y_min_px</span><span class="p">,</span> <span class="n">x_max_px</span><span class="p">,</span> <span class="n">y_max_px</span><span class="p">])</span>

            <span class="n">boxes</span> <span class="o">=</span> <span class="n">pixel_boxes</span>

        <span class="c1"># Get image dimensions</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="c1"># Reset all prompts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">reset_all_prompts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">)</span>

            <span class="c1"># Process each box</span>
            <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_labels</span><span class="p">):</span>
                <span class="c1"># Convert XYXY to CxCyWH format</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>

                <span class="c1"># Normalize to [0, 1] range</span>
                <span class="n">norm_box</span> <span class="o">=</span> <span class="p">[</span><span class="n">cx</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">cy</span> <span class="o">/</span> <span class="n">height</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">h</span> <span class="o">/</span> <span class="n">height</span><span class="p">]</span>

                <span class="c1"># Add geometric prompt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">add_geometric_prompt</span><span class="p">(</span>
                    <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">norm_box</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span>
                <span class="p">)</span>

            <span class="c1"># Get the masks from the inference state</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
            <span class="c1"># For Transformers backend, process boxes with the processor</span>
            <span class="c1"># Convert boxes to the format expected by Transformers</span>
            <span class="c1"># Transformers expects boxes in XYXY format with 3 levels of nesting:</span>
            <span class="c1"># [image level, box level, box coordinates]</span>
            <span class="c1"># Also convert numpy types to Python native types</span>
            <span class="n">input_boxes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">box</span><span class="p">]</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">]</span>
            <span class="p">]</span>  <span class="c1"># Wrap in list for image level and convert to float</span>

            <span class="c1"># Prepare inputs with boxes</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
                <span class="n">images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">input_boxes</span><span class="o">=</span><span class="n">input_boxes</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Get original sizes for post-processing</span>
            <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_sizes&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">original_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">original_sizes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">original_sizes</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">]]</span>

            <span class="c1"># Run inference</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

            <span class="c1"># Post-process results</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">post_process_instance_segmentation</span><span class="p">(</span>
                <span class="n">outputs</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">,</span>
                <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">,</span>
                <span class="n">target_sizes</span><span class="o">=</span><span class="n">original_sizes</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert results to match Meta backend format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>

        <span class="c1"># Convert tensors to numpy to free GPU memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_results_to_numpy</span><span class="p">()</span>

        <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
        <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your box prompts.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">point_coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks using point prompts.</span>

<span class="sd">        This is a high-level method that wraps predict_inst() for ease of use.</span>
<span class="sd">        It stores the results in self.masks, self.scores, and self.boxes for</span>
<span class="sd">        subsequent use with show_anns(), show_masks(), and save_masks().</span>

<span class="sd">        Note: This method requires the model to be initialized with</span>
<span class="sd">        `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">        Args:</span>
<span class="sd">            point_coords (List[List[float]]): List of point coordinates [[x, y], ...].</span>
<span class="sd">                If point_crs is None: pixel coordinates.</span>
<span class="sd">                If point_crs is specified: coordinates in the given CRS (e.g., &quot;EPSG:4326&quot;).</span>
<span class="sd">            point_labels (List[int], optional): List of labels for each point.</span>
<span class="sd">                1 = foreground (include), 0 = background (exclude).</span>
<span class="sd">                If None, all points are treated as foreground (label=1).</span>
<span class="sd">            point_crs (str, optional): Coordinate reference system for point coordinates</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot; for lat/lon). Only used if the source image is a GeoTIFF.</span>
<span class="sd">                If None, points are assumed to be in pixel coordinates.</span>
<span class="sd">            multimask_output (bool): If True, the model returns 3 masks and the best</span>
<span class="sd">                one is selected by score. Recommended for ambiguous prompts like single</span>
<span class="sd">                points. If False, returns single mask directly. Defaults to True.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to predict_inst().</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary containing masks, scores, and logits.</span>

<span class="sd">        Example:</span>
<span class="sd">            # Initialize with instance interactivity enabled</span>
<span class="sd">            sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            sam.set_image(&quot;image.jpg&quot;)</span>

<span class="sd">            # Single foreground point (pixel coordinates)</span>
<span class="sd">            sam.generate_masks_by_points([[520, 375]])</span>
<span class="sd">            sam.show_anns()</span>
<span class="sd">            sam.save_masks(&quot;mask.png&quot;)</span>

<span class="sd">            # Multiple points with labels</span>
<span class="sd">            sam.generate_masks_by_points(</span>
<span class="sd">                [[500, 375], [1125, 625]],</span>
<span class="sd">                point_labels=[1, 0]  # foreground, background</span>
<span class="sd">            )</span>

<span class="sd">            # Geographic coordinates (GeoTIFF)</span>
<span class="sd">            sam.generate_masks_by_points(</span>
<span class="sd">                [[-122.258, 37.871]],</span>
<span class="sd">                point_crs=&quot;EPSG:4326&quot;</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;generate_masks_by_points is only available for the Meta backend. &quot;</span>
                <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
                <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Convert to numpy array if it&#39;s a list</span>
        <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>

        <span class="c1"># Default all points to foreground if no labels provided</span>
        <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_labels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of points (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match number of labels (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Call predict_inst with the prompts</span>
        <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_inst</span><span class="p">(</span>
            <span class="n">point_coords</span><span class="o">=</span><span class="n">point_coords</span><span class="p">,</span>
            <span class="n">point_labels</span><span class="o">=</span><span class="n">point_labels</span><span class="p">,</span>
            <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
            <span class="n">point_crs</span><span class="o">=</span><span class="n">point_crs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If multimask_output=True, select the best mask by score</span>
        <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">best_idx</span> <span class="p">:</span> <span class="n">best_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">best_idx</span> <span class="p">:</span> <span class="n">best_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">best_idx</span> <span class="p">:</span> <span class="n">best_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Store results in the format expected by show_anns/show_masks/save_masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">scores</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

        <span class="c1"># Compute bounding boxes from masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
        <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your point prompts.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_boxes_inst</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">boxes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;gpd.GeoDataFrame&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks using bounding box prompts with instance interactivity.</span>

<span class="sd">        This is a high-level method that wraps predict_inst() for ease of use.</span>
<span class="sd">        It stores the results in self.masks, self.scores, and self.boxes for</span>
<span class="sd">        subsequent use with show_anns(), show_masks(), and save_masks().</span>

<span class="sd">        Note: This method requires the model to be initialized with</span>
<span class="sd">        `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">        Args:</span>
<span class="sd">            boxes (List[List[float]] | str | GeoDataFrame): Bounding boxes for</span>
<span class="sd">                segmentation. Can be:</span>
<span class="sd">                - A list of [xmin, ymin, xmax, ymax] coordinates</span>
<span class="sd">                - A file path to a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">                - A GeoDataFrame with polygon geometries</span>
<span class="sd">                If box_crs is None: pixel coordinates (for list input).</span>
<span class="sd">                If box_crs is specified: coordinates in the given CRS (e.g., &quot;EPSG:4326&quot;).</span>
<span class="sd">            box_crs (str, optional): Coordinate reference system for box coordinates</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot; for lat/lon). Only used if the source image is a GeoTIFF.</span>
<span class="sd">                If None, boxes are assumed to be in pixel coordinates.</span>
<span class="sd">            output (str, optional): Path to save the output mask as a GeoTIFF.</span>
<span class="sd">                If None, masks are stored in memory only.</span>
<span class="sd">            multimask_output (bool): If True, the model returns 3 masks per box and the</span>
<span class="sd">                best one is selected by score. If False, returns single mask directly.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">            dtype (str): Data type for the output mask array. Defaults to &quot;uint8&quot;.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to predict_inst() or save_masks().</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary containing masks, scores, and logits.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Initialize with instance interactivity enabled</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image(&quot;satellite.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Single box (pixel coordinates)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_boxes_inst([[425, 600, 700, 875]])</span>
<span class="sd">            &gt;&gt;&gt; sam.show_anns()</span>
<span class="sd">            &gt;&gt;&gt; sam.save_masks(&quot;mask.png&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Multiple boxes with geographic coordinates</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_boxes_inst([</span>
<span class="sd">            ...     [-117.5995, 47.6518, -117.5988, 47.652],</span>
<span class="sd">            ...     [-117.5987, 47.6518, -117.5979, 47.652],</span>
<span class="sd">            ... ], box_crs=&quot;EPSG:4326&quot;, output=&quot;mask.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Using a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_boxes_inst(</span>
<span class="sd">            ...     &quot;building_bboxes.geojson&quot;,</span>
<span class="sd">            ...     box_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">            ...     output=&quot;building_masks.tif&quot;,</span>
<span class="sd">            ...     dtype=&quot;uint16&quot;,</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Using a GeoDataFrame</span>
<span class="sd">            &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">            &gt;&gt;&gt; gdf = gpd.read_file(&quot;polygons.geojson&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_boxes_inst(</span>
<span class="sd">            ...     gdf,</span>
<span class="sd">            ...     box_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">            ...     output=&quot;masks.tif&quot;,</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;generate_masks_by_boxes_inst is only available for the Meta backend. &quot;</span>
                <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
                <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process boxes based on input type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># GeoJSON-like dict</span>
            <span class="n">boxes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)):</span>
            <span class="c1"># File path or GeoDataFrame</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">boxes</span>

            <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">box_crs</span>
            <span class="k">elif</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">box_crs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

            <span class="c1"># Extract bounding boxes from geometries</span>
            <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">bounds</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">boxes</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;boxes must be a list, GeoDataFrame, file path, or numpy array.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Filter boxes that are out of image bounds if box_crs is provided</span>
        <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform_bounds</span>

            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">img_bounds</span> <span class="o">=</span> <span class="n">transform_bounds</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

            <span class="n">xmin_img</span><span class="p">,</span> <span class="n">ymin_img</span><span class="p">,</span> <span class="n">xmax_img</span><span class="p">,</span> <span class="n">ymax_img</span> <span class="o">=</span> <span class="n">img_bounds</span>

            <span class="n">valid_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filtered_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes_list</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
                <span class="c1"># Check if box overlaps with image bounds</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin_img</span>
                    <span class="ow">and</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">xmax_img</span>
                    <span class="ow">and</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">ymin_img</span>
                    <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="n">ymax_img</span>
                <span class="p">):</span>
                    <span class="n">valid_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filtered_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">filtered_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Filtered </span><span class="si">{</span><span class="n">filtered_count</span><span class="si">}</span><span class="s2"> boxes outside image bounds. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_boxes</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid boxes.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid boxes found within image bounds.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">return</span>

            <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">valid_boxes</span>

        <span class="c1"># Convert to numpy array</span>
        <span class="n">boxes_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes_list</span><span class="p">)</span>

        <span class="c1"># Call predict_inst with box prompts</span>
        <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_inst</span><span class="p">(</span>
            <span class="n">box</span><span class="o">=</span><span class="n">boxes_arr</span><span class="p">,</span>
            <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
            <span class="n">box_crs</span><span class="o">=</span><span class="n">box_crs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Handle batch output shape (BxCxHxW) vs single (CxHxW)</span>
        <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Multiple boxes - flatten into list of masks</span>
            <span class="c1"># Each box produces C masks, take the best one per box</span>
            <span class="n">all_masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">all_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
                    <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">all_masks</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">all_scores</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single box</span>
            <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]]</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">scores</span><span class="p">]</span>

        <span class="c1"># Store results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

        <span class="c1"># Compute bounding boxes from masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">mask_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
        <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your box prompts.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

        <span class="c1"># Save masks if output path is provided</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span>
                <span class="n">output</span><span class="p">,</span>
                <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_results_to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert masks, boxes, and scores from tensors to numpy arrays.</span>

<span class="sd">        This frees GPU memory by moving data to CPU and converting to numpy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Convert masks to numpy</span>
        <span class="n">converted_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="c1"># PyTorch tensor on GPU</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="c1"># PyTorch tensor on CPU</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Already numpy or other array-like</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">converted_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_np</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">converted_masks</span>

        <span class="c1"># Convert boxes to numpy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">converted_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                    <span class="n">box_np</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                    <span class="n">box_np</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">box_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">converted_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_np</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">converted_boxes</span>

        <span class="c1"># Convert scores to numpy/float</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">converted_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                    <span class="n">score_val</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">score</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="k">else</span> <span class="n">score</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
                    <span class="n">score_val</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                    <span class="n">score_val</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">converted_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">converted_scores</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_masks_by_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter masks by size.</span>

<span class="sd">        Args:</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">filtered_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">):</span>
            <span class="c1"># Convert mask to numpy array if it&#39;s a tensor</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>

            <span class="c1"># Ensure mask is 2D</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert to boolean and calculate mask size</span>
            <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

            <span class="c1"># Filter by size</span>
            <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Keep this mask</span>
            <span class="n">filtered_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">filtered_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">filtered_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Update the stored masks, boxes, and scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">filtered_masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">filtered_boxes</span> <span class="k">if</span> <span class="n">filtered_boxes</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">filtered_scores</span> <span class="k">if</span> <span class="n">filtered_scores</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_boxes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">boxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">box_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">positive_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">negative_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize bounding boxes on the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            boxes (List[List[float]]): List of bounding boxes in XYXY format</span>
<span class="sd">                [[xmin, ymin, xmax, ymax], ...].</span>
<span class="sd">                If box_crs is None: pixel coordinates.</span>
<span class="sd">                If box_crs is specified: coordinates in the given CRS.</span>
<span class="sd">            box_labels (List[bool], optional): List of boolean labels for each box.</span>
<span class="sd">                True (positive) shown in green, False (negative) shown in red.</span>
<span class="sd">                If None, all boxes shown in green.</span>
<span class="sd">            box_crs (str, optional): Coordinate reference system for box coordinates</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot;). If None, boxes are in pixel coordinates.</span>
<span class="sd">            figsize (Tuple[int, int]): Figure size for display.</span>
<span class="sd">            axis (str): Whether to show axis (&quot;on&quot; or &quot;off&quot;).</span>
<span class="sd">            positive_color (Tuple[int, int, int]): RGB color for positive boxes.</span>
<span class="sd">            negative_color (Tuple[int, int, int]): RGB color for negative boxes.</span>
<span class="sd">            thickness (int): Line thickness for box borders.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">box_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

        <span class="c1"># Transform boxes from CRS to pixel coordinates if needed</span>
        <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pixel_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>

                <span class="c1"># Transform min corner</span>
                <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
                <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># Transform max corner</span>
                <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
                <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="c1"># Convert to pixel coordinates and ensure correct min/max order</span>
                <span class="c1"># (geographic y increases north, pixel y increases down)</span>
                <span class="n">x1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Ensure we have correct min/max values</span>
                <span class="n">x_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
                <span class="n">y_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>
                <span class="n">x_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
                <span class="n">y_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>

                <span class="n">pixel_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_min_px</span><span class="p">,</span> <span class="n">y_min_px</span><span class="p">,</span> <span class="n">x_max_px</span><span class="p">,</span> <span class="n">y_max_px</span><span class="p">])</span>

            <span class="n">boxes</span> <span class="o">=</span> <span class="n">pixel_boxes</span>

        <span class="c1"># Convert image to PIL if needed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>

        <span class="c1"># Draw each box</span>
        <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_labels</span><span class="p">):</span>
            <span class="c1"># Convert XYXY to XYWH for drawing</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
            <span class="n">box_xywh</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">]</span>

            <span class="c1"># Choose color based on label</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">positive_color</span> <span class="k">if</span> <span class="n">label</span> <span class="k">else</span> <span class="n">negative_color</span>

            <span class="c1"># Draw box</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">draw_box_on_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">box_xywh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">thickness</span><span class="p">)</span>

        <span class="c1"># Display</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_points</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">point_coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">foreground_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="n">background_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">marker_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">375</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize point prompts on the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            point_coords (List[List[float]]): List of point coordinates [[x, y], ...].</span>
<span class="sd">                If point_crs is None: pixel coordinates.</span>
<span class="sd">                If point_crs is specified: coordinates in the given CRS.</span>
<span class="sd">            point_labels (List[int], optional): List of labels for each point.</span>
<span class="sd">                1 = foreground (shown in green), 0 = background (shown in red).</span>
<span class="sd">                If None, all points shown as foreground.</span>
<span class="sd">            point_crs (str, optional): Coordinate reference system for point coordinates</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot;). If None, points are in pixel coordinates.</span>
<span class="sd">            figsize (Tuple[int, int]): Figure size for display.</span>
<span class="sd">            axis (str): Whether to show axis (&quot;on&quot; or &quot;off&quot;).</span>
<span class="sd">            foreground_color (str): Color for foreground points (label=1).</span>
<span class="sd">            background_color (str): Color for background points (label=0).</span>
<span class="sd">            marker (str): Marker style for points.</span>
<span class="sd">            marker_size (int): Size of the markers.</span>

<span class="sd">        Example:</span>
<span class="sd">            sam.show_points([[520, 375]], [1])  # Single foreground point</span>
<span class="sd">            sam.show_points([[500, 375], [600, 400]], [1, 0])  # Mixed points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">point_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>

        <span class="c1"># Convert to numpy arrays</span>
        <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span>

        <span class="c1"># Transform points from CRS to pixel coordinates if needed</span>
        <span class="k">if</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">point_coords</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">point_coords</span><span class="p">,</span> <span class="n">point_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># Display image</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Plot foreground points</span>
        <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">point_labels</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">point_coords</span><span class="p">[</span><span class="n">fg_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">point_coords</span><span class="p">[</span><span class="n">fg_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">foreground_color</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Plot background points</span>
        <span class="n">bg_mask</span> <span class="o">=</span> <span class="n">point_labels</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bg_mask</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">point_coords</span><span class="p">[</span><span class="n">bg_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">point_coords</span><span class="p">[</span><span class="n">bg_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">background_color</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
        <span class="n">save_scores</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the generated masks to a file or generate mask array for visualization.</span>

<span class="sd">        If the input image is a GeoTIFF, the output will be saved as a GeoTIFF</span>
<span class="sd">        with the same georeferencing information. Otherwise, it will be saved as PNG.</span>

<span class="sd">        Args:</span>
<span class="sd">            output (str, optional): The path to the output file. If None, only generates</span>
<span class="sd">                the mask array in memory (self.objects) without saving to disk.</span>
<span class="sd">            unique (bool): If True, each mask gets a unique value (1, 2, 3, ...).</span>
<span class="sd">                If False, all masks are combined into a binary mask (0 or 255).</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">                this will be filtered out.</span>
<span class="sd">            dtype (str): Data type for the output array.</span>
<span class="sd">            save_scores (str, optional): If provided, saves a confidence score map</span>
<span class="sd">                to this path. Each pixel will have the confidence score of its mask.</span>
<span class="sd">                The output format (GeoTIFF or PNG) follows the same logic as the mask output.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to common.array_to_image().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks found. Please run generate_masks() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No scores found. Cannot save scores.&quot;</span><span class="p">)</span>

        <span class="c1"># Create empty array for combined masks</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create empty array for scores if requested</span>
        <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scores_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
            <span class="p">)</span>

        <span class="c1"># Process each mask</span>
        <span class="n">valid_mask_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="c1"># Convert mask to numpy array if it&#39;s a tensor</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>

            <span class="c1"># Ensure mask is 2D</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert to boolean</span>
            <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="c1"># Calculate mask size</span>
            <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

            <span class="c1"># Filter by size</span>
            <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                <span class="n">mask_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                <span class="n">mask_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Get confidence score for this mask</span>
            <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_index</span><span class="p">],</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_index</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_index</span><span class="p">])</span>

            <span class="c1"># Add mask to array</span>
            <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
                <span class="c1"># Assign unique value to each mask (starting from 1)</span>
                <span class="n">mask_value</span> <span class="o">=</span> <span class="n">valid_mask_count</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Binary mask: all foreground pixels are 255</span>
                <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

            <span class="c1"># Add score to scores array</span>
            <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scores_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

            <span class="n">valid_mask_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">mask_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">valid_mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No masks met the size criteria.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Convert to requested dtype</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unique</span> <span class="ow">and</span> <span class="n">valid_mask_count</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> masks found, but uint8 can only represent 255 unique values. Consider using dtype=&#39;uint16&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int32&quot;</span><span class="p">:</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Store the mask array for visualization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">mask_array</span>

        <span class="c1"># Only save to file if output path is provided</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Save using common utility which handles GeoTIFF georeferencing</span>
            <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span>
                <span class="n">mask_array</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> mask(s) to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Save scores if requested</span>
            <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span>
                    <span class="n">scores_array</span><span class="p">,</span> <span class="n">save_scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved confidence scores to </span><span class="si">{</span><span class="n">save_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_prediction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the predicted mask to the output path.</span>

<span class="sd">        Args:</span>
<span class="sd">            output (str): The path to the output image.</span>
<span class="sd">            index (Optional[int]): The index of the mask to save.</span>
<span class="sd">            mask_multiplier (int): The mask multiplier for the output mask.</span>
<span class="sd">            dtype (str): The data type of the output image.</span>
<span class="sd">            vector (Optional[str]): The path to the output vector file.</span>
<span class="sd">            simplify_tolerance (Optional[float]): The maximum allowed geometry displacement.</span>
<span class="sd">            **kwargs (Any): Additional keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No predictions found. Please run predict() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">=</span> <span class="n">array</span>
        <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">common</span><span class="o">.</span><span class="n">raster_to_vector</span><span class="p">(</span>
                <span class="n">output</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the binary mask or the mask of objects with unique values.</span>

<span class="sd">        Args:</span>
<span class="sd">            figsize (tuple): The figure size.</span>
<span class="sd">            cmap (str): The colormap. Default is &quot;tab20&quot; for showing unique objects.</span>
<span class="sd">                Use &quot;binary_r&quot; for binary masks when unique=False.</span>
<span class="sd">                Other good options: &quot;viridis&quot;, &quot;nipy_spectral&quot;, &quot;rainbow&quot;.</span>
<span class="sd">            axis (str): Whether to show the axis.</span>
<span class="sd">            unique (bool): If True, each mask gets a unique color value. If False, binary mask.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to save_masks() for filtering</span>
<span class="sd">                (e.g., min_size, max_size, dtype).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Always regenerate mask array to ensure it matches the unique parameter</span>
        <span class="c1"># This prevents showing stale cached binary masks when unique=True is requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># save_masks would have printed a message if no masks met criteria</span>
            <span class="k">return</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_anns</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">show_bbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">blend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">font_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the annotations (objects with random color) on the input image.</span>

<span class="sd">        This method uses OpenCV for fast rendering, which is significantly faster</span>
<span class="sd">        than matplotlib when there are many objects to plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            figsize (tuple): The figure size (used for display).</span>
<span class="sd">            axis (str): Whether to show the axis.</span>
<span class="sd">            show_bbox (bool): Whether to show the bounding box.</span>
<span class="sd">            show_score (bool): Whether to show the score.</span>
<span class="sd">            output (str, optional): The path to the output image. If provided, the</span>
<span class="sd">                figure will be saved instead of displayed.</span>
<span class="sd">            blend (bool): Whether to show the input image as background. If False,</span>
<span class="sd">                only annotations will be shown on a white background.</span>
<span class="sd">            alpha (float): The alpha value for the annotations.</span>
<span class="sd">            font_scale (float): The font scale for labels. Defaults to 0.8.</span>
<span class="sd">            **kwargs: Additional keyword arguments (kept for backward compatibility).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please run set_image() first.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create the blended image using OpenCV (much faster than matplotlib)</span>
        <span class="n">blended</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_anns_opencv</span><span class="p">(</span>
            <span class="n">show_bbox</span><span class="o">=</span><span class="n">show_bbox</span><span class="p">,</span>
            <span class="n">show_score</span><span class="o">=</span><span class="n">show_score</span><span class="p">,</span>
            <span class="n">blend</span><span class="o">=</span><span class="n">blend</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Save directly using OpenCV</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved annotations to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Display the image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_image</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_anns_opencv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">show_bbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">blend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">font_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render annotations using OpenCV for fast performance.</span>

<span class="sd">        Args:</span>
<span class="sd">            show_bbox (bool): Whether to show the bounding box.</span>
<span class="sd">            show_score (bool): Whether to show the score.</span>
<span class="sd">            blend (bool): Whether to show the input image as background.</span>
<span class="sd">            alpha (float): The alpha value for the annotations.</span>
<span class="sd">            font_scale (float): The font scale for labels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The rendered image as RGB numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get image dimensions</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Create base image</span>
        <span class="k">if</span> <span class="n">blend</span><span class="p">:</span>
            <span class="n">frame_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

        <span class="n">nb_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">)</span>

        <span class="c1"># Use the same color generation as the original method for consistency</span>
        <span class="n">COLORS</span> <span class="o">=</span> <span class="n">generate_colors</span><span class="p">(</span><span class="n">n_colors</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
        <span class="c1"># Convert from 0-1 float RGB to 0-255 int RGB for OpenCV</span>
        <span class="n">colors_rgb</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLORS</span>
        <span class="p">]</span>

        <span class="c1"># Create overlay for all masks</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">mask_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">labels_to_draw</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_objects</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors_rgb</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors_rgb</span><span class="p">)]</span>

            <span class="c1"># Handle both tensor and numpy array formats</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

            <span class="c1"># Ensure mask is 2D</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                    <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Add color to overlay where mask is present</span>
            <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">,</span> <span class="n">color</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">])</span>
            <span class="n">mask_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mask_combined</span><span class="p">,</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

            <span class="c1"># Collect label info for bounding boxes</span>
            <span class="k">if</span> <span class="n">show_bbox</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Handle score extraction</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prob</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_score</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(id=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">prob</span><span class="si">=:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(id=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span>

                <span class="c1"># Handle box extraction</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

                <span class="n">labels_to_draw</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>

        <span class="c1"># Blend overlay with frame</span>
        <span class="n">mask_3d</span> <span class="o">=</span> <span class="n">mask_combined</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">blended</span> <span class="o">=</span> <span class="n">frame_np</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mask_3d</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">overlay</span> <span class="o">*</span> <span class="p">(</span><span class="n">mask_3d</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">blended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Draw bounding boxes and labels using OpenCV</span>
        <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">labels_to_draw</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span> <span class="n">box</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="c1"># Clip bounding box coordinates to image boundaries</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

            <span class="c1"># Draw bounding box</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Get text size for background rectangle</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">font_scale</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">))</span>
            <span class="p">(</span><span class="n">text_w</span><span class="p">,</span> <span class="n">text_h</span><span class="p">),</span> <span class="n">baseline</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_scale</span><span class="p">,</span> <span class="n">thickness</span>
            <span class="p">)</span>

            <span class="c1"># Draw background rectangle for text</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">text_x</span> <span class="o">=</span> <span class="n">x1</span>
            <span class="n">text_y</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">text_y</span> <span class="o">-</span> <span class="n">text_h</span> <span class="o">-</span> <span class="n">pad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">text_y</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">+</span> <span class="n">text_h</span> <span class="o">+</span> <span class="mi">5</span>

            <span class="c1"># Semi-transparent background for text</span>
            <span class="n">bg_x1</span> <span class="o">=</span> <span class="n">text_x</span> <span class="o">-</span> <span class="n">pad</span>
            <span class="n">bg_y1</span> <span class="o">=</span> <span class="n">text_y</span> <span class="o">-</span> <span class="n">text_h</span> <span class="o">-</span> <span class="n">pad</span>
            <span class="n">bg_x2</span> <span class="o">=</span> <span class="n">text_x</span> <span class="o">+</span> <span class="n">text_w</span> <span class="o">+</span> <span class="n">pad</span>
            <span class="n">bg_y2</span> <span class="o">=</span> <span class="n">text_y</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">baseline</span>

            <span class="c1"># Clip to image boundaries</span>
            <span class="n">bg_x1</span><span class="p">,</span> <span class="n">bg_y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bg_x1</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bg_y1</span><span class="p">)</span>
            <span class="n">bg_x2</span><span class="p">,</span> <span class="n">bg_y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">bg_x2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">bg_y2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">bg_x2</span> <span class="o">&gt;</span> <span class="n">bg_x1</span> <span class="ow">and</span> <span class="n">bg_y2</span> <span class="o">&gt;</span> <span class="n">bg_y1</span><span class="p">:</span>
                <span class="n">sub_img</span> <span class="o">=</span> <span class="n">blended</span><span class="p">[</span><span class="n">bg_y1</span><span class="p">:</span><span class="n">bg_y2</span><span class="p">,</span> <span class="n">bg_x1</span><span class="p">:</span><span class="n">bg_x2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">bg_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">blend_rect</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_img</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="n">bg_color</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">blended</span><span class="p">[</span><span class="n">bg_y1</span><span class="p">:</span><span class="n">bg_y2</span><span class="p">,</span> <span class="n">bg_x1</span><span class="p">:</span><span class="n">bg_x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">blend_rect</span>

            <span class="c1"># Draw text</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span>
                <span class="n">blended</span><span class="p">,</span>
                <span class="n">text</span><span class="p">,</span>
                <span class="p">(</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">),</span>
                <span class="n">font</span><span class="p">,</span>
                <span class="n">font_scale</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                <span class="n">thickness</span><span class="p">,</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">blended</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_display_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display an image, using IPython display if available for better performance.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.ndarray): The image to display (RGB format).</span>
<span class="sd">            figsize (tuple): The figure size.</span>
<span class="sd">            axis (str): Whether to show the axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to use IPython display for better notebook performance</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

            <span class="c1"># Save to temporary file and display</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">make_temp_dir</span><span class="p">()</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;temp_anns.png&quot;</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>

            <span class="c1"># Display using PIL Image (works well in notebooks)</span>
            <span class="n">img_display</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

            <span class="c1"># Resize for display based on figsize (assuming 100 DPI)</span>
            <span class="n">display_width</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">display_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">display_width</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>
            <span class="n">img_display</span> <span class="o">=</span> <span class="n">img_display</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                <span class="p">(</span><span class="n">display_width</span><span class="p">,</span> <span class="n">display_height</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">LANCZOS</span>
            <span class="p">)</span>

            <span class="n">display</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># Fall back to matplotlib for non-notebook environments</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">raster_to_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">vector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a raster image file to a vector dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            raster (str): The path to the raster image.</span>
<span class="sd">            vector (str): The path to the output vector file.</span>
<span class="sd">            simplify_tolerance (float, optional): The maximum allowed geometry displacement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">common</span><span class="o">.</span><span class="n">raster_to_vector</span><span class="p">(</span>
            <span class="n">raster</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">basemap</span><span class="o">=</span><span class="s2">&quot;Esri.WorldImagery&quot;</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the interactive map.</span>

<span class="sd">        Args:</span>
<span class="sd">            basemap (str, optional): The basemap. Valid options include &quot;Esri.WorldImagery&quot;, &quot;OpenStreetMap&quot;, &quot;HYBRID&quot;, &quot;ROADMAP&quot;, &quot;TERRAIN&quot;, etc. See the leafmap documentation for a full list of supported basemaps.</span>
<span class="sd">            out_dir (str, optional): The path to the output directory. Defaults to None.</span>
<span class="sd">            min_size (int, optional): The minimum size of the object. Defaults to 10.</span>
<span class="sd">            max_size (int, optional): The maximum size of the object. Defaults to None.</span>
<span class="sd">            prompt (str, optional): The prompt type. Defaults to &quot;text&quot;.</span>
<span class="sd">                Valid options include &quot;text&quot; and &quot;point&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            leafmap.Map: The map object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">text_sam_gui</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">basemap</span><span class="o">=</span><span class="n">basemap</span><span class="p">,</span>
                <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
                <span class="n">box_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">,</span>
                <span class="n">text_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">,</span>
                <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">sam_map_gui</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">basemap</span><span class="o">=</span><span class="n">basemap</span><span class="p">,</span>
                <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
                <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid prompt: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">. Please use &#39;text&#39; or &#39;point&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_canvas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fg_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">bg_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show a canvas to collect foreground and background points.</span>

<span class="sd">        Args:</span>
<span class="sd">            fg_color (Tuple[int, int, int]): The color for foreground points.</span>
<span class="sd">            bg_color (Tuple[int, int, int]): The color for background points.</span>
<span class="sd">            radius (int): The radius of the points.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of foreground and background points.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please run set_image() first.&quot;</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
        <span class="n">fg_points</span><span class="p">,</span> <span class="n">bg_points</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">show_canvas</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fg_points</span> <span class="o">=</span> <span class="n">fg_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bg_points</span> <span class="o">=</span> <span class="n">bg_points</span>
        <span class="n">point_coords</span> <span class="o">=</span> <span class="n">fg_points</span> <span class="o">+</span> <span class="n">bg_points</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fg_points</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_coords</span> <span class="o">=</span> <span class="n">point_coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_labels</span> <span class="o">=</span> <span class="n">point_labels</span>

        <span class="k">return</span> <span class="n">fg_points</span><span class="p">,</span> <span class="n">bg_points</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_inst</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">point_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">return_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">normalize_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict masks for the given input prompts using SAM3&#39;s interactive instance</span>
<span class="sd">        segmentation (SAM1-style task). This enables point and box prompts for</span>
<span class="sd">        precise object segmentation.</span>

<span class="sd">        Note: This method requires the model to be initialized with</span>
<span class="sd">        `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">        Args:</span>
<span class="sd">            point_coords (np.ndarray or List, optional): A Nx2 array or list of point</span>
<span class="sd">                prompts to the model. Each point is in (X, Y) pixel coordinates.</span>
<span class="sd">                Can be a numpy array or a Python list like [[x1, y1], [x2, y2]].</span>
<span class="sd">            point_labels (np.ndarray or List, optional): A length N array or list of</span>
<span class="sd">                labels for the point prompts. 1 indicates a foreground point and</span>
<span class="sd">                0 indicates a background point.</span>
<span class="sd">            box (np.ndarray or List, optional): A length 4 array/list or Bx4 array/list</span>
<span class="sd">                of box prompt(s) to the model, in XYXY format.</span>
<span class="sd">            mask_input (np.ndarray, optional): A low resolution mask input to the</span>
<span class="sd">                model, typically coming from a previous prediction iteration.</span>
<span class="sd">                Has form 1xHxW (or BxHxW for batched), where H=W=256 for SAM.</span>
<span class="sd">            multimask_output (bool): If True, the model will return three masks.</span>
<span class="sd">                For ambiguous input prompts (such as a single click), this will</span>
<span class="sd">                often produce better masks than a single prediction. If only a</span>
<span class="sd">                single mask is needed, the model&#39;s predicted quality score can</span>
<span class="sd">                be used to select the best mask. For non-ambiguous prompts, such</span>
<span class="sd">                as multiple input prompts, multimask_output=False can give</span>
<span class="sd">                better results. Defaults to True.</span>
<span class="sd">            return_logits (bool): If True, returns un-thresholded mask logits</span>
<span class="sd">                instead of binary masks. Defaults to False.</span>
<span class="sd">            normalize_coords (bool): If True, the point coordinates will be</span>
<span class="sd">                normalized to the range [0, 1] and point_coords is expected to</span>
<span class="sd">                be w.r.t. image dimensions. Defaults to True.</span>
<span class="sd">            point_crs (str, optional): Coordinate reference system for point</span>
<span class="sd">                coordinates (e.g., &quot;EPSG:4326&quot;). Only used if the source image</span>
<span class="sd">                is a GeoTIFF. If None, points are in pixel coordinates.</span>
<span class="sd">            box_crs (str, optional): Coordinate reference system for box</span>
<span class="sd">                coordinates (e.g., &quot;EPSG:4326&quot;). Only used if the source image</span>
<span class="sd">                is a GeoTIFF. If None, box is in pixel coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
<span class="sd">                - masks: The output masks in CxHxW format (or BxCxHxW for batched</span>
<span class="sd">                  box input), where C is the number of masks, and (H, W) is the</span>
<span class="sd">                  original image size.</span>
<span class="sd">                - scores: An array of length C (or BxC) containing the model&#39;s</span>
<span class="sd">                  predictions for the quality of each mask.</span>
<span class="sd">                - logits: An array of shape CxHxW (or BxCxHxW), where C is the</span>
<span class="sd">                  number of masks and H=W=256. These low resolution logits can</span>
<span class="sd">                  be passed to a subsequent iteration as mask input.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Initialize with instance interactivity enabled</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Single point prompt</span>
<span class="sd">            &gt;&gt;&gt; point_coords = np.array([[520, 375]])</span>
<span class="sd">            &gt;&gt;&gt; point_labels = np.array([1])</span>
<span class="sd">            &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">            ...     point_coords=point_coords,</span>
<span class="sd">            ...     point_labels=point_labels,</span>
<span class="sd">            ...     multimask_output=True,</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Select best mask based on score</span>
<span class="sd">            &gt;&gt;&gt; best_mask_idx = np.argmax(scores)</span>
<span class="sd">            &gt;&gt;&gt; best_mask = masks[best_mask_idx]</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Refine with additional points</span>
<span class="sd">            &gt;&gt;&gt; point_coords = np.array([[500, 375], [1125, 625]])</span>
<span class="sd">            &gt;&gt;&gt; point_labels = np.array([1, 0])  # foreground and background</span>
<span class="sd">            &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">            ...     point_coords=point_coords,</span>
<span class="sd">            ...     point_labels=point_labels,</span>
<span class="sd">            ...     mask_input=logits[best_mask_idx:best_mask_idx+1],  # Use previous best</span>
<span class="sd">            ...     multimask_output=False,</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Box prompt</span>
<span class="sd">            &gt;&gt;&gt; box = np.array([425, 600, 700, 875])</span>
<span class="sd">            &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(box=box, multimask_output=False)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Combined box and point prompt</span>
<span class="sd">            &gt;&gt;&gt; box = np.array([425, 600, 700, 875])</span>
<span class="sd">            &gt;&gt;&gt; point_coords = np.array([[575, 750]])</span>
<span class="sd">            &gt;&gt;&gt; point_labels = np.array([0])  # Exclude this region</span>
<span class="sd">            &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">            ...     point_coords=point_coords,</span>
<span class="sd">            ...     point_labels=point_labels,</span>
<span class="sd">            ...     box=box,</span>
<span class="sd">            ...     multimask_output=False,</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;predict_inst is only available for the Meta backend. &quot;</span>
                <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
                <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Convert lists to numpy arrays</span>
        <span class="k">if</span> <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

        <span class="c1"># Transform point coordinates from CRS to pixel coordinates if needed</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
            <span class="n">point_coords</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">point_coords</span><span class="p">,</span> <span class="n">point_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># Transform box coordinates from CRS to pixel coordinates if needed</span>
        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Single box [xmin, ymin, xmax, ymax]</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
                <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
                <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
                <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">x1_px</span><span class="p">,</span> <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x2_px</span><span class="p">,</span> <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                        <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                        <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Multiple boxes [B, 4]</span>
                <span class="n">transformed_boxes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
                    <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
                    <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
                    <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">x1_px</span><span class="p">,</span> <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">x2_px</span><span class="p">,</span> <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">transformed_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transformed_boxes</span><span class="p">)</span>

        <span class="c1"># Call the model&#39;s predict_inst method</span>
        <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_inst</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">,</span>
            <span class="n">point_coords</span><span class="o">=</span><span class="n">point_coords</span><span class="p">,</span>
            <span class="n">point_labels</span><span class="o">=</span><span class="n">point_labels</span><span class="p">,</span>
            <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span>
            <span class="n">mask_input</span><span class="o">=</span><span class="n">mask_input</span><span class="p">,</span>
            <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
            <span class="n">return_logits</span><span class="o">=</span><span class="n">return_logits</span><span class="p">,</span>
            <span class="n">normalize_coords</span><span class="o">=</span><span class="n">normalize_coords</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Store results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">scores</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

        <span class="k">return</span> <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_inst_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">point_coords_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_labels_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_input_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">return_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">normalize_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict masks for batched input prompts using SAM3&#39;s interactive instance</span>
<span class="sd">        segmentation. This is used when the model is set with multiple images via</span>
<span class="sd">        `set_image_batch()`.</span>

<span class="sd">        Note: This method requires the model to be initialized with</span>
<span class="sd">        `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">        Args:</span>
<span class="sd">            point_coords_batch (List[np.ndarray], optional): List of Nx2 arrays of</span>
<span class="sd">                point prompts for each image in the batch. Each point is in (X, Y)</span>
<span class="sd">                pixel coordinates.</span>
<span class="sd">            point_labels_batch (List[np.ndarray], optional): List of length N arrays</span>
<span class="sd">                of labels for the point prompts for each image. 1 indicates a</span>
<span class="sd">                foreground point and 0 indicates a background point.</span>
<span class="sd">            box_batch (List[np.ndarray], optional): List of Bx4 arrays of box</span>
<span class="sd">                prompts for each image in the batch, in XYXY format.</span>
<span class="sd">            mask_input_batch (List[np.ndarray], optional): List of low resolution</span>
<span class="sd">                mask inputs for each image, typically from previous iterations.</span>
<span class="sd">            multimask_output (bool): If True, the model will return three masks</span>
<span class="sd">                per prompt. Defaults to True.</span>
<span class="sd">            return_logits (bool): If True, returns un-thresholded mask logits</span>
<span class="sd">                instead of binary masks. Defaults to False.</span>
<span class="sd">            normalize_coords (bool): If True, coordinates are normalized to [0, 1].</span>
<span class="sd">                Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[np.ndarray], List[np.ndarray], List[np.ndarray]]:</span>
<span class="sd">                - masks_batch: List of mask arrays for each image</span>
<span class="sd">                - scores_batch: List of score arrays for each image</span>
<span class="sd">                - logits_batch: List of logit arrays for each image</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Load batch of images</span>
<span class="sd">            &gt;&gt;&gt; image1 = Image.open(&quot;truck.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt; image2 = Image.open(&quot;groceries.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image_batch([image1, image2])</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Define box prompts for each image</span>
<span class="sd">            &gt;&gt;&gt; image1_boxes = np.array([</span>
<span class="sd">            ...     [75, 275, 1725, 850],</span>
<span class="sd">            ...     [425, 600, 700, 875],</span>
<span class="sd">            ... ])</span>
<span class="sd">            &gt;&gt;&gt; image2_boxes = np.array([</span>
<span class="sd">            ...     [450, 170, 520, 350],</span>
<span class="sd">            ...     [350, 190, 450, 350],</span>
<span class="sd">            ... ])</span>
<span class="sd">            &gt;&gt;&gt; boxes_batch = [image1_boxes, image2_boxes]</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Predict masks for all images</span>
<span class="sd">            &gt;&gt;&gt; masks_batch, scores_batch, logits_batch = sam.predict_inst_batch(</span>
<span class="sd">            ...     box_batch=boxes_batch,</span>
<span class="sd">            ...     multimask_output=False,</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Or use point prompts</span>
<span class="sd">            &gt;&gt;&gt; image1_pts = np.array([[[500, 375]], [[650, 750]]])  # Bx1x2</span>
<span class="sd">            &gt;&gt;&gt; image1_labels = np.array([[1], [1]])</span>
<span class="sd">            &gt;&gt;&gt; image2_pts = np.array([[[400, 300]], [[630, 300]]])</span>
<span class="sd">            &gt;&gt;&gt; image2_labels = np.array([[1], [1]])</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; masks_batch, scores_batch, logits_batch = sam.predict_inst_batch(</span>
<span class="sd">            ...     point_coords_batch=[image1_pts, image2_pts],</span>
<span class="sd">            ...     point_labels_batch=[image1_labels, image2_labels],</span>
<span class="sd">            ...     multimask_output=True,</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;predict_inst_batch is only available for the Meta backend. &quot;</span>
                <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No images set for batch processing. &quot;</span>
                <span class="s2">&quot;Please call set_image_batch() first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
                <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Call the model&#39;s predict_inst_batch method</span>
        <span class="n">masks_batch</span><span class="p">,</span> <span class="n">scores_batch</span><span class="p">,</span> <span class="n">logits_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_inst_batch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">,</span>
            <span class="n">point_coords_batch</span><span class="p">,</span>
            <span class="n">point_labels_batch</span><span class="p">,</span>
            <span class="n">box_batch</span><span class="o">=</span><span class="n">box_batch</span><span class="p">,</span>
            <span class="n">mask_input_batch</span><span class="o">=</span><span class="n">mask_input_batch</span><span class="p">,</span>
            <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
            <span class="n">return_logits</span><span class="o">=</span><span class="n">return_logits</span><span class="p">,</span>
            <span class="n">normalize_coords</span><span class="o">=</span><span class="n">normalize_coords</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">masks_batch</span><span class="p">,</span> <span class="n">scores_batch</span><span class="p">,</span> <span class="n">logits_batch</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_points_patch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">point_coords_batch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_labels_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">return_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate masks for multiple point prompts using batch processing.</span>

<span class="sd">        This method is similar to SamGeo2.predict_by_points but uses SAM3&#39;s</span>
<span class="sd">        predict_inst_batch for efficient batch processing of point prompts on</span>
<span class="sd">        a single image. Each point is treated as a separate prompt to generate</span>
<span class="sd">        a separate mask.</span>

<span class="sd">        Note: This method requires the model to be initialized with</span>
<span class="sd">        `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">        Args:</span>
<span class="sd">            point_coords_batch (List[List[float]] | str | GeoDataFrame): Point</span>
<span class="sd">                coordinates for batch processing. Can be:</span>
<span class="sd">                - A list of [x, y] coordinates</span>
<span class="sd">                - A file path to a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">                - A GeoDataFrame with point geometries</span>
<span class="sd">            point_labels_batch (List[int], optional): Labels for each point.</span>
<span class="sd">                1 = foreground (include), 0 = background (exclude).</span>
<span class="sd">                If None, all points are treated as foreground (label=1).</span>
<span class="sd">            point_crs (str, optional): Coordinate reference system for point</span>
<span class="sd">                coordinates (e.g., &quot;EPSG:4326&quot;). If provided, coordinates will</span>
<span class="sd">                be converted from the CRS to pixel coordinates. Required when</span>
<span class="sd">                using geographic coordinates with a GeoTIFF source image.</span>
<span class="sd">            output (str, optional): Path to save the output mask as a GeoTIFF.</span>
<span class="sd">                If None, masks are stored in memory only.</span>
<span class="sd">            index (int, optional): If multimask_output is True, select this</span>
<span class="sd">                specific mask index from each prediction. If None, selects the</span>
<span class="sd">                mask with the highest score for each point.</span>
<span class="sd">            unique (bool): If True, each mask gets a unique integer value</span>
<span class="sd">                (1, 2, 3, ...). If False, all masks are combined into a binary</span>
<span class="sd">                mask. Defaults to True.</span>
<span class="sd">            min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">                will be filtered out. Defaults to 0.</span>
<span class="sd">            max_size (int, optional): Maximum mask size in pixels. Masks larger</span>
<span class="sd">                than this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">            dtype (str): Data type for the output mask array. Defaults to &quot;int32&quot;.</span>
<span class="sd">            multimask_output (bool): If True, the model returns 3 masks per prompt.</span>
<span class="sd">                Defaults to False for cleaner batch results.</span>
<span class="sd">            return_results (bool): If True, returns the masks, scores, and logits.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to save_masks().</span>

<span class="sd">        Returns:</span>
<span class="sd">            If return_results is True:</span>
<span class="sd">                Tuple[List[Dict], List[np.ndarray], List[np.ndarray]]: Tuple of</span>
<span class="sd">                    (output_masks, scores, logits) where output_masks is a list</span>
<span class="sd">                    of dictionaries with &#39;segmentation&#39; and &#39;area&#39; keys.</span>
<span class="sd">            If return_results is False:</span>
<span class="sd">                None</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Initialize with instance interactivity enabled</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image(&quot;satellite.tif&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Using a list of geographic coordinates</span>
<span class="sd">            &gt;&gt;&gt; point_coords = [</span>
<span class="sd">            ...     [-117.599896, 47.655345],</span>
<span class="sd">            ...     [-117.59992, 47.655167],</span>
<span class="sd">            ...     [-117.599928, 47.654974],</span>
<span class="sd">            ...     [-117.599518, 47.655337],</span>
<span class="sd">            ... ]</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_points_patch(</span>
<span class="sd">            ...     point_coords_batch=point_coords,</span>
<span class="sd">            ...     point_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">            ...     output=&quot;masks.tif&quot;,</span>
<span class="sd">            ...     dtype=&quot;uint8&quot;,</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Using a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_points_patch(</span>
<span class="sd">            ...     point_coords_batch=&quot;building_centroids.geojson&quot;,</span>
<span class="sd">            ...     point_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">            ...     output=&quot;building_masks.tif&quot;,</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Using a GeoDataFrame</span>
<span class="sd">            &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">            &gt;&gt;&gt; gdf = gpd.read_file(&quot;points.geojson&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks_by_points_patch(</span>
<span class="sd">            ...     point_coords_batch=gdf,</span>
<span class="sd">            ...     point_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">            ...     output=&quot;masks.tif&quot;,</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;generate_masks_by_points_patch is only available for the Meta backend. &quot;</span>
                <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No source image set. This method requires a file path to be provided &quot;</span>
                <span class="s2">&quot;to set_image() for georeferencing support.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
                <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process point coordinates based on input type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># GeoJSON-like dict</span>
            <span class="n">point_coords_batch</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">point_coords_batch</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span>
        <span class="p">):</span>
            <span class="c1"># File path or GeoDataFrame</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">point_coords_batch</span>

            <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">point_crs</span>

            <span class="c1"># Extract point coordinates from geometry</span>
            <span class="n">points_list</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">coordinates_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">point</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points_list</span><span class="p">])</span>

            <span class="c1"># Convert coordinates to pixel coordinates</span>
            <span class="n">points</span><span class="p">,</span> <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">coordinates_array</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Filter labels to match filtered coordinates</span>
            <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points_list</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_of_bounds</span>
                <span class="p">]</span>
                <span class="n">point_labels_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_labels_batch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">point_labels_batch</span><span class="p">])</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Convert from CRS to pixel coordinates</span>
                <span class="n">point_coords_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>
                <span class="n">point_coords_xy</span><span class="p">,</span> <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                    <span class="n">point_coords_array</span><span class="p">,</span>
                    <span class="n">point_crs</span><span class="p">,</span>
                    <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Filter labels to match filtered coordinates</span>
                <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Create a mask for valid (in-bounds) indices</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">i</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_of_bounds</span>
                    <span class="p">]</span>
                    <span class="n">point_labels_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_labels_batch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point_coords_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>

            <span class="c1"># Format points for batch processing: each point as separate prompt</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">point</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">point_coords_xy</span><span class="p">])</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_labels_batch</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">point_labels_batch</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">point_labels_batch</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">point_coords_batch</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">point_labels_batch</span>
            <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;point_coords_batch must be a list, GeoDataFrame, file path, or numpy array.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Set up batch state for single image batch processing</span>
        <span class="c1"># Use set_image_batch with the current image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image_batch</span><span class="p">([</span><span class="n">pil_image</span><span class="p">],</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>

        <span class="c1"># Call predict_inst_batch with the formatted points</span>
        <span class="c1"># predict_inst_batch expects batches per image, we have one image with multiple points</span>
        <span class="n">masks_batch</span><span class="p">,</span> <span class="n">scores_batch</span><span class="p">,</span> <span class="n">logits_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_inst_batch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">,</span>
            <span class="p">[</span><span class="n">points</span><span class="p">],</span>  <span class="c1"># One entry for our single image</span>
            <span class="p">[</span><span class="n">labels</span><span class="p">],</span>  <span class="c1"># One entry for our single image</span>
            <span class="n">box_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mask_input_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
            <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">normalize_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Extract results for our single image</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">logits_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Handle multimask output - select best mask per prompt if index not specified</span>
        <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Select best mask for each prompt based on scores</span>
            <span class="n">best_masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">best_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">best_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
                <span class="n">best_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_masks</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_scores</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Ensure masks is 3D (num_masks, H, W)</span>
        <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># Add batch dimension</span>

        <span class="c1"># Store results in the format expected by show_anns/show_masks/save_masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

        <span class="c1"># Create output mask list with segmentation dict format for return value</span>
        <span class="n">output_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">sums</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">output_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Compute bounding boxes from masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Save masks if output path is provided</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span>
                <span class="n">output</span><span class="p">,</span>
                <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span>
                <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
                <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your point prompts.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_inst_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">masks</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">point_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">borders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display masks from predict_inst results with optional point and box overlays.</span>

<span class="sd">        Args:</span>
<span class="sd">            masks (np.ndarray): Masks from predict_inst, shape CxHxW.</span>
<span class="sd">            scores (np.ndarray): Scores from predict_inst, shape C.</span>
<span class="sd">            point_coords (np.ndarray or List, optional): Point coordinates used for prompts.</span>
<span class="sd">                Can be a numpy array or a Python list like [[x1, y1], [x2, y2]].</span>
<span class="sd">            point_labels (np.ndarray or List, optional): Point labels (1=foreground, 0=background).</span>
<span class="sd">            box_coords (np.ndarray or List, optional): Box coordinates used for prompt.</span>
<span class="sd">                Can be a numpy array or a Python list like [x1, y1, x2, y2].</span>
<span class="sd">            figsize (Tuple[int, int]): Figure size for each mask display.</span>
<span class="sd">            borders (bool): Whether to draw contour borders on masks.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">            &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">            ...     point_coords=[[520, 375]],</span>
<span class="sd">            ...     point_labels=[1],</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; sam.show_inst_masks(</span>
<span class="sd">            ...     masks, scores,</span>
<span class="sd">            ...     point_coords=[[520, 375]],</span>
<span class="sd">            ...     point_labels=[1],</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Convert lists to numpy arrays</span>
        <span class="k">if</span> <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">box_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box_coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">box_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box_coords</span><span class="p">)</span>

        <span class="c1"># Sort by score (descending)</span>
        <span class="n">sorted_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">sorted_ind</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">sorted_ind</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">)):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

            <span class="c1"># Show mask</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">mask_uint8</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">30</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">144</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
            <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_uint8</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">borders</span><span class="p">:</span>
                <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                    <span class="n">mask_uint8</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_NONE</span>
                <span class="p">)</span>
                <span class="n">contours</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span>
                <span class="p">]</span>
                <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span>
                    <span class="n">mask_image</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>

            <span class="c1"># Show points if provided</span>
            <span class="k">if</span> <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pos_points</span> <span class="o">=</span> <span class="n">point_coords</span><span class="p">[</span><span class="n">point_labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">neg_points</span> <span class="o">=</span> <span class="n">point_coords</span><span class="p">[</span><span class="n">point_labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">pos_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">pos_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">neg_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">neg_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Show box if provided</span>
            <span class="k">if</span> <span class="n">box_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">box_w</span><span class="p">,</span> <span class="n">box_h</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">box_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">box_coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span>
                        <span class="n">box_w</span><span class="p">,</span>
                        <span class="n">box_h</span><span class="p">,</span>
                        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Score: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="s1">&#39;facebook/sam3&#39;</span><span class="p">,</span> <span class="n">bpe_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_from_HF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_segmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_inst_interactivity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compile_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1008</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mask_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initializes the SamGeo3 class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>backend</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Backend to use ('meta' or 'transformers'). Default is 'meta'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;meta&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model ID for Transformers backend (e.g., 'facebook/sam3').
Only used when backend='transformers'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;facebook/sam3&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bpe_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the BPE tokenizer vocabulary (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device to load the model on ('cuda' or 'cpu').</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eval_mode</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to set the model to evaluation mode (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>checkpoint_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to model checkpoint (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_from_HF</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to load the model from HuggingFace (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_segmentation</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable segmentation head (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_inst_interactivity</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable instance interactivity
(SAM 1 task) (Meta backend only). Set to True to use predict_inst() and
predict_inst_batch() methods for interactive point and box prompts.
When True, the model loads additional components for SAM1-style
interactive instance segmentation. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compile_mode</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>To enable compilation, set to "default" (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resolution</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resolution of the image (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>1008</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Confidence threshold for the model.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mask threshold for post-processing (Transformers backend only).</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3.__init__--for-text-based-segmentation">For text-based segmentation<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.__init__--for-text-based-segmentation" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3(backend="meta")
sam.set_image("image.jpg")
sam.generate_masks("tree")</p>
<h4 id="samgeo.samgeo3.SamGeo3.__init__--for-interactive-pointbox-prompts-sam1-style">For interactive point/box prompts (SAM1-style)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.__init__--for-interactive-pointbox-prompts-sam1-style" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)
sam.set_image("image.jpg")
masks, scores, logits = sam.predict_inst(
...     point_coords=np.array([[520, 375]]),
...     point_labels=np.array([1]),
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span>
    <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;facebook/sam3&quot;</span><span class="p">,</span>
    <span class="n">bpe_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">eval_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">load_from_HF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_segmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_inst_interactivity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">compile_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resolution</span><span class="o">=</span><span class="mi">1008</span><span class="p">,</span>
    <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">mask_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the SamGeo3 class.</span>

<span class="sd">    Args:</span>
<span class="sd">        backend (str): Backend to use (&#39;meta&#39; or &#39;transformers&#39;). Default is &#39;meta&#39;.</span>
<span class="sd">        model_id (str): Model ID for Transformers backend (e.g., &#39;facebook/sam3&#39;).</span>
<span class="sd">            Only used when backend=&#39;transformers&#39;.</span>
<span class="sd">        bpe_path (str, optional): Path to the BPE tokenizer vocabulary (Meta backend only).</span>
<span class="sd">        device (str, optional): Device to load the model on (&#39;cuda&#39; or &#39;cpu&#39;).</span>
<span class="sd">        eval_mode (bool, optional): Whether to set the model to evaluation mode (Meta backend only).</span>
<span class="sd">        checkpoint_path (str, optional): Optional path to model checkpoint (Meta backend only).</span>
<span class="sd">        load_from_HF (bool, optional): Whether to load the model from HuggingFace (Meta backend only).</span>
<span class="sd">        enable_segmentation (bool, optional): Whether to enable segmentation head (Meta backend only).</span>
<span class="sd">        enable_inst_interactivity (bool, optional): Whether to enable instance interactivity</span>
<span class="sd">            (SAM 1 task) (Meta backend only). Set to True to use predict_inst() and</span>
<span class="sd">            predict_inst_batch() methods for interactive point and box prompts.</span>
<span class="sd">            When True, the model loads additional components for SAM1-style</span>
<span class="sd">            interactive instance segmentation. Defaults to False.</span>
<span class="sd">        compile_mode (bool, optional): To enable compilation, set to &quot;default&quot; (Meta backend only).</span>
<span class="sd">        resolution (int, optional): Resolution of the image (Meta backend only).</span>
<span class="sd">        confidence_threshold (float, optional): Confidence threshold for the model.</span>
<span class="sd">        mask_threshold (float, optional): Mask threshold for post-processing (Transformers backend only).</span>
<span class="sd">        **kwargs: Additional keyword arguments.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # For text-based segmentation</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;tree&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # For interactive point/box prompts (SAM1-style)</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">        ...     point_coords=np.array([[520, 375]]),</span>
<span class="sd">        ...     point_labels=np.array([1]),</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid backend &#39;</span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&#39;. Choose &#39;meta&#39; or &#39;transformers&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SAM3_META_AVAILABLE</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Meta SAM3 is not available. Please install it as:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">pip install segment-geospatial[samgeo3]&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">SAM3_META_IMPORT_ERROR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Underlying import error:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">SAM3_META_IMPORT_ERROR</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;transformers&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SAM3_TRANSFORMERS_AVAILABLE</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Transformers SAM3 is not available. Please install it as:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">pip install transformers torch&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">SAM3_TRANSFORMERS_IMPORT_ERROR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Underlying import error:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">SAM3_TRANSFORMERS_IMPORT_ERROR</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_device</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> device and </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2"> backend&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">confidence_threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="s2">&quot;sam3&quot;</span>

    <span class="c1"># Initialize backend-specific components</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_meta_backend</span><span class="p">(</span>
            <span class="n">bpe_path</span><span class="o">=</span><span class="n">bpe_path</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">eval_mode</span><span class="o">=</span><span class="n">eval_mode</span><span class="p">,</span>
            <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span>
            <span class="n">load_from_HF</span><span class="o">=</span><span class="n">load_from_HF</span><span class="p">,</span>
            <span class="n">enable_segmentation</span><span class="o">=</span><span class="n">enable_segmentation</span><span class="p">,</span>
            <span class="n">enable_inst_interactivity</span><span class="o">=</span><span class="n">enable_inst_interactivity</span><span class="p">,</span>
            <span class="n">compile_mode</span><span class="o">=</span><span class="n">compile_mode</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">confidence_threshold</span><span class="o">=</span><span class="n">confidence_threshold</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_transformers_backend</span><span class="p">(</span>
            <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Common attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Batch processing attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks for the input image using SAM3.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text prompt describing the objects to segment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>quiet</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, suppress progress messages. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[Dict[str, Any]]: A list of dictionaries containing the generated masks.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks for the input image using SAM3.</span>

<span class="sd">    Args:</span>
<span class="sd">        prompt (str): The text prompt describing the objects to segment.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">        quiet (bool): If True, suppress progress messages. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Dict[str, Any]]: A list of dictionaries containing the generated masks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">reset_all_prompts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_text_prompt</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pil_image&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare inputs</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Get original sizes for post-processing</span>
        <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_sizes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">original_sizes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_sizes</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">]]</span>

        <span class="c1"># Run inference</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Post-process results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">post_process_instance_segmentation</span><span class="p">(</span>
            <span class="n">outputs</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">,</span>
            <span class="n">target_sizes</span><span class="o">=</span><span class="n">original_sizes</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Convert results to match Meta backend format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>

    <span class="c1"># Convert tensors to numpy to free GPU memory</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_convert_results_to_numpy</span><span class="p">()</span>

    <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
    <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please try a different prompt.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks_batch</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks_batch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks for all images in the batch using SAM3.</p>
<p>Note: This method is only available for the Meta backend.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text prompt describing the objects to segment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3(backend="meta")
sam.set_image_batch(["image1.jpg", "image2.jpg"])
results = sam.generate_masks_batch("building")
for i, result in enumerate(results):
...     print(f"Image {i}: Found {len(result['masks'])} objects")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks for all images in the batch using SAM3.</span>

<span class="sd">    Note: This method is only available for the Meta backend.</span>

<span class="sd">    Args:</span>
<span class="sd">        prompt (str): The text prompt describing the objects to segment.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out. Defaults to None (no maximum).</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image_batch([&quot;image1.jpg&quot;, &quot;image2.jpg&quot;])</span>
<span class="sd">        &gt;&gt;&gt; results = sam.generate_masks_batch(&quot;building&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for i, result in enumerate(results):</span>
<span class="sd">        ...     print(f&quot;Image {i}: Found {len(result[&#39;masks&#39;])} objects&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Batch mask generation is only available for the Meta backend.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No images set for batch processing. &quot;</span>
            <span class="s2">&quot;Please call set_image_batch() first.&quot;</span>
        <span class="p">)</span>

    <span class="n">batch_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span><span class="p">)</span>

    <span class="c1"># The batch backbone features are computed once, but text prompting</span>
    <span class="c1"># needs to be done per-image since set_text_prompt expects singular</span>
    <span class="c1"># original_height/original_width keys</span>
    <span class="n">backbone_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backbone_out&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">):</span>
        <span class="c1"># Create a per-image state with the correct singular keys</span>
        <span class="n">image_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;original_height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">[</span><span class="s2">&quot;original_heights&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;original_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">[</span><span class="s2">&quot;original_widths&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Extract backbone features for this specific image</span>
        <span class="c1"># The backbone_out contains batched features, we need to slice them</span>
        <span class="n">image_backbone_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_image_backbone_features</span><span class="p">(</span><span class="n">backbone_out</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">image_state</span><span class="p">[</span><span class="s2">&quot;backbone_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_backbone_out</span>

        <span class="c1"># Reset prompts and set text prompt for this image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">reset_all_prompts</span><span class="p">(</span><span class="n">image_state</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_text_prompt</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">image_state</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>

        <span class="c1"># Build result for this image</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;boxes&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Convert tensors to numpy</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_batch_result_to_numpy</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># Filter by size if needed</span>
        <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_batch_result_by_size</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

        <span class="n">batch_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="o">=</span> <span class="n">batch_results</span>

    <span class="c1"># Print summary</span>
    <span class="n">total_objects</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">num_images</span><span class="si">}</span><span class="s2"> image(s), found </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="s2"> total object(s).&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks_by_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks using bounding box prompts.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>boxes</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of bounding boxes in XYXY format
[[xmin, ymin, xmax, ymax], ...].
If box_crs is None: pixel coordinates.
If box_crs is specified: coordinates in the given CRS (e.g., "EPSG:4326").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_labels</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of boolean labels for each box.
True for positive prompt (include), False for negative prompt (exclude).
If None, all boxes are treated as positive prompts.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for box coordinates
(e.g., "EPSG:4326" for lat/lon). Only used if the source image is a GeoTIFF.
If None, boxes are assumed to be in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Dictionary containing masks, boxes, and scores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-pixel-coordinates">For pixel coordinates:<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-pixel-coordinates" title="Permanent link">&para;</a></h4>
<p>boxes = [[100, 200, 300, 400]]
sam.generate_masks_by_boxes(boxes)</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-geographic-coordinates-geotiff">For geographic coordinates (GeoTIFF):<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes--for-geographic-coordinates-geotiff" title="Permanent link">&para;</a></h4>
<p>boxes = [[-122.5, 37.7, -122.4, 37.8]]  # [lon_min, lat_min, lon_max, lat_max]
sam.generate_masks_by_boxes(boxes, box_crs="EPSG:4326")</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_boxes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">boxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">box_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks using bounding box prompts.</span>

<span class="sd">    Args:</span>
<span class="sd">        boxes (List[List[float]]): List of bounding boxes in XYXY format</span>
<span class="sd">            [[xmin, ymin, xmax, ymax], ...].</span>
<span class="sd">            If box_crs is None: pixel coordinates.</span>
<span class="sd">            If box_crs is specified: coordinates in the given CRS (e.g., &quot;EPSG:4326&quot;).</span>
<span class="sd">        box_labels (List[bool], optional): List of boolean labels for each box.</span>
<span class="sd">            True for positive prompt (include), False for negative prompt (exclude).</span>
<span class="sd">            If None, all boxes are treated as positive prompts.</span>
<span class="sd">        box_crs (str, optional): Coordinate reference system for box coordinates</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot; for lat/lon). Only used if the source image is a GeoTIFF.</span>
<span class="sd">            If None, boxes are assumed to be in pixel coordinates.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">        **kwargs: Additional keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Dictionary containing masks, boxes, and scores.</span>

<span class="sd">    Example:</span>
<span class="sd">        # For pixel coordinates:</span>
<span class="sd">        boxes = [[100, 200, 300, 400]]</span>
<span class="sd">        sam.generate_masks_by_boxes(boxes)</span>

<span class="sd">        # For geographic coordinates (GeoTIFF):</span>
<span class="sd">        boxes = [[-122.5, 37.7, -122.4, 37.8]]  # [lon_min, lat_min, lon_max, lat_max]</span>
<span class="sd">        sam.generate_masks_by_boxes(boxes, box_crs=&quot;EPSG:4326&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pil_image&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">box_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_labels</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of boxes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match number of labels (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">box_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Transform boxes from CRS to pixel coordinates if needed</span>
    <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pixel_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>

            <span class="c1"># Transform min corner</span>
            <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
            <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Transform max corner</span>
            <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
            <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Convert to pixel coordinates and ensure correct min/max order</span>
            <span class="c1"># (geographic y increases north, pixel y increases down)</span>
            <span class="n">x1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Ensure we have correct min/max values</span>
            <span class="n">x_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
            <span class="n">y_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>
            <span class="n">x_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
            <span class="n">y_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>

            <span class="n">pixel_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_min_px</span><span class="p">,</span> <span class="n">y_min_px</span><span class="p">,</span> <span class="n">x_max_px</span><span class="p">,</span> <span class="n">y_max_px</span><span class="p">])</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="n">pixel_boxes</span>

    <span class="c1"># Get image dimensions</span>
    <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span>
    <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="c1"># Reset all prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">reset_all_prompts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">)</span>

        <span class="c1"># Process each box</span>
        <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_labels</span><span class="p">):</span>
            <span class="c1"># Convert XYXY to CxCyWH format</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># Normalize to [0, 1] range</span>
            <span class="n">norm_box</span> <span class="o">=</span> <span class="p">[</span><span class="n">cx</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">cy</span> <span class="o">/</span> <span class="n">height</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">h</span> <span class="o">/</span> <span class="n">height</span><span class="p">]</span>

            <span class="c1"># Add geometric prompt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">add_geometric_prompt</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">norm_box</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span>
            <span class="p">)</span>

        <span class="c1"># Get the masks from the inference state</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
        <span class="c1"># For Transformers backend, process boxes with the processor</span>
        <span class="c1"># Convert boxes to the format expected by Transformers</span>
        <span class="c1"># Transformers expects boxes in XYXY format with 3 levels of nesting:</span>
        <span class="c1"># [image level, box level, box coordinates]</span>
        <span class="c1"># Also convert numpy types to Python native types</span>
        <span class="n">input_boxes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">box</span><span class="p">]</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">]</span>
        <span class="p">]</span>  <span class="c1"># Wrap in list for image level and convert to float</span>

        <span class="c1"># Prepare inputs with boxes</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">(</span>
            <span class="n">images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span><span class="p">,</span> <span class="n">input_boxes</span><span class="o">=</span><span class="n">input_boxes</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Get original sizes for post-processing</span>
        <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_sizes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_sizes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_sizes</span> <span class="o">=</span> <span class="n">original_sizes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_sizes</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">]]</span>

        <span class="c1"># Run inference</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Post-process results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">post_process_instance_segmentation</span><span class="p">(</span>
            <span class="n">outputs</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">,</span>
            <span class="n">target_sizes</span><span class="o">=</span><span class="n">original_sizes</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Convert results to match Meta backend format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>

    <span class="c1"># Convert tensors to numpy to free GPU memory</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_convert_results_to_numpy</span><span class="p">()</span>

    <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
    <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your box prompts.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks_by_boxes_inst</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multimask_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks using bounding box prompts with instance interactivity.</p>
<p>This is a high-level method that wraps predict_inst() for ease of use.
It stores the results in self.masks, self.scores, and self.boxes for
subsequent use with show_anns(), show_masks(), and save_masks().</p>
<p>Note: This method requires the model to be initialized with
<code>enable_inst_interactivity=True</code> (Meta backend only).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>boxes</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]] | <span title="str">str</span> | <span title="GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding boxes for
segmentation. Can be:
- A list of [xmin, ymin, xmax, ymax] coordinates
- A file path to a vector file (GeoJSON, Shapefile, etc.)
- A GeoDataFrame with polygon geometries
If box_crs is None: pixel coordinates (for list input).
If box_crs is specified: coordinates in the given CRS (e.g., "EPSG:4326").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for box coordinates
(e.g., "EPSG:4326" for lat/lon). Only used if the source image is a GeoTIFF.
If None, boxes are assumed to be in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output mask as a GeoTIFF.
If None, masks are stored in memory only.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multimask_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the model returns 3 masks per box and the
best one is selected by score. If False, returns single mask directly.
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for the output mask array. Defaults to "uint8".</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint8&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to predict_inst() or save_masks().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Dictionary containing masks, scores, and logits.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--initialize-with-instance-interactivity-enabled">Initialize with instance interactivity enabled<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--initialize-with-instance-interactivity-enabled" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)
sam.set_image("satellite.tif")</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--single-box-pixel-coordinates">Single box (pixel coordinates)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--single-box-pixel-coordinates" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_boxes_inst([[425, 600, 700, 875]])
sam.show_anns()
sam.save_masks("mask.png")</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--multiple-boxes-with-geographic-coordinates">Multiple boxes with geographic coordinates<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--multiple-boxes-with-geographic-coordinates" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_boxes_inst([
...     [-117.5995, 47.6518, -117.5988, 47.652],
...     [-117.5987, 47.6518, -117.5979, 47.652],
... ], box_crs="EPSG:4326", output="mask.tif")</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-vector-file-geojson-shapefile-etc">Using a vector file (GeoJSON, Shapefile, etc.)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-vector-file-geojson-shapefile-etc" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_boxes_inst(
...     "building_bboxes.geojson",
...     box_crs="EPSG:4326",
...     output="building_masks.tif",
...     dtype="uint16",
... )</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-geodataframe">Using a GeoDataFrame<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_boxes_inst--using-a-geodataframe" title="Permanent link">&para;</a></h4>
<p>import geopandas as gpd
gdf = gpd.read_file("polygons.geojson")
sam.generate_masks_by_boxes_inst(
...     gdf,
...     box_crs="EPSG:4326",
...     output="masks.tif",
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_boxes_inst</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">boxes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;gpd.GeoDataFrame&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks using bounding box prompts with instance interactivity.</span>

<span class="sd">    This is a high-level method that wraps predict_inst() for ease of use.</span>
<span class="sd">    It stores the results in self.masks, self.scores, and self.boxes for</span>
<span class="sd">    subsequent use with show_anns(), show_masks(), and save_masks().</span>

<span class="sd">    Note: This method requires the model to be initialized with</span>
<span class="sd">    `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">    Args:</span>
<span class="sd">        boxes (List[List[float]] | str | GeoDataFrame): Bounding boxes for</span>
<span class="sd">            segmentation. Can be:</span>
<span class="sd">            - A list of [xmin, ymin, xmax, ymax] coordinates</span>
<span class="sd">            - A file path to a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">            - A GeoDataFrame with polygon geometries</span>
<span class="sd">            If box_crs is None: pixel coordinates (for list input).</span>
<span class="sd">            If box_crs is specified: coordinates in the given CRS (e.g., &quot;EPSG:4326&quot;).</span>
<span class="sd">        box_crs (str, optional): Coordinate reference system for box coordinates</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot; for lat/lon). Only used if the source image is a GeoTIFF.</span>
<span class="sd">            If None, boxes are assumed to be in pixel coordinates.</span>
<span class="sd">        output (str, optional): Path to save the output mask as a GeoTIFF.</span>
<span class="sd">            If None, masks are stored in memory only.</span>
<span class="sd">        multimask_output (bool): If True, the model returns 3 masks per box and the</span>
<span class="sd">            best one is selected by score. If False, returns single mask directly.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">        dtype (str): Data type for the output mask array. Defaults to &quot;uint8&quot;.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to predict_inst() or save_masks().</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Dictionary containing masks, scores, and logits.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Initialize with instance interactivity enabled</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image(&quot;satellite.tif&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Single box (pixel coordinates)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_boxes_inst([[425, 600, 700, 875]])</span>
<span class="sd">        &gt;&gt;&gt; sam.show_anns()</span>
<span class="sd">        &gt;&gt;&gt; sam.save_masks(&quot;mask.png&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Multiple boxes with geographic coordinates</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_boxes_inst([</span>
<span class="sd">        ...     [-117.5995, 47.6518, -117.5988, 47.652],</span>
<span class="sd">        ...     [-117.5987, 47.6518, -117.5979, 47.652],</span>
<span class="sd">        ... ], box_crs=&quot;EPSG:4326&quot;, output=&quot;mask.tif&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Using a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_boxes_inst(</span>
<span class="sd">        ...     &quot;building_bboxes.geojson&quot;,</span>
<span class="sd">        ...     box_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">        ...     output=&quot;building_masks.tif&quot;,</span>
<span class="sd">        ...     dtype=&quot;uint16&quot;,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Using a GeoDataFrame</span>
<span class="sd">        &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">        &gt;&gt;&gt; gdf = gpd.read_file(&quot;polygons.geojson&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_boxes_inst(</span>
<span class="sd">        ...     gdf,</span>
<span class="sd">        ...     box_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">        ...     output=&quot;masks.tif&quot;,</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;generate_masks_by_boxes_inst is only available for the Meta backend. &quot;</span>
            <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
            <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Process boxes based on input type</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># GeoJSON-like dict</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">)):</span>
        <span class="c1"># File path or GeoDataFrame</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">boxes</span>

        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">box_crs</span>
        <span class="k">elif</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box_crs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Extract bounding boxes from geometries</span>
        <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">bounds</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">boxes</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;boxes must be a list, GeoDataFrame, file path, or numpy array.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Filter boxes that are out of image bounds if box_crs is provided</span>
    <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">transform_bounds</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">img_bounds</span> <span class="o">=</span> <span class="n">transform_bounds</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

        <span class="n">xmin_img</span><span class="p">,</span> <span class="n">ymin_img</span><span class="p">,</span> <span class="n">xmax_img</span><span class="p">,</span> <span class="n">ymax_img</span> <span class="o">=</span> <span class="n">img_bounds</span>

        <span class="n">valid_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes_list</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
            <span class="c1"># Check if box overlaps with image bounds</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin_img</span>
                <span class="ow">and</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">xmax_img</span>
                <span class="ow">and</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">ymin_img</span>
                <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="n">ymax_img</span>
            <span class="p">):</span>
                <span class="n">valid_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtered_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">filtered_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Filtered </span><span class="si">{</span><span class="n">filtered_count</span><span class="si">}</span><span class="s2"> boxes outside image bounds. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_boxes</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid boxes.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid boxes found within image bounds.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>

        <span class="n">boxes_list</span> <span class="o">=</span> <span class="n">valid_boxes</span>

    <span class="c1"># Convert to numpy array</span>
    <span class="n">boxes_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes_list</span><span class="p">)</span>

    <span class="c1"># Call predict_inst with box prompts</span>
    <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_inst</span><span class="p">(</span>
        <span class="n">box</span><span class="o">=</span><span class="n">boxes_arr</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
        <span class="n">box_crs</span><span class="o">=</span><span class="n">box_crs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Handle batch output shape (BxCxHxW) vs single (CxHxW)</span>
    <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># Multiple boxes - flatten into list of masks</span>
        <span class="c1"># Each box produces C masks, take the best one per box</span>
        <span class="n">all_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">all_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
                <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">all_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">all_masks</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">all_scores</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Single box</span>
        <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">scores</span><span class="p">]</span>

    <span class="c1"># Store results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

    <span class="c1"># Compute bounding boxes from masks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">mask_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
    <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your box prompts.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

    <span class="c1"># Save masks if output path is provided</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
            <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks_by_points</span><span class="p">(</span><span class="n">point_coords</span><span class="p">,</span> <span class="n">point_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multimask_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks using point prompts.</p>
<p>This is a high-level method that wraps predict_inst() for ease of use.
It stores the results in self.masks, self.scores, and self.boxes for
subsequent use with show_anns(), show_masks(), and save_masks().</p>
<p>Note: This method requires the model to be initialized with
<code>enable_inst_interactivity=True</code> (Meta backend only).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>point_coords</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of point coordinates [[x, y], ...].
If point_crs is None: pixel coordinates.
If point_crs is specified: coordinates in the given CRS (e.g., "EPSG:4326").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_labels</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of labels for each point.
1 = foreground (include), 0 = background (exclude).
If None, all points are treated as foreground (label=1).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for point coordinates
(e.g., "EPSG:4326" for lat/lon). Only used if the source image is a GeoTIFF.
If None, points are assumed to be in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multimask_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the model returns 3 masks and the best
one is selected by score. Recommended for ambiguous prompts like single
points. If False, returns single mask directly. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to predict_inst().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Dictionary containing masks, scores, and logits.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points--initialize-with-instance-interactivity-enabled">Initialize with instance interactivity enabled<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--initialize-with-instance-interactivity-enabled" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)
sam.set_image("image.jpg")</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points--single-foreground-point-pixel-coordinates">Single foreground point (pixel coordinates)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--single-foreground-point-pixel-coordinates" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_points([[520, 375]])
sam.show_anns()
sam.save_masks("mask.png")</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points--multiple-points-with-labels">Multiple points with labels<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--multiple-points-with-labels" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_points(
    [[500, 375], [1125, 625]],
    point_labels=[1, 0]  # foreground, background
)</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points--geographic-coordinates-geotiff">Geographic coordinates (GeoTIFF)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points--geographic-coordinates-geotiff" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_points(
    [[-122.258, 37.871]],
    point_crs="EPSG:4326"
)</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_points</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">point_coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks using point prompts.</span>

<span class="sd">    This is a high-level method that wraps predict_inst() for ease of use.</span>
<span class="sd">    It stores the results in self.masks, self.scores, and self.boxes for</span>
<span class="sd">    subsequent use with show_anns(), show_masks(), and save_masks().</span>

<span class="sd">    Note: This method requires the model to be initialized with</span>
<span class="sd">    `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coords (List[List[float]]): List of point coordinates [[x, y], ...].</span>
<span class="sd">            If point_crs is None: pixel coordinates.</span>
<span class="sd">            If point_crs is specified: coordinates in the given CRS (e.g., &quot;EPSG:4326&quot;).</span>
<span class="sd">        point_labels (List[int], optional): List of labels for each point.</span>
<span class="sd">            1 = foreground (include), 0 = background (exclude).</span>
<span class="sd">            If None, all points are treated as foreground (label=1).</span>
<span class="sd">        point_crs (str, optional): Coordinate reference system for point coordinates</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot; for lat/lon). Only used if the source image is a GeoTIFF.</span>
<span class="sd">            If None, points are assumed to be in pixel coordinates.</span>
<span class="sd">        multimask_output (bool): If True, the model returns 3 masks and the best</span>
<span class="sd">            one is selected by score. Recommended for ambiguous prompts like single</span>
<span class="sd">            points. If False, returns single mask directly. Defaults to True.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to predict_inst().</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Dictionary containing masks, scores, and logits.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Initialize with instance interactivity enabled</span>
<span class="sd">        sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        sam.set_image(&quot;image.jpg&quot;)</span>

<span class="sd">        # Single foreground point (pixel coordinates)</span>
<span class="sd">        sam.generate_masks_by_points([[520, 375]])</span>
<span class="sd">        sam.show_anns()</span>
<span class="sd">        sam.save_masks(&quot;mask.png&quot;)</span>

<span class="sd">        # Multiple points with labels</span>
<span class="sd">        sam.generate_masks_by_points(</span>
<span class="sd">            [[500, 375], [1125, 625]],</span>
<span class="sd">            point_labels=[1, 0]  # foreground, background</span>
<span class="sd">        )</span>

<span class="sd">        # Geographic coordinates (GeoTIFF)</span>
<span class="sd">        sam.generate_masks_by_points(</span>
<span class="sd">            [[-122.258, 37.871]],</span>
<span class="sd">            point_crs=&quot;EPSG:4326&quot;</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;generate_masks_by_points is only available for the Meta backend. &quot;</span>
            <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
            <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Convert to numpy array if it&#39;s a list</span>
    <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>

    <span class="c1"># Default all points to foreground if no labels provided</span>
    <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_labels</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of points (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match number of labels (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Call predict_inst with the prompts</span>
    <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_inst</span><span class="p">(</span>
        <span class="n">point_coords</span><span class="o">=</span><span class="n">point_coords</span><span class="p">,</span>
        <span class="n">point_labels</span><span class="o">=</span><span class="n">point_labels</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
        <span class="n">point_crs</span><span class="o">=</span><span class="n">point_crs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If multimask_output=True, select the best mask by score</span>
    <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">best_idx</span> <span class="p">:</span> <span class="n">best_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">best_idx</span> <span class="p">:</span> <span class="n">best_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">best_idx</span> <span class="p">:</span> <span class="n">best_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Store results in the format expected by show_anns/show_masks/save_masks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">scores</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

    <span class="c1"># Compute bounding boxes from masks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Filter masks by size if min_size or max_size is specified</span>
    <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_masks_by_size</span><span class="p">(</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>

    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your point prompts.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks_by_points_patch</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_labels_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="n">multimask_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks for multiple point prompts using batch processing.</p>
<p>This method is similar to SamGeo2.predict_by_points but uses SAM3's
predict_inst_batch for efficient batch processing of point prompts on
a single image. Each point is treated as a separate prompt to generate
a separate mask.</p>
<p>Note: This method requires the model to be initialized with
<code>enable_inst_interactivity=True</code> (Meta backend only).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>point_coords_batch</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]] | <span title="str">str</span> | <span title="GeoDataFrame">GeoDataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Point
coordinates for batch processing. Can be:
- A list of [x, y] coordinates
- A file path to a vector file (GeoJSON, Shapefile, etc.)
- A GeoDataFrame with point geometries</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_labels_batch</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Labels for each point.
1 = foreground (include), 0 = background (exclude).
If None, all points are treated as foreground (label=1).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for point
coordinates (e.g., "EPSG:4326"). If provided, coordinates will
be converted from the CRS to pixel coordinates. Required when
using geographic coordinates with a GeoTIFF source image.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output mask as a GeoTIFF.
If None, masks are stored in memory only.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If multimask_output is True, select this
specific mask index from each prediction. If None, selects the
mask with the highest score for each point.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, each mask gets a unique integer value
(1, 2, 3, ...). If False, all masks are combined into a binary
mask. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger
than this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for the output mask array. Defaults to "int32".</p>
              </div>
            </td>
            <td>
                  <code>&#39;int32&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multimask_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the model returns 3 masks per prompt.
Defaults to False for cleaner batch results.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_results</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns the masks, scores, and logits.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to save_masks().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>], <span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>], <span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_results is True:
Tuple[List[Dict], List[np.ndarray], List[np.ndarray]]: Tuple of
    (output_masks, scores, logits) where output_masks is a list
    of dictionaries with 'segmentation' and 'area' keys.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>], <span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>], <span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_results is False:
None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--initialize-with-instance-interactivity-enabled">Initialize with instance interactivity enabled<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--initialize-with-instance-interactivity-enabled" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)
sam.set_image("satellite.tif")</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-list-of-geographic-coordinates">Using a list of geographic coordinates<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-list-of-geographic-coordinates" title="Permanent link">&para;</a></h4>
<p>point_coords = [
...     [-117.599896, 47.655345],
...     [-117.59992, 47.655167],
...     [-117.599928, 47.654974],
...     [-117.599518, 47.655337],
... ]
sam.generate_masks_by_points_patch(
...     point_coords_batch=point_coords,
...     point_crs="EPSG:4326",
...     output="masks.tif",
...     dtype="uint8",
... )</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-vector-file-geojson-shapefile-etc">Using a vector file (GeoJSON, Shapefile, etc.)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-vector-file-geojson-shapefile-etc" title="Permanent link">&para;</a></h4>
<p>sam.generate_masks_by_points_patch(
...     point_coords_batch="building_centroids.geojson",
...     point_crs="EPSG:4326",
...     output="building_masks.tif",
... )</p>
<h4 id="samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-geodataframe">Using a GeoDataFrame<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.generate_masks_by_points_patch--using-a-geodataframe" title="Permanent link">&para;</a></h4>
<p>import geopandas as gpd
gdf = gpd.read_file("points.geojson")
sam.generate_masks_by_points_patch(
...     point_coords_batch=gdf,
...     point_crs="EPSG:4326",
...     output="masks.tif",
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span>
<span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span>
<span class="normal">3559</span>
<span class="normal">3560</span>
<span class="normal">3561</span>
<span class="normal">3562</span>
<span class="normal">3563</span>
<span class="normal">3564</span>
<span class="normal">3565</span>
<span class="normal">3566</span>
<span class="normal">3567</span>
<span class="normal">3568</span>
<span class="normal">3569</span>
<span class="normal">3570</span>
<span class="normal">3571</span>
<span class="normal">3572</span>
<span class="normal">3573</span>
<span class="normal">3574</span>
<span class="normal">3575</span>
<span class="normal">3576</span>
<span class="normal">3577</span>
<span class="normal">3578</span>
<span class="normal">3579</span>
<span class="normal">3580</span>
<span class="normal">3581</span>
<span class="normal">3582</span>
<span class="normal">3583</span>
<span class="normal">3584</span>
<span class="normal">3585</span>
<span class="normal">3586</span>
<span class="normal">3587</span>
<span class="normal">3588</span>
<span class="normal">3589</span>
<span class="normal">3590</span>
<span class="normal">3591</span>
<span class="normal">3592</span>
<span class="normal">3593</span>
<span class="normal">3594</span>
<span class="normal">3595</span>
<span class="normal">3596</span>
<span class="normal">3597</span>
<span class="normal">3598</span>
<span class="normal">3599</span>
<span class="normal">3600</span>
<span class="normal">3601</span>
<span class="normal">3602</span>
<span class="normal">3603</span>
<span class="normal">3604</span>
<span class="normal">3605</span>
<span class="normal">3606</span>
<span class="normal">3607</span>
<span class="normal">3608</span>
<span class="normal">3609</span>
<span class="normal">3610</span>
<span class="normal">3611</span>
<span class="normal">3612</span>
<span class="normal">3613</span>
<span class="normal">3614</span>
<span class="normal">3615</span>
<span class="normal">3616</span>
<span class="normal">3617</span>
<span class="normal">3618</span>
<span class="normal">3619</span>
<span class="normal">3620</span>
<span class="normal">3621</span>
<span class="normal">3622</span>
<span class="normal">3623</span>
<span class="normal">3624</span>
<span class="normal">3625</span>
<span class="normal">3626</span>
<span class="normal">3627</span>
<span class="normal">3628</span>
<span class="normal">3629</span>
<span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_by_points_patch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">point_coords_batch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_labels_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks for multiple point prompts using batch processing.</span>

<span class="sd">    This method is similar to SamGeo2.predict_by_points but uses SAM3&#39;s</span>
<span class="sd">    predict_inst_batch for efficient batch processing of point prompts on</span>
<span class="sd">    a single image. Each point is treated as a separate prompt to generate</span>
<span class="sd">    a separate mask.</span>

<span class="sd">    Note: This method requires the model to be initialized with</span>
<span class="sd">    `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coords_batch (List[List[float]] | str | GeoDataFrame): Point</span>
<span class="sd">            coordinates for batch processing. Can be:</span>
<span class="sd">            - A list of [x, y] coordinates</span>
<span class="sd">            - A file path to a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">            - A GeoDataFrame with point geometries</span>
<span class="sd">        point_labels_batch (List[int], optional): Labels for each point.</span>
<span class="sd">            1 = foreground (include), 0 = background (exclude).</span>
<span class="sd">            If None, all points are treated as foreground (label=1).</span>
<span class="sd">        point_crs (str, optional): Coordinate reference system for point</span>
<span class="sd">            coordinates (e.g., &quot;EPSG:4326&quot;). If provided, coordinates will</span>
<span class="sd">            be converted from the CRS to pixel coordinates. Required when</span>
<span class="sd">            using geographic coordinates with a GeoTIFF source image.</span>
<span class="sd">        output (str, optional): Path to save the output mask as a GeoTIFF.</span>
<span class="sd">            If None, masks are stored in memory only.</span>
<span class="sd">        index (int, optional): If multimask_output is True, select this</span>
<span class="sd">            specific mask index from each prediction. If None, selects the</span>
<span class="sd">            mask with the highest score for each point.</span>
<span class="sd">        unique (bool): If True, each mask gets a unique integer value</span>
<span class="sd">            (1, 2, 3, ...). If False, all masks are combined into a binary</span>
<span class="sd">            mask. Defaults to True.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger</span>
<span class="sd">            than this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">        dtype (str): Data type for the output mask array. Defaults to &quot;int32&quot;.</span>
<span class="sd">        multimask_output (bool): If True, the model returns 3 masks per prompt.</span>
<span class="sd">            Defaults to False for cleaner batch results.</span>
<span class="sd">        return_results (bool): If True, returns the masks, scores, and logits.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to save_masks().</span>

<span class="sd">    Returns:</span>
<span class="sd">        If return_results is True:</span>
<span class="sd">            Tuple[List[Dict], List[np.ndarray], List[np.ndarray]]: Tuple of</span>
<span class="sd">                (output_masks, scores, logits) where output_masks is a list</span>
<span class="sd">                of dictionaries with &#39;segmentation&#39; and &#39;area&#39; keys.</span>
<span class="sd">        If return_results is False:</span>
<span class="sd">            None</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Initialize with instance interactivity enabled</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image(&quot;satellite.tif&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Using a list of geographic coordinates</span>
<span class="sd">        &gt;&gt;&gt; point_coords = [</span>
<span class="sd">        ...     [-117.599896, 47.655345],</span>
<span class="sd">        ...     [-117.59992, 47.655167],</span>
<span class="sd">        ...     [-117.599928, 47.654974],</span>
<span class="sd">        ...     [-117.599518, 47.655337],</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_points_patch(</span>
<span class="sd">        ...     point_coords_batch=point_coords,</span>
<span class="sd">        ...     point_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">        ...     output=&quot;masks.tif&quot;,</span>
<span class="sd">        ...     dtype=&quot;uint8&quot;,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Using a vector file (GeoJSON, Shapefile, etc.)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_points_patch(</span>
<span class="sd">        ...     point_coords_batch=&quot;building_centroids.geojson&quot;,</span>
<span class="sd">        ...     point_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">        ...     output=&quot;building_masks.tif&quot;,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Using a GeoDataFrame</span>
<span class="sd">        &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">        &gt;&gt;&gt; gdf = gpd.read_file(&quot;points.geojson&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_by_points_patch(</span>
<span class="sd">        ...     point_coords_batch=gdf,</span>
<span class="sd">        ...     point_crs=&quot;EPSG:4326&quot;,</span>
<span class="sd">        ...     output=&quot;masks.tif&quot;,</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;generate_masks_by_points_patch is only available for the Meta backend. &quot;</span>
            <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No source image set. This method requires a file path to be provided &quot;</span>
            <span class="s2">&quot;to set_image() for georeferencing support.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
            <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Process point coordinates based on input type</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># GeoJSON-like dict</span>
        <span class="n">point_coords_batch</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">point_coords_batch</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span>
    <span class="p">):</span>
        <span class="c1"># File path or GeoDataFrame</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">point_coords_batch</span>

        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">point_crs</span>

        <span class="c1"># Extract point coordinates from geometry</span>
        <span class="n">points_list</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">coordinates_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">point</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points_list</span><span class="p">])</span>

        <span class="c1"># Convert coordinates to pixel coordinates</span>
        <span class="n">points</span><span class="p">,</span> <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">coordinates_array</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Filter labels to match filtered coordinates</span>
        <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points_list</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_of_bounds</span>
            <span class="p">]</span>
            <span class="n">point_labels_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_labels_batch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">point_labels_batch</span><span class="p">])</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert from CRS to pixel coordinates</span>
            <span class="n">point_coords_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>
            <span class="n">point_coords_xy</span><span class="p">,</span> <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">point_coords_array</span><span class="p">,</span>
                <span class="n">point_crs</span><span class="p">,</span>
                <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Filter labels to match filtered coordinates</span>
            <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create a mask for valid (in-bounds) indices</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_of_bounds</span>
                <span class="p">]</span>
                <span class="n">point_labels_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_labels_batch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point_coords_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">)</span>

        <span class="c1"># Format points for batch processing: each point as separate prompt</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">point</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">point_coords_xy</span><span class="p">])</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">point_labels_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_labels_batch</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">point_labels_batch</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">point_labels_batch</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">point_coords_batch</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">point_labels_batch</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;point_coords_batch must be a list, GeoDataFrame, file path, or numpy array.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Set up batch state for single image batch processing</span>
    <span class="c1"># Use set_image_batch with the current image</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image_batch</span><span class="p">([</span><span class="n">pil_image</span><span class="p">],</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>

    <span class="c1"># Call predict_inst_batch with the formatted points</span>
    <span class="c1"># predict_inst_batch expects batches per image, we have one image with multiple points</span>
    <span class="n">masks_batch</span><span class="p">,</span> <span class="n">scores_batch</span><span class="p">,</span> <span class="n">logits_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_inst_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">,</span>
        <span class="p">[</span><span class="n">points</span><span class="p">],</span>  <span class="c1"># One entry for our single image</span>
        <span class="p">[</span><span class="n">labels</span><span class="p">],</span>  <span class="c1"># One entry for our single image</span>
        <span class="n">box_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask_input_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
        <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">normalize_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Extract results for our single image</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Handle multimask output - select best mask per prompt if index not specified</span>
    <span class="k">if</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">multimask_output</span> <span class="ow">and</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># Select best mask for each prompt based on scores</span>
        <span class="n">best_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">best_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">masks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">best_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
            <span class="n">best_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_idx</span><span class="p">])</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_masks</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_scores</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># Ensure masks is 3D (num_masks, H, W)</span>
    <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># Add batch dimension</span>

    <span class="c1"># Store results in the format expected by show_anns/show_masks/save_masks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

    <span class="c1"># Create output mask list with segmentation dict format for return value</span>
    <span class="n">output_masks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;segmentation&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">),</span>
            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">sums</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">output_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="c1"># Compute bounding boxes from masks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Save masks if output path is provided</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
            <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No objects found. Please check your point prompts.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">num_objects</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found one object.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> objects.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output_masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.generate_masks_tiled" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks_tiled</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.generate_masks_tiled" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks for large GeoTIFF images using a sliding window approach.</p>
<p>This method processes large images tile by tile to avoid GPU memory issues.
The tiles are processed with overlap to ensure seamless mask merging at
boundaries. Each detected object gets a unique ID that is consistent
across the entire image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input GeoTIFF image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text prompt describing the objects to segment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output GeoTIFF file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tile_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of each tile in pixels. Defaults to 1024.</p>
              </div>
            </td>
            <td>
                  <code>1024</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Overlap between adjacent tiles in pixels. Defaults to 128.
Higher overlap helps with better boundary merging but increases
processing time.</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out. Defaults to None (no maximum).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, each mask gets a unique value. If False, binary
mask (0 or 1). Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for the output array. Use 'uint32' for large
numbers of objects, 'uint16' for up to 65535 objects, or 'uint8'
for up to 255 objects. Defaults to 'uint32'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint32&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bands</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices (1-based) to use for RGB
when the input has more than 3 bands. If None, uses first 3 bands.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tiles to process at once (future use).
Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print progress information. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output GeoTIFF file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3(backend="meta")
sam.generate_masks_tiled(
...     source="large_satellite_image.tif",
...     prompt="building",
...     output="buildings_mask.tif",
...     tile_size=1024,
...     overlap=128,
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks_tiled</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tile_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint32&quot;</span><span class="p">,</span>
    <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate masks for large GeoTIFF images using a sliding window approach.</span>

<span class="sd">    This method processes large images tile by tile to avoid GPU memory issues.</span>
<span class="sd">    The tiles are processed with overlap to ensure seamless mask merging at</span>
<span class="sd">    boundaries. Each detected object gets a unique ID that is consistent</span>
<span class="sd">    across the entire image.</span>

<span class="sd">    Args:</span>
<span class="sd">        source (str): Path to the input GeoTIFF image.</span>
<span class="sd">        prompt (str): The text prompt describing the objects to segment.</span>
<span class="sd">        output (str): Path to the output GeoTIFF file.</span>
<span class="sd">        tile_size (int): Size of each tile in pixels. Defaults to 1024.</span>
<span class="sd">        overlap (int): Overlap between adjacent tiles in pixels. Defaults to 128.</span>
<span class="sd">            Higher overlap helps with better boundary merging but increases</span>
<span class="sd">            processing time.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out. Defaults to 0.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out. Defaults to None (no maximum).</span>
<span class="sd">        unique (bool): If True, each mask gets a unique value. If False, binary</span>
<span class="sd">            mask (0 or 1). Defaults to True.</span>
<span class="sd">        dtype (str): Data type for the output array. Use &#39;uint32&#39; for large</span>
<span class="sd">            numbers of objects, &#39;uint16&#39; for up to 65535 objects, or &#39;uint8&#39;</span>
<span class="sd">            for up to 255 objects. Defaults to &#39;uint32&#39;.</span>
<span class="sd">        bands (List[int], optional): List of band indices (1-based) to use for RGB</span>
<span class="sd">            when the input has more than 3 bands. If None, uses first 3 bands.</span>
<span class="sd">        batch_size (int): Number of tiles to process at once (future use).</span>
<span class="sd">            Defaults to 1.</span>
<span class="sd">        verbose (bool): Whether to print progress information. Defaults to True.</span>
<span class="sd">        **kwargs: Additional keyword arguments.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the output GeoTIFF file.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_tiled(</span>
<span class="sd">        ...     source=&quot;large_satellite_image.tif&quot;,</span>
<span class="sd">        ...     prompt=&quot;building&quot;,</span>
<span class="sd">        ...     output=&quot;buildings_mask.tif&quot;,</span>
<span class="sd">        ...     tile_size=1024,</span>
<span class="sd">        ...     overlap=128,</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.windows</span><span class="w"> </span><span class="kn">import</span> <span class="n">Window</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source must be a GeoTIFF file for tiled processing.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source file not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tile_size</span> <span class="o">&lt;=</span> <span class="n">overlap</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tile_size must be greater than overlap&quot;</span><span class="p">)</span>

    <span class="c1"># Open the source file to get metadata</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">img_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="n">img_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing image: </span><span class="si">{</span><span class="n">img_width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">img_height</span><span class="si">}</span><span class="s2"> pixels&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tile size: </span><span class="si">{</span><span class="n">tile_size</span><span class="si">}</span><span class="s2">, Overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate the number of tiles</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">tile_size</span> <span class="o">-</span> <span class="n">overlap</span>
    <span class="n">n_tiles_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">img_width</span> <span class="o">-</span> <span class="n">overlap</span> <span class="o">+</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">n_tiles_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">img_height</span> <span class="o">-</span> <span class="n">overlap</span> <span class="o">+</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">n_tiles_x</span> <span class="o">*</span> <span class="n">n_tiles_y</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total tiles to process: </span><span class="si">{</span><span class="n">total_tiles</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_tiles_x</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">n_tiles_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Determine output dtype</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
        <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
        <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
        <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>
        <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">65535</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint32&quot;</span><span class="p">:</span>
        <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>
        <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">4294967295</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>
        <span class="n">max_objects</span> <span class="o">=</span> <span class="mi">4294967295</span>

    <span class="c1"># Create output array in memory (for smaller images) or use memory-mapped file</span>
    <span class="c1"># For very large images, you might want to use rasterio windowed writing</span>
    <span class="n">output_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_dtype</span><span class="p">)</span>

    <span class="c1"># Track unique object IDs across all tiles</span>
    <span class="n">current_max_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_objects</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Process each tile</span>
    <span class="n">tile_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="n">total_tiles</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing tiles&quot;</span><span class="p">,</span>
        <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">tile_idx</span> <span class="ow">in</span> <span class="n">tile_iterator</span><span class="p">:</span>
        <span class="c1"># Calculate tile position</span>
        <span class="n">tile_y</span> <span class="o">=</span> <span class="n">tile_idx</span> <span class="o">//</span> <span class="n">n_tiles_x</span>
        <span class="n">tile_x</span> <span class="o">=</span> <span class="n">tile_idx</span> <span class="o">%</span> <span class="n">n_tiles_x</span>

        <span class="c1"># Calculate window coordinates</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="n">tile_x</span> <span class="o">*</span> <span class="n">step</span>
        <span class="n">y_start</span> <span class="o">=</span> <span class="n">tile_y</span> <span class="o">*</span> <span class="n">step</span>

        <span class="c1"># Ensure we don&#39;t go beyond image bounds</span>
        <span class="n">x_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_start</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">img_width</span><span class="p">)</span>
        <span class="n">y_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_start</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">img_height</span><span class="p">)</span>

        <span class="c1"># Adjust start if we&#39;re at the edge</span>
        <span class="k">if</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span> <span class="o">&lt;</span> <span class="n">tile_size</span> <span class="ow">and</span> <span class="n">x_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span> <span class="o">&lt;</span> <span class="n">tile_size</span> <span class="ow">and</span> <span class="n">y_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">tile_size</span><span class="p">)</span>

        <span class="n">window_width</span> <span class="o">=</span> <span class="n">x_end</span> <span class="o">-</span> <span class="n">x_start</span>
        <span class="n">window_height</span> <span class="o">=</span> <span class="n">y_end</span> <span class="o">-</span> <span class="n">y_start</span>

        <span class="c1"># Read tile from source</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tile_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">tile_data</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">tile_data</span><span class="p">,</span> <span class="n">tile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                    <span class="p">)</span>

        <span class="c1"># Transpose to (height, width, channels)</span>
        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tile_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Normalize to 8-bit</span>
        <span class="n">tile_data</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">tile_data</span> <span class="o">-=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tile_data</span> <span class="o">/=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tile_data</span> <span class="o">*=</span> <span class="mi">255</span>
        <span class="n">tile_image</span> <span class="o">=</span> <span class="n">tile_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Process the tile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set image for the tile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">tile_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">tile_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Don&#39;t need georef for individual tiles</span>

            <span class="c1"># Initialize inference state for this tile</span>
            <span class="n">pil_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">tile_image</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span> <span class="o">=</span> <span class="n">pil_image</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">pil_image</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For transformers backend, process directly</span>
                <span class="k">pass</span>

            <span class="c1"># Generate masks for this tile (quiet=True to avoid per-tile messages)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_masks</span><span class="p">(</span>
                <span class="n">prompt</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Get masks for this tile</span>
            <span class="n">tile_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span>

            <span class="k">if</span> <span class="n">tile_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_masks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Create a mask array for this tile</span>
                <span class="n">tile_mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_dtype</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">tile_masks</span><span class="p">:</span>
                    <span class="c1"># Convert mask to numpy</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Resize mask to tile size if needed</span>
                    <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">window_height</span><span class="p">,</span> <span class="n">window_width</span><span class="p">):</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                            <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">window_width</span><span class="p">,</span> <span class="n">window_height</span><span class="p">),</span>
                            <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

                    <span class="c1"># Filter by size</span>
                    <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
                        <span class="n">current_max_id</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">current_max_id</span> <span class="o">&gt;</span> <span class="n">max_objects</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Maximum number of objects (</span><span class="si">{</span><span class="n">max_objects</span><span class="si">}</span><span class="s2">) exceeded. &quot;</span>
                                <span class="s2">&quot;Consider using a larger dtype or reducing the number of objects.&quot;</span>
                            <span class="p">)</span>
                        <span class="n">tile_mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_max_id</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tile_mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="n">total_objects</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Merge tile mask into output mask</span>
                <span class="c1"># For overlapping regions, use the tile&#39;s values if they are non-zero</span>
                <span class="c1"># This simple approach works well for most cases</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_merge_tile_mask</span><span class="p">(</span>
                    <span class="n">output_mask</span><span class="p">,</span>
                    <span class="n">tile_mask_array</span><span class="p">,</span>
                    <span class="n">x_start</span><span class="p">,</span>
                    <span class="n">y_start</span><span class="p">,</span>
                    <span class="n">x_end</span><span class="p">,</span>
                    <span class="n">y_end</span><span class="p">,</span>
                    <span class="n">overlap</span><span class="p">,</span>
                    <span class="n">tile_x</span><span class="p">,</span>
                    <span class="n">tile_y</span><span class="p">,</span>
                    <span class="n">n_tiles_x</span><span class="p">,</span>
                    <span class="n">n_tiles_y</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to process tile (</span><span class="si">{</span><span class="n">tile_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">tile_y</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Clear GPU memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;inference_state&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Additionally clear PyTorch CUDA cache, if available, to free GPU memory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># If torch is not installed, skip CUDA cache clearing</span>
            <span class="k">pass</span>
    <span class="c1"># Update output profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
            <span class="s2">&quot;compress&quot;</span><span class="p">:</span> <span class="s2">&quot;deflate&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Save the output</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved mask to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total objects found: </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Store result for potential visualization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">output_mask</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.predict_inst" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_inst</span><span class="p">(</span><span class="n">point_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multimask_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.predict_inst" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Predict masks for the given input prompts using SAM3's interactive instance
segmentation (SAM1-style task). This enables point and box prompts for
precise object segmentation.</p>
<p>Note: This method requires the model to be initialized with
<code>enable_inst_interactivity=True</code> (Meta backend only).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>point_coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Nx2 array or list of point
prompts to the model. Each point is in (X, Y) pixel coordinates.
Can be a numpy array or a Python list like [[x1, y1], [x2, y2]].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_labels</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A length N array or list of
labels for the point prompts. 1 indicates a foreground point and
0 indicates a background point.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A length 4 array/list or Bx4 array/list
of box prompt(s) to the model, in XYXY format.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_input</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A low resolution mask input to the
model, typically coming from a previous prediction iteration.
Has form 1xHxW (or BxHxW for batched), where H=W=256 for SAM.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multimask_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the model will return three masks.
For ambiguous input prompts (such as a single click), this will
often produce better masks than a single prediction. If only a
single mask is needed, the model's predicted quality score can
be used to select the best mask. For non-ambiguous prompts, such
as multiple input prompts, multimask_output=False can give
better results. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_logits</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns un-thresholded mask logits
instead of binary masks. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>normalize_coords</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the point coordinates will be
normalized to the range [0, 1] and point_coords is expected to
be w.r.t. image dimensions. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for point
coordinates (e.g., "EPSG:4326"). Only used if the source image
is a GeoTIFF. If None, points are in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for box
coordinates (e.g., "EPSG:4326"). Only used if the source image
is a GeoTIFF. If None, box is in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[np.ndarray, np.ndarray, np.ndarray]:
- masks: The output masks in CxHxW format (or BxCxHxW for batched
  box input), where C is the number of masks, and (H, W) is the
  original image size.
- scores: An array of length C (or BxC) containing the model's
  predictions for the quality of each mask.
- logits: An array of shape CxHxW (or BxCxHxW), where C is the
  number of masks and H=W=256. These low resolution logits can
  be passed to a subsequent iteration as mask input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst--initialize-with-instance-interactivity-enabled">Initialize with instance interactivity enabled<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst--initialize-with-instance-interactivity-enabled" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)
sam.set_image("image.jpg")</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst--single-point-prompt">Single point prompt<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst--single-point-prompt" title="Permanent link">&para;</a></h4>
<p>point_coords = np.array([[520, 375]])
point_labels = np.array([1])
masks, scores, logits = sam.predict_inst(
...     point_coords=point_coords,
...     point_labels=point_labels,
...     multimask_output=True,
... )</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst--select-best-mask-based-on-score">Select best mask based on score<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst--select-best-mask-based-on-score" title="Permanent link">&para;</a></h4>
<p>best_mask_idx = np.argmax(scores)
best_mask = masks[best_mask_idx]</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst--refine-with-additional-points">Refine with additional points<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst--refine-with-additional-points" title="Permanent link">&para;</a></h4>
<p>point_coords = np.array([[500, 375], [1125, 625]])
point_labels = np.array([1, 0])  # foreground and background
masks, scores, logits = sam.predict_inst(
...     point_coords=point_coords,
...     point_labels=point_labels,
...     mask_input=logits[best_mask_idx:best_mask_idx+1],  # Use previous best
...     multimask_output=False,
... )</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst--box-prompt">Box prompt<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst--box-prompt" title="Permanent link">&para;</a></h4>
<p>box = np.array([425, 600, 700, 875])
masks, scores, logits = sam.predict_inst(box=box, multimask_output=False)</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst--combined-box-and-point-prompt">Combined box and point prompt<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst--combined-box-and-point-prompt" title="Permanent link">&para;</a></h4>
<p>box = np.array([425, 600, 700, 875])
point_coords = np.array([[575, 750]])
point_labels = np.array([0])  # Exclude this region
masks, scores, logits = sam.predict_inst(
...     point_coords=point_coords,
...     point_labels=point_labels,
...     box=box,
...     multimask_output=False,
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_inst</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">point_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">box</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">normalize_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predict masks for the given input prompts using SAM3&#39;s interactive instance</span>
<span class="sd">    segmentation (SAM1-style task). This enables point and box prompts for</span>
<span class="sd">    precise object segmentation.</span>

<span class="sd">    Note: This method requires the model to be initialized with</span>
<span class="sd">    `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coords (np.ndarray or List, optional): A Nx2 array or list of point</span>
<span class="sd">            prompts to the model. Each point is in (X, Y) pixel coordinates.</span>
<span class="sd">            Can be a numpy array or a Python list like [[x1, y1], [x2, y2]].</span>
<span class="sd">        point_labels (np.ndarray or List, optional): A length N array or list of</span>
<span class="sd">            labels for the point prompts. 1 indicates a foreground point and</span>
<span class="sd">            0 indicates a background point.</span>
<span class="sd">        box (np.ndarray or List, optional): A length 4 array/list or Bx4 array/list</span>
<span class="sd">            of box prompt(s) to the model, in XYXY format.</span>
<span class="sd">        mask_input (np.ndarray, optional): A low resolution mask input to the</span>
<span class="sd">            model, typically coming from a previous prediction iteration.</span>
<span class="sd">            Has form 1xHxW (or BxHxW for batched), where H=W=256 for SAM.</span>
<span class="sd">        multimask_output (bool): If True, the model will return three masks.</span>
<span class="sd">            For ambiguous input prompts (such as a single click), this will</span>
<span class="sd">            often produce better masks than a single prediction. If only a</span>
<span class="sd">            single mask is needed, the model&#39;s predicted quality score can</span>
<span class="sd">            be used to select the best mask. For non-ambiguous prompts, such</span>
<span class="sd">            as multiple input prompts, multimask_output=False can give</span>
<span class="sd">            better results. Defaults to True.</span>
<span class="sd">        return_logits (bool): If True, returns un-thresholded mask logits</span>
<span class="sd">            instead of binary masks. Defaults to False.</span>
<span class="sd">        normalize_coords (bool): If True, the point coordinates will be</span>
<span class="sd">            normalized to the range [0, 1] and point_coords is expected to</span>
<span class="sd">            be w.r.t. image dimensions. Defaults to True.</span>
<span class="sd">        point_crs (str, optional): Coordinate reference system for point</span>
<span class="sd">            coordinates (e.g., &quot;EPSG:4326&quot;). Only used if the source image</span>
<span class="sd">            is a GeoTIFF. If None, points are in pixel coordinates.</span>
<span class="sd">        box_crs (str, optional): Coordinate reference system for box</span>
<span class="sd">            coordinates (e.g., &quot;EPSG:4326&quot;). Only used if the source image</span>
<span class="sd">            is a GeoTIFF. If None, box is in pixel coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
<span class="sd">            - masks: The output masks in CxHxW format (or BxCxHxW for batched</span>
<span class="sd">              box input), where C is the number of masks, and (H, W) is the</span>
<span class="sd">              original image size.</span>
<span class="sd">            - scores: An array of length C (or BxC) containing the model&#39;s</span>
<span class="sd">              predictions for the quality of each mask.</span>
<span class="sd">            - logits: An array of shape CxHxW (or BxCxHxW), where C is the</span>
<span class="sd">              number of masks and H=W=256. These low resolution logits can</span>
<span class="sd">              be passed to a subsequent iteration as mask input.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Initialize with instance interactivity enabled</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Single point prompt</span>
<span class="sd">        &gt;&gt;&gt; point_coords = np.array([[520, 375]])</span>
<span class="sd">        &gt;&gt;&gt; point_labels = np.array([1])</span>
<span class="sd">        &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">        ...     point_coords=point_coords,</span>
<span class="sd">        ...     point_labels=point_labels,</span>
<span class="sd">        ...     multimask_output=True,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Select best mask based on score</span>
<span class="sd">        &gt;&gt;&gt; best_mask_idx = np.argmax(scores)</span>
<span class="sd">        &gt;&gt;&gt; best_mask = masks[best_mask_idx]</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Refine with additional points</span>
<span class="sd">        &gt;&gt;&gt; point_coords = np.array([[500, 375], [1125, 625]])</span>
<span class="sd">        &gt;&gt;&gt; point_labels = np.array([1, 0])  # foreground and background</span>
<span class="sd">        &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">        ...     point_coords=point_coords,</span>
<span class="sd">        ...     point_labels=point_labels,</span>
<span class="sd">        ...     mask_input=logits[best_mask_idx:best_mask_idx+1],  # Use previous best</span>
<span class="sd">        ...     multimask_output=False,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Box prompt</span>
<span class="sd">        &gt;&gt;&gt; box = np.array([425, 600, 700, 875])</span>
<span class="sd">        &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(box=box, multimask_output=False)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Combined box and point prompt</span>
<span class="sd">        &gt;&gt;&gt; box = np.array([425, 600, 700, 875])</span>
<span class="sd">        &gt;&gt;&gt; point_coords = np.array([[575, 750]])</span>
<span class="sd">        &gt;&gt;&gt; point_labels = np.array([0])  # Exclude this region</span>
<span class="sd">        &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">        ...     point_coords=point_coords,</span>
<span class="sd">        ...     point_labels=point_labels,</span>
<span class="sd">        ...     box=box,</span>
<span class="sd">        ...     multimask_output=False,</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;predict_inst is only available for the Meta backend. &quot;</span>
            <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
            <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Convert lists to numpy arrays</span>
    <span class="k">if</span> <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="c1"># Transform point coordinates from CRS to pixel coordinates if needed</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
        <span class="n">point_coords</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">point_coords</span><span class="p">,</span> <span class="n">point_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Transform box coordinates from CRS to pixel coordinates if needed</span>
    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Single box [xmin, ymin, xmax, ymax]</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
            <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
            <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
            <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">x1_px</span><span class="p">,</span> <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x2_px</span><span class="p">,</span> <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple boxes [B, 4]</span>
            <span class="n">transformed_boxes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">b</span>
                <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
                <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
                <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">x1_px</span><span class="p">,</span> <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x2_px</span><span class="p">,</span> <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">transformed_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                        <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">),</span>
                        <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transformed_boxes</span><span class="p">)</span>

    <span class="c1"># Call the model&#39;s predict_inst method</span>
    <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_inst</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span><span class="p">,</span>
        <span class="n">point_coords</span><span class="o">=</span><span class="n">point_coords</span><span class="p">,</span>
        <span class="n">point_labels</span><span class="o">=</span><span class="n">point_labels</span><span class="p">,</span>
        <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span>
        <span class="n">mask_input</span><span class="o">=</span><span class="n">mask_input</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
        <span class="n">return_logits</span><span class="o">=</span><span class="n">return_logits</span><span class="p">,</span>
        <span class="n">normalize_coords</span><span class="o">=</span><span class="n">normalize_coords</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Store results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span> <span class="k">if</span> <span class="n">masks</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">scores</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span>

    <span class="k">return</span> <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">logits</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.predict_inst_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_inst_batch</span><span class="p">(</span><span class="n">point_coords_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_labels_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_input_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multimask_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.predict_inst_batch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Predict masks for batched input prompts using SAM3's interactive instance
segmentation. This is used when the model is set with multiple images via
<code>set_image_batch()</code>.</p>
<p>Note: This method requires the model to be initialized with
<code>enable_inst_interactivity=True</code> (Meta backend only).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>point_coords_batch</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Nx2 arrays of
point prompts for each image in the batch. Each point is in (X, Y)
pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_labels_batch</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of length N arrays
of labels for the point prompts for each image. 1 indicates a
foreground point and 0 indicates a background point.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_batch</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Bx4 arrays of box
prompts for each image in the batch, in XYXY format.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_input_batch</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of low resolution
mask inputs for each image, typically from previous iterations.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multimask_output</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the model will return three masks
per prompt. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_logits</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns un-thresholded mask logits
instead of binary masks. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>normalize_coords</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, coordinates are normalized to [0, 1].
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>], <span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>], <span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[List[np.ndarray], List[np.ndarray], List[np.ndarray]]:
- masks_batch: List of mask arrays for each image
- scores_batch: List of score arrays for each image
- logits_batch: List of logit arrays for each image</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst_batch--load-batch-of-images">Load batch of images<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--load-batch-of-images" title="Permanent link">&para;</a></h4>
<p>image1 = Image.open("truck.jpg")
image2 = Image.open("groceries.jpg")
sam.set_image_batch([image1, image2])</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst_batch--define-box-prompts-for-each-image">Define box prompts for each image<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--define-box-prompts-for-each-image" title="Permanent link">&para;</a></h4>
<p>image1_boxes = np.array([
...     [75, 275, 1725, 850],
...     [425, 600, 700, 875],
... ])
image2_boxes = np.array([
...     [450, 170, 520, 350],
...     [350, 190, 450, 350],
... ])
boxes_batch = [image1_boxes, image2_boxes]</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst_batch--predict-masks-for-all-images">Predict masks for all images<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--predict-masks-for-all-images" title="Permanent link">&para;</a></h4>
<p>masks_batch, scores_batch, logits_batch = sam.predict_inst_batch(
...     box_batch=boxes_batch,
...     multimask_output=False,
... )</p>
<h4 id="samgeo.samgeo3.SamGeo3.predict_inst_batch--or-use-point-prompts">Or use point prompts<a class="headerlink" href="#samgeo.samgeo3.SamGeo3.predict_inst_batch--or-use-point-prompts" title="Permanent link">&para;</a></h4>
<p>image1_pts = np.array([[[500, 375]], [[650, 750]]])  # Bx1x2
image1_labels = np.array([[1], [1]])
image2_pts = np.array([[[400, 300]], [[630, 300]]])
image2_labels = np.array([[1], [1]])</p>
<p>masks_batch, scores_batch, logits_batch = sam.predict_inst_batch(
...     point_coords_batch=[image1_pts, image2_pts],
...     point_labels_batch=[image1_labels, image2_labels],
...     multimask_output=True,
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_inst_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">point_coords_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_labels_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">box_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_input_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">multimask_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">return_logits</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">normalize_coords</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predict masks for batched input prompts using SAM3&#39;s interactive instance</span>
<span class="sd">    segmentation. This is used when the model is set with multiple images via</span>
<span class="sd">    `set_image_batch()`.</span>

<span class="sd">    Note: This method requires the model to be initialized with</span>
<span class="sd">    `enable_inst_interactivity=True` (Meta backend only).</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coords_batch (List[np.ndarray], optional): List of Nx2 arrays of</span>
<span class="sd">            point prompts for each image in the batch. Each point is in (X, Y)</span>
<span class="sd">            pixel coordinates.</span>
<span class="sd">        point_labels_batch (List[np.ndarray], optional): List of length N arrays</span>
<span class="sd">            of labels for the point prompts for each image. 1 indicates a</span>
<span class="sd">            foreground point and 0 indicates a background point.</span>
<span class="sd">        box_batch (List[np.ndarray], optional): List of Bx4 arrays of box</span>
<span class="sd">            prompts for each image in the batch, in XYXY format.</span>
<span class="sd">        mask_input_batch (List[np.ndarray], optional): List of low resolution</span>
<span class="sd">            mask inputs for each image, typically from previous iterations.</span>
<span class="sd">        multimask_output (bool): If True, the model will return three masks</span>
<span class="sd">            per prompt. Defaults to True.</span>
<span class="sd">        return_logits (bool): If True, returns un-thresholded mask logits</span>
<span class="sd">            instead of binary masks. Defaults to False.</span>
<span class="sd">        normalize_coords (bool): If True, coordinates are normalized to [0, 1].</span>
<span class="sd">            Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[List[np.ndarray], List[np.ndarray], List[np.ndarray]]:</span>
<span class="sd">            - masks_batch: List of mask arrays for each image</span>
<span class="sd">            - scores_batch: List of score arrays for each image</span>
<span class="sd">            - logits_batch: List of logit arrays for each image</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Load batch of images</span>
<span class="sd">        &gt;&gt;&gt; image1 = Image.open(&quot;truck.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; image2 = Image.open(&quot;groceries.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image_batch([image1, image2])</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Define box prompts for each image</span>
<span class="sd">        &gt;&gt;&gt; image1_boxes = np.array([</span>
<span class="sd">        ...     [75, 275, 1725, 850],</span>
<span class="sd">        ...     [425, 600, 700, 875],</span>
<span class="sd">        ... ])</span>
<span class="sd">        &gt;&gt;&gt; image2_boxes = np.array([</span>
<span class="sd">        ...     [450, 170, 520, 350],</span>
<span class="sd">        ...     [350, 190, 450, 350],</span>
<span class="sd">        ... ])</span>
<span class="sd">        &gt;&gt;&gt; boxes_batch = [image1_boxes, image2_boxes]</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Predict masks for all images</span>
<span class="sd">        &gt;&gt;&gt; masks_batch, scores_batch, logits_batch = sam.predict_inst_batch(</span>
<span class="sd">        ...     box_batch=boxes_batch,</span>
<span class="sd">        ...     multimask_output=False,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Or use point prompts</span>
<span class="sd">        &gt;&gt;&gt; image1_pts = np.array([[[500, 375]], [[650, 750]]])  # Bx1x2</span>
<span class="sd">        &gt;&gt;&gt; image1_labels = np.array([[1], [1]])</span>
<span class="sd">        &gt;&gt;&gt; image2_pts = np.array([[[400, 300]], [[630, 300]]])</span>
<span class="sd">        &gt;&gt;&gt; image2_labels = np.array([[1], [1]])</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; masks_batch, scores_batch, logits_batch = sam.predict_inst_batch(</span>
<span class="sd">        ...     point_coords_batch=[image1_pts, image2_pts],</span>
<span class="sd">        ...     point_labels_batch=[image1_labels, image2_labels],</span>
<span class="sd">        ...     multimask_output=True,</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;predict_inst_batch is only available for the Meta backend. &quot;</span>
            <span class="s2">&quot;Please initialize with backend=&#39;meta&#39; and enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No images set for batch processing. &quot;</span>
            <span class="s2">&quot;Please call set_image_batch() first.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;inst_interactive_predictor&quot;</span><span class="p">)</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inst_interactive_predictor</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Instance interactivity not enabled. Please initialize with &quot;</span>
            <span class="s2">&quot;enable_inst_interactivity=True.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Call the model&#39;s predict_inst_batch method</span>
    <span class="n">masks_batch</span><span class="p">,</span> <span class="n">scores_batch</span><span class="p">,</span> <span class="n">logits_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_inst_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span><span class="p">,</span>
        <span class="n">point_coords_batch</span><span class="p">,</span>
        <span class="n">point_labels_batch</span><span class="p">,</span>
        <span class="n">box_batch</span><span class="o">=</span><span class="n">box_batch</span><span class="p">,</span>
        <span class="n">mask_input_batch</span><span class="o">=</span><span class="n">mask_input_batch</span><span class="p">,</span>
        <span class="n">multimask_output</span><span class="o">=</span><span class="n">multimask_output</span><span class="p">,</span>
        <span class="n">return_logits</span><span class="o">=</span><span class="n">return_logits</span><span class="p">,</span>
        <span class="n">normalize_coords</span><span class="o">=</span><span class="n">normalize_coords</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">masks_batch</span><span class="p">,</span> <span class="n">scores_batch</span><span class="p">,</span> <span class="n">logits_batch</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.raster_to_vector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">raster_to_vector</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.raster_to_vector" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert a raster image file to a vector dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raster</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the raster image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output vector file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum allowed geometry displacement.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">raster_to_vector</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raster</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">vector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a raster image file to a vector dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster (str): The path to the raster image.</span>
<span class="sd">        vector (str): The path to the output vector file.</span>
<span class="sd">        simplify_tolerance (float, optional): The maximum allowed geometry displacement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">common</span><span class="o">.</span><span class="n">raster_to_vector</span><span class="p">(</span>
        <span class="n">raster</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.save_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_masks</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">save_scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.save_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save the generated masks to a file or generate mask array for visualization.</p>
<p>If the input image is a GeoTIFF, the output will be saved as a GeoTIFF
with the same georeferencing information. Otherwise, it will be saved as PNG.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output file. If None, only generates
the mask array in memory (self.objects) without saving to disk.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, each mask gets a unique value (1, 2, 3, ...).
If False, all masks are combined into a binary mask (0 or 255).</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels. Masks smaller than this
will be filtered out.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels. Masks larger than
this will be filtered out.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for the output array.</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint8&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_scores</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, saves a confidence score map
to this path. Each pixel will have the confidence score of its mask.
The output format (GeoTIFF or PNG) follows the same logic as the mask output.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to common.array_to_image().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="n">save_scores</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the generated masks to a file or generate mask array for visualization.</span>

<span class="sd">    If the input image is a GeoTIFF, the output will be saved as a GeoTIFF</span>
<span class="sd">    with the same georeferencing information. Otherwise, it will be saved as PNG.</span>

<span class="sd">    Args:</span>
<span class="sd">        output (str, optional): The path to the output file. If None, only generates</span>
<span class="sd">            the mask array in memory (self.objects) without saving to disk.</span>
<span class="sd">        unique (bool): If True, each mask gets a unique value (1, 2, 3, ...).</span>
<span class="sd">            If False, all masks are combined into a binary mask (0 or 255).</span>
<span class="sd">        min_size (int): Minimum mask size in pixels. Masks smaller than this</span>
<span class="sd">            will be filtered out.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels. Masks larger than</span>
<span class="sd">            this will be filtered out.</span>
<span class="sd">        dtype (str): Data type for the output array.</span>
<span class="sd">        save_scores (str, optional): If provided, saves a confidence score map</span>
<span class="sd">            to this path. Each pixel will have the confidence score of its mask.</span>
<span class="sd">            The output format (GeoTIFF or PNG) follows the same logic as the mask output.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to common.array_to_image().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks found. Please run generate_masks() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No scores found. Cannot save scores.&quot;</span><span class="p">)</span>

    <span class="c1"># Create empty array for combined masks</span>
    <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create empty array for scores if requested</span>
    <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scores_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">)</span>

    <span class="c1"># Process each mask</span>
    <span class="n">valid_mask_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mask_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="c1"># Convert mask to numpy array if it&#39;s a tensor</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>

        <span class="c1"># Ensure mask is 2D</span>
        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Convert to boolean</span>
        <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Calculate mask size</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

        <span class="c1"># Filter by size</span>
        <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
            <span class="n">mask_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
            <span class="n">mask_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># Get confidence score for this mask</span>
        <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_index</span><span class="p">],</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_index</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">mask_index</span><span class="p">])</span>

        <span class="c1"># Add mask to array</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
            <span class="c1"># Assign unique value to each mask (starting from 1)</span>
            <span class="n">mask_value</span> <span class="o">=</span> <span class="n">valid_mask_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Binary mask: all foreground pixels are 255</span>
            <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

        <span class="c1"># Add score to scores array</span>
        <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scores_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="n">valid_mask_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">mask_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">valid_mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No masks met the size criteria.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Convert to requested dtype</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint8&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unique</span> <span class="ow">and</span> <span class="n">valid_mask_count</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> masks found, but uint8 can only represent 255 unique values. Consider using dtype=&#39;uint16&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;int32&quot;</span><span class="p">:</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Store the mask array for visualization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">mask_array</span>

    <span class="c1"># Only save to file if output path is provided</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Save using common utility which handles GeoTIFF georeferencing</span>
        <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span>
            <span class="n">mask_array</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> mask(s) to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save scores if requested</span>
        <span class="k">if</span> <span class="n">save_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span>
                <span class="n">scores_array</span><span class="p">,</span> <span class="n">save_scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved confidence scores to </span><span class="si">{</span><span class="n">save_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.save_masks_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_masks_batch</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.save_masks_batch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save masks from batch processing to files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save the mask files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for output filenames. Files will be named
"{prefix}<em index="index">{index}.tif" or "{prefix}</em>.png".</p>
              </div>
            </td>
            <td>
                  <code>&#39;mask&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, each mask gets a unique value (1, 2, 3, ...).
If False, all masks are combined into a binary mask.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum mask size in pixels.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum mask size in pixels.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for the output array.</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint8&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to common.array_to_image().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: List of paths to saved mask files.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3(backend="meta")
sam.set_image_batch(["img1.tif", "img2.tif"])
sam.generate_masks_batch("building")
saved_files = sam.save_masks_batch("output/", prefix="building_mask")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_masks_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mask&quot;</span><span class="p">,</span>
    <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save masks from batch processing to files.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir (str): Directory to save the mask files.</span>
<span class="sd">        prefix (str): Prefix for output filenames. Files will be named</span>
<span class="sd">            &quot;{prefix}_{index}.tif&quot; or &quot;{prefix}_{index}.png&quot;.</span>
<span class="sd">        unique (bool): If True, each mask gets a unique value (1, 2, 3, ...).</span>
<span class="sd">            If False, all masks are combined into a binary mask.</span>
<span class="sd">        min_size (int): Minimum mask size in pixels.</span>
<span class="sd">        max_size (int, optional): Maximum mask size in pixels.</span>
<span class="sd">        dtype (str): Data type for the output array.</span>
<span class="sd">        **kwargs: Additional arguments passed to common.array_to_image().</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: List of paths to saved mask files.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image_batch([&quot;img1.tif&quot;, &quot;img2.tif&quot;])</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks_batch(&quot;building&quot;)</span>
<span class="sd">        &gt;&gt;&gt; saved_files = sam.save_masks_batch(&quot;output/&quot;, prefix=&quot;building_mask&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No batch results found. Please run generate_masks_batch() first.&quot;</span>
        <span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">):</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">masks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No masks for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Get image dimensions</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to get from first mask</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine dimensions for image </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create combined mask array</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
        <span class="p">)</span>

        <span class="n">valid_mask_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
            <span class="c1"># Convert to numpy</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mask</span>

            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">mask_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mask_size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">unique</span><span class="p">:</span>
                <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_mask_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_bool</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

            <span class="n">valid_mask_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">valid_mask_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid masks for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> after filtering.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Convert dtype</span>
        <span class="k">if</span> <span class="n">unique</span> <span class="ow">and</span> <span class="n">valid_mask_count</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> masks exceed </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> range. Consider using uint16 or uint32.&quot;</span>
            <span class="p">)</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Determine output path and extension</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.png&quot;</span>

        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save</span>
        <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span>
            <span class="n">mask_array</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">valid_mask_count</span><span class="si">}</span><span class="s2"> mask(s) for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">saved_files</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.save_prediction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_prediction</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_multiplier</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.save_prediction" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save the predicted mask to the output path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>index</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the mask to save.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_multiplier</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The mask multiplier for the output mask.</p>
              </div>
            </td>
            <td>
                  <code>255</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data type of the output image.</p>
              </div>
            </td>
            <td>
                  <code>&#39;float32&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output vector file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simplify_tolerance</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum allowed geometry displacement.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_prediction</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="n">vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify_tolerance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the predicted mask to the output path.</span>

<span class="sd">    Args:</span>
<span class="sd">        output (str): The path to the output image.</span>
<span class="sd">        index (Optional[int]): The index of the mask to save.</span>
<span class="sd">        mask_multiplier (int): The mask multiplier for the output mask.</span>
<span class="sd">        dtype (str): The data type of the output image.</span>
<span class="sd">        vector (Optional[str]): The path to the output vector file.</span>
<span class="sd">        simplify_tolerance (Optional[float]): The maximum allowed geometry displacement.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No predictions found. Please run predict() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_multiplier</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">=</span> <span class="n">array</span>
    <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">common</span><span class="o">.</span><span class="n">raster_to_vector</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">simplify_tolerance</span><span class="o">=</span><span class="n">simplify_tolerance</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.set_confidence_threshold" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_confidence_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.set_confidence_threshold" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Sets the confidence threshold for the masks.
Args:
    threshold (float): The confidence threshold.
    state (optional): An optional state object to pass to the processor's set_confidence_threshold method (Meta backend only).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_confidence_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets the confidence threshold for the masks.</span>
<span class="sd">    Args:</span>
<span class="sd">        threshold (float): The confidence threshold.</span>
<span class="sd">        state (optional): An optional state object to pass to the processor&#39;s set_confidence_threshold method (Meta backend only).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_confidence_threshold</span><span class="p">(</span>
            <span class="n">threshold</span><span class="p">,</span> <span class="n">state</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.set_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.set_image" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set the input image as a numpy array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image">Image</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input image as a path,
a numpy array, or an Image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="optional">optional</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional state object to pass to the processor's set_image method (Meta backend only).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bands</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices (1-based) to use for RGB
when the input is a GeoTIFF with more than 3 bands. For example,
[4, 3, 2] for NIR-R-G false color composite. If None, uses the
first 3 bands for multi-band images. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the input image as a numpy array.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Union[str, np.ndarray, Image]): The input image as a path,</span>
<span class="sd">            a numpy array, or an Image.</span>
<span class="sd">        state (optional): An optional state object to pass to the processor&#39;s set_image method (Meta backend only).</span>
<span class="sd">        bands (List[int], optional): List of band indices (1-based) to use for RGB</span>
<span class="sd">            when the input is a GeoTIFF with more than 3 bands. For example,</span>
<span class="sd">            [4, 3, 2] for NIR-R-G false color composite. If None, uses the</span>
<span class="sd">            first 3 bands for multi-band images. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">image</span>

        <span class="c1"># Check if image is a GeoTIFF and handle band selection</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>

            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Validate band indices (1-based)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;bands must contain exactly 3 band indices for RGB.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">band</span> <span class="o">&gt;</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Band index </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s2"> is out of range. &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Image has </span><span class="si">{</span><span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> bands (1-indexed).&quot;</span>
                            <span class="p">)</span>
                    <span class="c1"># Read specified bands (rasterio uses 1-based indexing)</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Read all bands</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="c1"># If more than 3 bands, use first 3</span>
                    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                    <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Repeat the first band to make 3 bands: [band1, band2, band1]</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Transpose from (bands, height, width) to (height, width, bands)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

                <span class="c1"># Normalize to 8-bit (0-255) range</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">-=</span> <span class="n">array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">/=</span> <span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">array</span> <span class="o">*=</span> <span class="mi">255</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Input image must be either a path, numpy array, or PIL Image.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Convert to PIL Image for processing</span>
    <span class="n">image_for_processor</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Set image based on backend</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="c1"># SAM3&#39;s processor expects PIL Image or tensor with (C, H, W) format</span>
        <span class="c1"># Numpy arrays from cv2 have (H, W, C) format which causes incorrect dimension extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span>
            <span class="n">image_for_processor</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transformers</span>
        <span class="c1"># For Transformers backend, we just store the PIL image</span>
        <span class="c1"># Processing will happen during generate_masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pil_image</span> <span class="o">=</span> <span class="n">image_for_processor</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.set_image_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_image_batch</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.set_image_batch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set multiple images for batch processing.</p>
<p>Note: This method is only available for the Meta backend.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>images</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>, <span title="PIL.Image">Image</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of input images.
Each image can be a file path, a numpy array, or a PIL Image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional state object to pass to the
processor's set_image_batch method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3(backend="meta")
sam.set_image_batch(["image1.jpg", "image2.jpg", "image3.jpg"])
results = sam.generate_masks_batch("tree")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_image_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">images</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">]],</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set multiple images for batch processing.</span>

<span class="sd">    Note: This method is only available for the Meta backend.</span>

<span class="sd">    Args:</span>
<span class="sd">        images (List[Union[str, np.ndarray, Image]]): A list of input images.</span>
<span class="sd">            Each image can be a file path, a numpy array, or a PIL Image.</span>
<span class="sd">        state (dict, optional): An optional state object to pass to the</span>
<span class="sd">            processor&#39;s set_image_batch method.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image_batch([&quot;image1.jpg&quot;, &quot;image2.jpg&quot;, &quot;image3.jpg&quot;])</span>
<span class="sd">        &gt;&gt;&gt; results = sam.generate_masks_batch(&quot;tree&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">!=</span> <span class="s2">&quot;meta&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Batch image processing is only available for the Meta backend. &quot;</span>
            <span class="s2">&quot;Use set_image() for the Transformers backend.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;images must be a non-empty list&quot;</span><span class="p">)</span>

    <span class="c1"># Process each image to PIL format</span>
    <span class="n">pil_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">numpy_images</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

            <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
            <span class="n">numpy_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">pil_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">numpy_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">pil_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">numpy_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
            <span class="n">pil_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Each image must be either a path, numpy array, or PIL Image.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Store batch information</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">images_batch</span> <span class="o">=</span> <span class="n">numpy_images</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sources_batch</span> <span class="o">=</span> <span class="n">sources</span>

    <span class="c1"># Call the processor&#39;s set_image_batch method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">set_image_batch</span><span class="p">(</span><span class="n">pil_images</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pil_images</span><span class="p">)</span><span class="si">}</span><span class="s2"> images for batch processing.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_anns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_anns</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">show_bbox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_anns" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show the annotations (objects with random color) on the input image.</p>
<p>This method uses OpenCV for fast rendering, which is significantly faster
than matplotlib when there are many objects to plot.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure size (used for display).</p>
              </div>
            </td>
            <td>
                  <code>(12, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show the axis.</p>
              </div>
            </td>
            <td>
                  <code>&#39;off&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_bbox</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show the bounding box.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_score</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show the score.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output image. If provided, the
figure will be saved instead of displayed.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>blend</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show the input image as background. If False,
only annotations will be shown on a white background.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The alpha value for the annotations.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>font_scale</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The font scale for labels. Defaults to 0.8.</p>
              </div>
            </td>
            <td>
                  <code>0.8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (kept for backward compatibility).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_anns</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">show_bbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">show_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">blend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">font_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show the annotations (objects with random color) on the input image.</span>

<span class="sd">    This method uses OpenCV for fast rendering, which is significantly faster</span>
<span class="sd">    than matplotlib when there are many objects to plot.</span>

<span class="sd">    Args:</span>
<span class="sd">        figsize (tuple): The figure size (used for display).</span>
<span class="sd">        axis (str): Whether to show the axis.</span>
<span class="sd">        show_bbox (bool): Whether to show the bounding box.</span>
<span class="sd">        show_score (bool): Whether to show the score.</span>
<span class="sd">        output (str, optional): The path to the output image. If provided, the</span>
<span class="sd">            figure will be saved instead of displayed.</span>
<span class="sd">        blend (bool): Whether to show the input image as background. If False,</span>
<span class="sd">            only annotations will be shown on a white background.</span>
<span class="sd">        alpha (float): The alpha value for the annotations.</span>
<span class="sd">        font_scale (float): The font scale for labels. Defaults to 0.8.</span>
<span class="sd">        **kwargs: Additional keyword arguments (kept for backward compatibility).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please run set_image() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Create the blended image using OpenCV (much faster than matplotlib)</span>
    <span class="n">blended</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_anns_opencv</span><span class="p">(</span>
        <span class="n">show_bbox</span><span class="o">=</span><span class="n">show_bbox</span><span class="p">,</span>
        <span class="n">show_score</span><span class="o">=</span><span class="n">show_score</span><span class="p">,</span>
        <span class="n">blend</span><span class="o">=</span><span class="n">blend</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Save directly using OpenCV</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved annotations to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Display the image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_image</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_anns_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_anns_batch</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">show_bbox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;anns&#39;</span><span class="p">,</span> <span class="n">blend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_anns_batch" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show annotations for all images in the batch.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size for each subplot.</p>
              </div>
            </td>
            <td>
                  <code>(12, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show axis.</p>
              </div>
            </td>
            <td>
                  <code>&#39;off&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_bbox</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show bounding boxes.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_score</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show confidence scores.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save annotation images.
If None, displays the figure.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for output filenames.</p>
              </div>
            </td>
            <td>
                  <code>&#39;anns&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>blend</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show image as background.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Alpha value for mask overlay.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ncols</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of columns in the grid display.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for saving.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_anns_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">show_bbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">show_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;anns&quot;</span><span class="p">,</span>
    <span class="n">blend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">ncols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show annotations for all images in the batch.</span>

<span class="sd">    Args:</span>
<span class="sd">        figsize (tuple): Figure size for each subplot.</span>
<span class="sd">        axis (str): Whether to show axis.</span>
<span class="sd">        show_bbox (bool): Whether to show bounding boxes.</span>
<span class="sd">        show_score (bool): Whether to show confidence scores.</span>
<span class="sd">        output_dir (str, optional): Directory to save annotation images.</span>
<span class="sd">            If None, displays the figure.</span>
<span class="sd">        prefix (str): Prefix for output filenames.</span>
<span class="sd">        blend (bool): Whether to show image as background.</span>
<span class="sd">        alpha (float): Alpha value for mask overlay.</span>
<span class="sd">        ncols (int): Number of columns in the grid display.</span>
<span class="sd">        **kwargs: Additional arguments for saving.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No batch results found. Please run generate_masks_batch() first.&quot;</span>
        <span class="p">)</span>

    <span class="n">num_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Save each image separately</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_single_ann</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                <span class="n">show_bbox</span><span class="o">=</span><span class="n">show_bbox</span><span class="p">,</span>
                <span class="n">show_score</span><span class="o">=</span><span class="n">show_score</span><span class="p">,</span>
                <span class="n">blend</span><span class="o">=</span><span class="n">blend</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Display in grid</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_images</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">num_images</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_results</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_single_ann</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                <span class="n">show_bbox</span><span class="o">=</span><span class="n">show_bbox</span><span class="p">,</span>
                <span class="n">show_score</span><span class="o">=</span><span class="n">show_score</span><span class="p">,</span>
                <span class="n">blend</span><span class="o">=</span><span class="n">blend</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Hide unused subplots</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_boxes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">positive_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">negative_color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_boxes" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Visualize bounding boxes on the image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>boxes</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of bounding boxes in XYXY format
[[xmin, ymin, xmax, ymax], ...].
If box_crs is None: pixel coordinates.
If box_crs is specified: coordinates in the given CRS.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_labels</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of boolean labels for each box.
True (positive) shown in green, False (negative) shown in red.
If None, all boxes shown in green.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for box coordinates
(e.g., "EPSG:4326"). If None, boxes are in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size for display.</p>
              </div>
            </td>
            <td>
                  <code>(12, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show axis ("on" or "off").</p>
              </div>
            </td>
            <td>
                  <code>&#39;off&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>positive_color</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RGB color for positive boxes.</p>
              </div>
            </td>
            <td>
                  <code>(0, 255, 0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>negative_color</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RGB color for negative boxes.</p>
              </div>
            </td>
            <td>
                  <code>(255, 0, 0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thickness</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line thickness for box borders.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_boxes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">boxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">box_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">positive_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">negative_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">thickness</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize bounding boxes on the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        boxes (List[List[float]]): List of bounding boxes in XYXY format</span>
<span class="sd">            [[xmin, ymin, xmax, ymax], ...].</span>
<span class="sd">            If box_crs is None: pixel coordinates.</span>
<span class="sd">            If box_crs is specified: coordinates in the given CRS.</span>
<span class="sd">        box_labels (List[bool], optional): List of boolean labels for each box.</span>
<span class="sd">            True (positive) shown in green, False (negative) shown in red.</span>
<span class="sd">            If None, all boxes shown in green.</span>
<span class="sd">        box_crs (str, optional): Coordinate reference system for box coordinates</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot;). If None, boxes are in pixel coordinates.</span>
<span class="sd">        figsize (Tuple[int, int]): Figure size for display.</span>
<span class="sd">        axis (str): Whether to show axis (&quot;on&quot; or &quot;off&quot;).</span>
<span class="sd">        positive_color (Tuple[int, int, int]): RGB color for positive boxes.</span>
<span class="sd">        negative_color (Tuple[int, int, int]): RGB color for negative boxes.</span>
<span class="sd">        thickness (int): Line thickness for box borders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">box_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">box_labels</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

    <span class="c1"># Transform boxes from CRS to pixel coordinates if needed</span>
    <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pixel_boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>

            <span class="c1"># Transform min corner</span>
            <span class="n">min_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]])</span>
            <span class="n">min_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">min_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Transform max corner</span>
            <span class="n">max_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
            <span class="n">max_xy</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">max_coords</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Convert to pixel coordinates and ensure correct min/max order</span>
            <span class="c1"># (geographic y increases north, pixel y increases down)</span>
            <span class="n">x1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y1_px</span> <span class="o">=</span> <span class="n">min_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y2_px</span> <span class="o">=</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Ensure we have correct min/max values</span>
            <span class="n">x_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
            <span class="n">y_min_px</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>
            <span class="n">x_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1_px</span><span class="p">,</span> <span class="n">x2_px</span><span class="p">)</span>
            <span class="n">y_max_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1_px</span><span class="p">,</span> <span class="n">y2_px</span><span class="p">)</span>

            <span class="n">pixel_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_min_px</span><span class="p">,</span> <span class="n">y_min_px</span><span class="p">,</span> <span class="n">x_max_px</span><span class="p">,</span> <span class="n">y_max_px</span><span class="p">])</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="n">pixel_boxes</span>

    <span class="c1"># Convert image to PIL if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>

    <span class="c1"># Draw each box</span>
    <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">box_labels</span><span class="p">):</span>
        <span class="c1"># Convert XYXY to XYWH for drawing</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">box</span>
        <span class="n">box_xywh</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">]</span>

        <span class="c1"># Choose color based on label</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">positive_color</span> <span class="k">if</span> <span class="n">label</span> <span class="k">else</span> <span class="n">negative_color</span>

        <span class="c1"># Draw box</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">draw_box_on_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">box_xywh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">thickness</span><span class="p">)</span>

    <span class="c1"># Display</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_canvas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_canvas</span><span class="p">(</span><span class="n">fg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_canvas" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show a canvas to collect foreground and background points.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fg_color</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The color for foreground points.</p>
              </div>
            </td>
            <td>
                  <code>(0, 255, 0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bg_color</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The color for background points.</p>
              </div>
            </td>
            <td>
                  <code>(0, 0, 255)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>radius</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The radius of the points.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="list">list</span>, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of foreground and background points.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_canvas</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">fg_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">bg_color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show a canvas to collect foreground and background points.</span>

<span class="sd">    Args:</span>
<span class="sd">        fg_color (Tuple[int, int, int]): The color for foreground points.</span>
<span class="sd">        bg_color (Tuple[int, int, int]): The color for background points.</span>
<span class="sd">        radius (int): The radius of the points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of foreground and background points.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please run set_image() first.&quot;</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
    <span class="n">fg_points</span><span class="p">,</span> <span class="n">bg_points</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">show_canvas</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fg_points</span> <span class="o">=</span> <span class="n">fg_points</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bg_points</span> <span class="o">=</span> <span class="n">bg_points</span>
    <span class="n">point_coords</span> <span class="o">=</span> <span class="n">fg_points</span> <span class="o">+</span> <span class="n">bg_points</span>
    <span class="n">point_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fg_points</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg_points</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">point_coords</span> <span class="o">=</span> <span class="n">point_coords</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">point_labels</span> <span class="o">=</span> <span class="n">point_labels</span>

    <span class="k">return</span> <span class="n">fg_points</span><span class="p">,</span> <span class="n">bg_points</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_inst_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_inst_masks</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">point_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">borders</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_inst_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Display masks from predict_inst results with optional point and box overlays.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>masks</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Masks from predict_inst, shape CxHxW.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scores</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scores from predict_inst, shape C.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Point coordinates used for prompts.
Can be a numpy array or a Python list like [[x1, y1], [x2, y2]].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_labels</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Point labels (1=foreground, 0=background).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_coords</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> or <span title="typing.List">List</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Box coordinates used for prompt.
Can be a numpy array or a Python list like [x1, y1, x2, y2].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size for each mask display.</p>
              </div>
            </td>
            <td>
                  <code>(10, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>borders</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to draw contour borders on masks.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3(backend="meta", enable_inst_interactivity=True)
sam.set_image("image.jpg")
masks, scores, logits = sam.predict_inst(
...     point_coords=[[520, 375]],
...     point_labels=[1],
... )
sam.show_inst_masks(
...     masks, scores,
...     point_coords=[[520, 375]],
...     point_labels=[1],
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span>
<span class="normal">3660</span>
<span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span>
<span class="normal">3669</span>
<span class="normal">3670</span>
<span class="normal">3671</span>
<span class="normal">3672</span>
<span class="normal">3673</span>
<span class="normal">3674</span>
<span class="normal">3675</span>
<span class="normal">3676</span>
<span class="normal">3677</span>
<span class="normal">3678</span>
<span class="normal">3679</span>
<span class="normal">3680</span>
<span class="normal">3681</span>
<span class="normal">3682</span>
<span class="normal">3683</span>
<span class="normal">3684</span>
<span class="normal">3685</span>
<span class="normal">3686</span>
<span class="normal">3687</span>
<span class="normal">3688</span>
<span class="normal">3689</span>
<span class="normal">3690</span>
<span class="normal">3691</span>
<span class="normal">3692</span>
<span class="normal">3693</span>
<span class="normal">3694</span>
<span class="normal">3695</span>
<span class="normal">3696</span>
<span class="normal">3697</span>
<span class="normal">3698</span>
<span class="normal">3699</span>
<span class="normal">3700</span>
<span class="normal">3701</span>
<span class="normal">3702</span>
<span class="normal">3703</span>
<span class="normal">3704</span>
<span class="normal">3705</span>
<span class="normal">3706</span>
<span class="normal">3707</span>
<span class="normal">3708</span>
<span class="normal">3709</span>
<span class="normal">3710</span>
<span class="normal">3711</span>
<span class="normal">3712</span>
<span class="normal">3713</span>
<span class="normal">3714</span>
<span class="normal">3715</span>
<span class="normal">3716</span>
<span class="normal">3717</span>
<span class="normal">3718</span>
<span class="normal">3719</span>
<span class="normal">3720</span>
<span class="normal">3721</span>
<span class="normal">3722</span>
<span class="normal">3723</span>
<span class="normal">3724</span>
<span class="normal">3725</span>
<span class="normal">3726</span>
<span class="normal">3727</span>
<span class="normal">3728</span>
<span class="normal">3729</span>
<span class="normal">3730</span>
<span class="normal">3731</span>
<span class="normal">3732</span>
<span class="normal">3733</span>
<span class="normal">3734</span>
<span class="normal">3735</span>
<span class="normal">3736</span>
<span class="normal">3737</span>
<span class="normal">3738</span>
<span class="normal">3739</span>
<span class="normal">3740</span>
<span class="normal">3741</span>
<span class="normal">3742</span>
<span class="normal">3743</span>
<span class="normal">3744</span>
<span class="normal">3745</span>
<span class="normal">3746</span>
<span class="normal">3747</span>
<span class="normal">3748</span>
<span class="normal">3749</span>
<span class="normal">3750</span>
<span class="normal">3751</span>
<span class="normal">3752</span>
<span class="normal">3753</span>
<span class="normal">3754</span>
<span class="normal">3755</span>
<span class="normal">3756</span>
<span class="normal">3757</span>
<span class="normal">3758</span>
<span class="normal">3759</span>
<span class="normal">3760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_inst_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">masks</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">point_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">box_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">borders</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display masks from predict_inst results with optional point and box overlays.</span>

<span class="sd">    Args:</span>
<span class="sd">        masks (np.ndarray): Masks from predict_inst, shape CxHxW.</span>
<span class="sd">        scores (np.ndarray): Scores from predict_inst, shape C.</span>
<span class="sd">        point_coords (np.ndarray or List, optional): Point coordinates used for prompts.</span>
<span class="sd">            Can be a numpy array or a Python list like [[x1, y1], [x2, y2]].</span>
<span class="sd">        point_labels (np.ndarray or List, optional): Point labels (1=foreground, 0=background).</span>
<span class="sd">        box_coords (np.ndarray or List, optional): Box coordinates used for prompt.</span>
<span class="sd">            Can be a numpy array or a Python list like [x1, y1, x2, y2].</span>
<span class="sd">        figsize (Tuple[int, int]): Figure size for each mask display.</span>
<span class="sd">        borders (bool): Whether to draw contour borders on masks.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3(backend=&quot;meta&quot;, enable_inst_interactivity=True)</span>
<span class="sd">        &gt;&gt;&gt; sam.set_image(&quot;image.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; masks, scores, logits = sam.predict_inst(</span>
<span class="sd">        ...     point_coords=[[520, 375]],</span>
<span class="sd">        ...     point_labels=[1],</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; sam.show_inst_masks(</span>
<span class="sd">        ...     masks, scores,</span>
<span class="sd">        ...     point_coords=[[520, 375]],</span>
<span class="sd">        ...     point_labels=[1],</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="c1"># Convert lists to numpy arrays</span>
    <span class="k">if</span> <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box_coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">box_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box_coords</span><span class="p">)</span>

    <span class="c1"># Sort by score (descending)</span>
    <span class="n">sorted_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">sorted_ind</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">sorted_ind</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">scores</span><span class="p">)):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Show mask</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">mask_uint8</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">30</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">144</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_uint8</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">borders</span><span class="p">:</span>
            <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
                <span class="n">mask_uint8</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_NONE</span>
            <span class="p">)</span>
            <span class="n">contours</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span>
            <span class="p">]</span>
            <span class="n">mask_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span>
                <span class="n">mask_image</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>

        <span class="c1"># Show points if provided</span>
        <span class="k">if</span> <span class="n">point_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos_points</span> <span class="o">=</span> <span class="n">point_coords</span><span class="p">[</span><span class="n">point_labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">neg_points</span> <span class="o">=</span> <span class="n">point_coords</span><span class="p">[</span><span class="n">point_labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">pos_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">pos_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">neg_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">neg_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">375</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Show box if provided</span>
        <span class="k">if</span> <span class="n">box_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">box_w</span><span class="p">,</span> <span class="n">box_h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">box_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">box_coords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span>
                    <span class="n">box_w</span><span class="p">,</span>
                    <span class="n">box_h</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Score: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_map</span><span class="p">(</span><span class="n">basemap</span><span class="o">=</span><span class="s1">&#39;Esri.WorldImagery&#39;</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_map" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show the interactive map.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>basemap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The basemap. Valid options include "Esri.WorldImagery", "OpenStreetMap", "HYBRID", "ROADMAP", "TERRAIN", etc. See the leafmap documentation for a full list of supported basemaps.</p>
              </div>
            </td>
            <td>
                  <code>&#39;Esri.WorldImagery&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the output directory. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum size of the object. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum size of the object. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prompt type. Defaults to "text".
Valid options include "text" and "point".</p>
              </div>
            </td>
            <td>
                  <code>&#39;text&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>leafmap.Map: The map object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_map</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">basemap</span><span class="o">=</span><span class="s2">&quot;Esri.WorldImagery&quot;</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show the interactive map.</span>

<span class="sd">    Args:</span>
<span class="sd">        basemap (str, optional): The basemap. Valid options include &quot;Esri.WorldImagery&quot;, &quot;OpenStreetMap&quot;, &quot;HYBRID&quot;, &quot;ROADMAP&quot;, &quot;TERRAIN&quot;, etc. See the leafmap documentation for a full list of supported basemaps.</span>
<span class="sd">        out_dir (str, optional): The path to the output directory. Defaults to None.</span>
<span class="sd">        min_size (int, optional): The minimum size of the object. Defaults to 10.</span>
<span class="sd">        max_size (int, optional): The maximum size of the object. Defaults to None.</span>
<span class="sd">        prompt (str, optional): The prompt type. Defaults to &quot;text&quot;.</span>
<span class="sd">            Valid options include &quot;text&quot; and &quot;point&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        leafmap.Map: The map object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">text_sam_gui</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">basemap</span><span class="o">=</span><span class="n">basemap</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
            <span class="n">box_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span><span class="p">,</span>
            <span class="n">text_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
            <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">sam_map_gui</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">basemap</span><span class="o">=</span><span class="n">basemap</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
            <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid prompt: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">. Please use &#39;text&#39; or &#39;point&#39;.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_masks</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;tab20&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show the binary mask or the mask of objects with unique values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The figure size.</p>
              </div>
            </td>
            <td>
                  <code>(12, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmap</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The colormap. Default is "tab20" for showing unique objects.
Use "binary_r" for binary masks when unique=False.
Other good options: "viridis", "nipy_spectral", "rainbow".</p>
              </div>
            </td>
            <td>
                  <code>&#39;tab20&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show the axis.</p>
              </div>
            </td>
            <td>
                  <code>&#39;off&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unique</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, each mask gets a unique color value. If False, binary mask.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to save_masks() for filtering
(e.g., min_size, max_size, dtype).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show the binary mask or the mask of objects with unique values.</span>

<span class="sd">    Args:</span>
<span class="sd">        figsize (tuple): The figure size.</span>
<span class="sd">        cmap (str): The colormap. Default is &quot;tab20&quot; for showing unique objects.</span>
<span class="sd">            Use &quot;binary_r&quot; for binary masks when unique=False.</span>
<span class="sd">            Other good options: &quot;viridis&quot;, &quot;nipy_spectral&quot;, &quot;rainbow&quot;.</span>
<span class="sd">        axis (str): Whether to show the axis.</span>
<span class="sd">        unique (bool): If True, each mask gets a unique color value. If False, binary mask.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to save_masks() for filtering</span>
<span class="sd">            (e.g., min_size, max_size, dtype).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Always regenerate mask array to ensure it matches the unique parameter</span>
    <span class="c1"># This prevents showing stale cached binary masks when unique=True is requested</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># save_masks would have printed a message if no masks met criteria</span>
        <span class="k">return</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3.show_points" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_points</span><span class="p">(</span><span class="n">point_coords</span><span class="p">,</span> <span class="n">point_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">foreground_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">375</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3.show_points" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Visualize point prompts on the image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>point_coords</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of point coordinates [[x, y], ...].
If point_crs is None: pixel coordinates.
If point_crs is specified: coordinates in the given CRS.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_labels</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of labels for each point.
1 = foreground (shown in green), 0 = background (shown in red).
If None, all points shown as foreground.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for point coordinates
(e.g., "EPSG:4326"). If None, points are in pixel coordinates.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size for display.</p>
              </div>
            </td>
            <td>
                  <code>(12, 10)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show axis ("on" or "off").</p>
              </div>
            </td>
            <td>
                  <code>&#39;off&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>foreground_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color for foreground points (label=1).</p>
              </div>
            </td>
            <td>
                  <code>&#39;green&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>background_color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Color for background points (label=0).</p>
              </div>
            </td>
            <td>
                  <code>&#39;red&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>marker</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Marker style for points.</p>
              </div>
            </td>
            <td>
                  <code>&#39;*&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>marker_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the markers.</p>
              </div>
            </td>
            <td>
                  <code>375</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>sam.show_points([[520, 375]], [1])  # Single foreground point
sam.show_points([[500, 375], [600, 400]], [1, 0])  # Mixed points</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_points</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">point_coords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">point_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">foreground_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="n">background_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">marker_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">375</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize point prompts on the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coords (List[List[float]]): List of point coordinates [[x, y], ...].</span>
<span class="sd">            If point_crs is None: pixel coordinates.</span>
<span class="sd">            If point_crs is specified: coordinates in the given CRS.</span>
<span class="sd">        point_labels (List[int], optional): List of labels for each point.</span>
<span class="sd">            1 = foreground (shown in green), 0 = background (shown in red).</span>
<span class="sd">            If None, all points shown as foreground.</span>
<span class="sd">        point_crs (str, optional): Coordinate reference system for point coordinates</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot;). If None, points are in pixel coordinates.</span>
<span class="sd">        figsize (Tuple[int, int]): Figure size for display.</span>
<span class="sd">        axis (str): Whether to show axis (&quot;on&quot; or &quot;off&quot;).</span>
<span class="sd">        foreground_color (str): Color for foreground points (label=1).</span>
<span class="sd">        background_color (str): Color for background points (label=0).</span>
<span class="sd">        marker (str): Marker style for points.</span>
<span class="sd">        marker_size (int): Size of the markers.</span>

<span class="sd">    Example:</span>
<span class="sd">        sam.show_points([[520, 375]], [1])  # Single foreground point</span>
<span class="sd">        sam.show_points([[500, 375], [600, 400]], [1, 0])  # Mixed points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No image set. Please call set_image() first.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">point_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">point_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>

    <span class="c1"># Convert to numpy arrays</span>
    <span class="n">point_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_coords</span><span class="p">)</span>
    <span class="n">point_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_labels</span><span class="p">)</span>

    <span class="c1"># Transform points from CRS to pixel coordinates if needed</span>
    <span class="k">if</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">point_coords</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">point_coords</span><span class="p">,</span> <span class="n">point_crs</span><span class="p">,</span> <span class="n">return_out_of_bounds</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Display image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Plot foreground points</span>
    <span class="n">fg_mask</span> <span class="o">=</span> <span class="n">point_labels</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fg_mask</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">point_coords</span><span class="p">[</span><span class="n">fg_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">point_coords</span><span class="p">[</span><span class="n">fg_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">foreground_color</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Plot background points</span>
    <span class="n">bg_mask</span> <span class="o">=</span> <span class="n">point_labels</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bg_mask</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">point_coords</span><span class="p">[</span><span class="n">bg_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">point_coords</span><span class="p">[</span><span class="n">bg_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">background_color</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">marker_size</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="samgeo.samgeo3.SamGeo3Video" class="doc doc-heading">
            <code>SamGeo3Video</code>


<a href="#samgeo.samgeo3.SamGeo3Video" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Video segmentation and tracking with SAM3 for geospatial data.</p>
<p>This class provides a simplified API for segmenting and tracking objects
in videos or time series remote sensing images using SAM3.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from samgeo.samgeo3 import SamGeo3Video
sam = SamGeo3Video()
sam.set_video("path/to/video.mp4")  # or path to image sequence
sam.generate_masks("person")  # text prompt
sam.save_masks("output/")
sam.save_video("output.mp4")
sam.close()</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3916</span>
<span class="normal">3917</span>
<span class="normal">3918</span>
<span class="normal">3919</span>
<span class="normal">3920</span>
<span class="normal">3921</span>
<span class="normal">3922</span>
<span class="normal">3923</span>
<span class="normal">3924</span>
<span class="normal">3925</span>
<span class="normal">3926</span>
<span class="normal">3927</span>
<span class="normal">3928</span>
<span class="normal">3929</span>
<span class="normal">3930</span>
<span class="normal">3931</span>
<span class="normal">3932</span>
<span class="normal">3933</span>
<span class="normal">3934</span>
<span class="normal">3935</span>
<span class="normal">3936</span>
<span class="normal">3937</span>
<span class="normal">3938</span>
<span class="normal">3939</span>
<span class="normal">3940</span>
<span class="normal">3941</span>
<span class="normal">3942</span>
<span class="normal">3943</span>
<span class="normal">3944</span>
<span class="normal">3945</span>
<span class="normal">3946</span>
<span class="normal">3947</span>
<span class="normal">3948</span>
<span class="normal">3949</span>
<span class="normal">3950</span>
<span class="normal">3951</span>
<span class="normal">3952</span>
<span class="normal">3953</span>
<span class="normal">3954</span>
<span class="normal">3955</span>
<span class="normal">3956</span>
<span class="normal">3957</span>
<span class="normal">3958</span>
<span class="normal">3959</span>
<span class="normal">3960</span>
<span class="normal">3961</span>
<span class="normal">3962</span>
<span class="normal">3963</span>
<span class="normal">3964</span>
<span class="normal">3965</span>
<span class="normal">3966</span>
<span class="normal">3967</span>
<span class="normal">3968</span>
<span class="normal">3969</span>
<span class="normal">3970</span>
<span class="normal">3971</span>
<span class="normal">3972</span>
<span class="normal">3973</span>
<span class="normal">3974</span>
<span class="normal">3975</span>
<span class="normal">3976</span>
<span class="normal">3977</span>
<span class="normal">3978</span>
<span class="normal">3979</span>
<span class="normal">3980</span>
<span class="normal">3981</span>
<span class="normal">3982</span>
<span class="normal">3983</span>
<span class="normal">3984</span>
<span class="normal">3985</span>
<span class="normal">3986</span>
<span class="normal">3987</span>
<span class="normal">3988</span>
<span class="normal">3989</span>
<span class="normal">3990</span>
<span class="normal">3991</span>
<span class="normal">3992</span>
<span class="normal">3993</span>
<span class="normal">3994</span>
<span class="normal">3995</span>
<span class="normal">3996</span>
<span class="normal">3997</span>
<span class="normal">3998</span>
<span class="normal">3999</span>
<span class="normal">4000</span>
<span class="normal">4001</span>
<span class="normal">4002</span>
<span class="normal">4003</span>
<span class="normal">4004</span>
<span class="normal">4005</span>
<span class="normal">4006</span>
<span class="normal">4007</span>
<span class="normal">4008</span>
<span class="normal">4009</span>
<span class="normal">4010</span>
<span class="normal">4011</span>
<span class="normal">4012</span>
<span class="normal">4013</span>
<span class="normal">4014</span>
<span class="normal">4015</span>
<span class="normal">4016</span>
<span class="normal">4017</span>
<span class="normal">4018</span>
<span class="normal">4019</span>
<span class="normal">4020</span>
<span class="normal">4021</span>
<span class="normal">4022</span>
<span class="normal">4023</span>
<span class="normal">4024</span>
<span class="normal">4025</span>
<span class="normal">4026</span>
<span class="normal">4027</span>
<span class="normal">4028</span>
<span class="normal">4029</span>
<span class="normal">4030</span>
<span class="normal">4031</span>
<span class="normal">4032</span>
<span class="normal">4033</span>
<span class="normal">4034</span>
<span class="normal">4035</span>
<span class="normal">4036</span>
<span class="normal">4037</span>
<span class="normal">4038</span>
<span class="normal">4039</span>
<span class="normal">4040</span>
<span class="normal">4041</span>
<span class="normal">4042</span>
<span class="normal">4043</span>
<span class="normal">4044</span>
<span class="normal">4045</span>
<span class="normal">4046</span>
<span class="normal">4047</span>
<span class="normal">4048</span>
<span class="normal">4049</span>
<span class="normal">4050</span>
<span class="normal">4051</span>
<span class="normal">4052</span>
<span class="normal">4053</span>
<span class="normal">4054</span>
<span class="normal">4055</span>
<span class="normal">4056</span>
<span class="normal">4057</span>
<span class="normal">4058</span>
<span class="normal">4059</span>
<span class="normal">4060</span>
<span class="normal">4061</span>
<span class="normal">4062</span>
<span class="normal">4063</span>
<span class="normal">4064</span>
<span class="normal">4065</span>
<span class="normal">4066</span>
<span class="normal">4067</span>
<span class="normal">4068</span>
<span class="normal">4069</span>
<span class="normal">4070</span>
<span class="normal">4071</span>
<span class="normal">4072</span>
<span class="normal">4073</span>
<span class="normal">4074</span>
<span class="normal">4075</span>
<span class="normal">4076</span>
<span class="normal">4077</span>
<span class="normal">4078</span>
<span class="normal">4079</span>
<span class="normal">4080</span>
<span class="normal">4081</span>
<span class="normal">4082</span>
<span class="normal">4083</span>
<span class="normal">4084</span>
<span class="normal">4085</span>
<span class="normal">4086</span>
<span class="normal">4087</span>
<span class="normal">4088</span>
<span class="normal">4089</span>
<span class="normal">4090</span>
<span class="normal">4091</span>
<span class="normal">4092</span>
<span class="normal">4093</span>
<span class="normal">4094</span>
<span class="normal">4095</span>
<span class="normal">4096</span>
<span class="normal">4097</span>
<span class="normal">4098</span>
<span class="normal">4099</span>
<span class="normal">4100</span>
<span class="normal">4101</span>
<span class="normal">4102</span>
<span class="normal">4103</span>
<span class="normal">4104</span>
<span class="normal">4105</span>
<span class="normal">4106</span>
<span class="normal">4107</span>
<span class="normal">4108</span>
<span class="normal">4109</span>
<span class="normal">4110</span>
<span class="normal">4111</span>
<span class="normal">4112</span>
<span class="normal">4113</span>
<span class="normal">4114</span>
<span class="normal">4115</span>
<span class="normal">4116</span>
<span class="normal">4117</span>
<span class="normal">4118</span>
<span class="normal">4119</span>
<span class="normal">4120</span>
<span class="normal">4121</span>
<span class="normal">4122</span>
<span class="normal">4123</span>
<span class="normal">4124</span>
<span class="normal">4125</span>
<span class="normal">4126</span>
<span class="normal">4127</span>
<span class="normal">4128</span>
<span class="normal">4129</span>
<span class="normal">4130</span>
<span class="normal">4131</span>
<span class="normal">4132</span>
<span class="normal">4133</span>
<span class="normal">4134</span>
<span class="normal">4135</span>
<span class="normal">4136</span>
<span class="normal">4137</span>
<span class="normal">4138</span>
<span class="normal">4139</span>
<span class="normal">4140</span>
<span class="normal">4141</span>
<span class="normal">4142</span>
<span class="normal">4143</span>
<span class="normal">4144</span>
<span class="normal">4145</span>
<span class="normal">4146</span>
<span class="normal">4147</span>
<span class="normal">4148</span>
<span class="normal">4149</span>
<span class="normal">4150</span>
<span class="normal">4151</span>
<span class="normal">4152</span>
<span class="normal">4153</span>
<span class="normal">4154</span>
<span class="normal">4155</span>
<span class="normal">4156</span>
<span class="normal">4157</span>
<span class="normal">4158</span>
<span class="normal">4159</span>
<span class="normal">4160</span>
<span class="normal">4161</span>
<span class="normal">4162</span>
<span class="normal">4163</span>
<span class="normal">4164</span>
<span class="normal">4165</span>
<span class="normal">4166</span>
<span class="normal">4167</span>
<span class="normal">4168</span>
<span class="normal">4169</span>
<span class="normal">4170</span>
<span class="normal">4171</span>
<span class="normal">4172</span>
<span class="normal">4173</span>
<span class="normal">4174</span>
<span class="normal">4175</span>
<span class="normal">4176</span>
<span class="normal">4177</span>
<span class="normal">4178</span>
<span class="normal">4179</span>
<span class="normal">4180</span>
<span class="normal">4181</span>
<span class="normal">4182</span>
<span class="normal">4183</span>
<span class="normal">4184</span>
<span class="normal">4185</span>
<span class="normal">4186</span>
<span class="normal">4187</span>
<span class="normal">4188</span>
<span class="normal">4189</span>
<span class="normal">4190</span>
<span class="normal">4191</span>
<span class="normal">4192</span>
<span class="normal">4193</span>
<span class="normal">4194</span>
<span class="normal">4195</span>
<span class="normal">4196</span>
<span class="normal">4197</span>
<span class="normal">4198</span>
<span class="normal">4199</span>
<span class="normal">4200</span>
<span class="normal">4201</span>
<span class="normal">4202</span>
<span class="normal">4203</span>
<span class="normal">4204</span>
<span class="normal">4205</span>
<span class="normal">4206</span>
<span class="normal">4207</span>
<span class="normal">4208</span>
<span class="normal">4209</span>
<span class="normal">4210</span>
<span class="normal">4211</span>
<span class="normal">4212</span>
<span class="normal">4213</span>
<span class="normal">4214</span>
<span class="normal">4215</span>
<span class="normal">4216</span>
<span class="normal">4217</span>
<span class="normal">4218</span>
<span class="normal">4219</span>
<span class="normal">4220</span>
<span class="normal">4221</span>
<span class="normal">4222</span>
<span class="normal">4223</span>
<span class="normal">4224</span>
<span class="normal">4225</span>
<span class="normal">4226</span>
<span class="normal">4227</span>
<span class="normal">4228</span>
<span class="normal">4229</span>
<span class="normal">4230</span>
<span class="normal">4231</span>
<span class="normal">4232</span>
<span class="normal">4233</span>
<span class="normal">4234</span>
<span class="normal">4235</span>
<span class="normal">4236</span>
<span class="normal">4237</span>
<span class="normal">4238</span>
<span class="normal">4239</span>
<span class="normal">4240</span>
<span class="normal">4241</span>
<span class="normal">4242</span>
<span class="normal">4243</span>
<span class="normal">4244</span>
<span class="normal">4245</span>
<span class="normal">4246</span>
<span class="normal">4247</span>
<span class="normal">4248</span>
<span class="normal">4249</span>
<span class="normal">4250</span>
<span class="normal">4251</span>
<span class="normal">4252</span>
<span class="normal">4253</span>
<span class="normal">4254</span>
<span class="normal">4255</span>
<span class="normal">4256</span>
<span class="normal">4257</span>
<span class="normal">4258</span>
<span class="normal">4259</span>
<span class="normal">4260</span>
<span class="normal">4261</span>
<span class="normal">4262</span>
<span class="normal">4263</span>
<span class="normal">4264</span>
<span class="normal">4265</span>
<span class="normal">4266</span>
<span class="normal">4267</span>
<span class="normal">4268</span>
<span class="normal">4269</span>
<span class="normal">4270</span>
<span class="normal">4271</span>
<span class="normal">4272</span>
<span class="normal">4273</span>
<span class="normal">4274</span>
<span class="normal">4275</span>
<span class="normal">4276</span>
<span class="normal">4277</span>
<span class="normal">4278</span>
<span class="normal">4279</span>
<span class="normal">4280</span>
<span class="normal">4281</span>
<span class="normal">4282</span>
<span class="normal">4283</span>
<span class="normal">4284</span>
<span class="normal">4285</span>
<span class="normal">4286</span>
<span class="normal">4287</span>
<span class="normal">4288</span>
<span class="normal">4289</span>
<span class="normal">4290</span>
<span class="normal">4291</span>
<span class="normal">4292</span>
<span class="normal">4293</span>
<span class="normal">4294</span>
<span class="normal">4295</span>
<span class="normal">4296</span>
<span class="normal">4297</span>
<span class="normal">4298</span>
<span class="normal">4299</span>
<span class="normal">4300</span>
<span class="normal">4301</span>
<span class="normal">4302</span>
<span class="normal">4303</span>
<span class="normal">4304</span>
<span class="normal">4305</span>
<span class="normal">4306</span>
<span class="normal">4307</span>
<span class="normal">4308</span>
<span class="normal">4309</span>
<span class="normal">4310</span>
<span class="normal">4311</span>
<span class="normal">4312</span>
<span class="normal">4313</span>
<span class="normal">4314</span>
<span class="normal">4315</span>
<span class="normal">4316</span>
<span class="normal">4317</span>
<span class="normal">4318</span>
<span class="normal">4319</span>
<span class="normal">4320</span>
<span class="normal">4321</span>
<span class="normal">4322</span>
<span class="normal">4323</span>
<span class="normal">4324</span>
<span class="normal">4325</span>
<span class="normal">4326</span>
<span class="normal">4327</span>
<span class="normal">4328</span>
<span class="normal">4329</span>
<span class="normal">4330</span>
<span class="normal">4331</span>
<span class="normal">4332</span>
<span class="normal">4333</span>
<span class="normal">4334</span>
<span class="normal">4335</span>
<span class="normal">4336</span>
<span class="normal">4337</span>
<span class="normal">4338</span>
<span class="normal">4339</span>
<span class="normal">4340</span>
<span class="normal">4341</span>
<span class="normal">4342</span>
<span class="normal">4343</span>
<span class="normal">4344</span>
<span class="normal">4345</span>
<span class="normal">4346</span>
<span class="normal">4347</span>
<span class="normal">4348</span>
<span class="normal">4349</span>
<span class="normal">4350</span>
<span class="normal">4351</span>
<span class="normal">4352</span>
<span class="normal">4353</span>
<span class="normal">4354</span>
<span class="normal">4355</span>
<span class="normal">4356</span>
<span class="normal">4357</span>
<span class="normal">4358</span>
<span class="normal">4359</span>
<span class="normal">4360</span>
<span class="normal">4361</span>
<span class="normal">4362</span>
<span class="normal">4363</span>
<span class="normal">4364</span>
<span class="normal">4365</span>
<span class="normal">4366</span>
<span class="normal">4367</span>
<span class="normal">4368</span>
<span class="normal">4369</span>
<span class="normal">4370</span>
<span class="normal">4371</span>
<span class="normal">4372</span>
<span class="normal">4373</span>
<span class="normal">4374</span>
<span class="normal">4375</span>
<span class="normal">4376</span>
<span class="normal">4377</span>
<span class="normal">4378</span>
<span class="normal">4379</span>
<span class="normal">4380</span>
<span class="normal">4381</span>
<span class="normal">4382</span>
<span class="normal">4383</span>
<span class="normal">4384</span>
<span class="normal">4385</span>
<span class="normal">4386</span>
<span class="normal">4387</span>
<span class="normal">4388</span>
<span class="normal">4389</span>
<span class="normal">4390</span>
<span class="normal">4391</span>
<span class="normal">4392</span>
<span class="normal">4393</span>
<span class="normal">4394</span>
<span class="normal">4395</span>
<span class="normal">4396</span>
<span class="normal">4397</span>
<span class="normal">4398</span>
<span class="normal">4399</span>
<span class="normal">4400</span>
<span class="normal">4401</span>
<span class="normal">4402</span>
<span class="normal">4403</span>
<span class="normal">4404</span>
<span class="normal">4405</span>
<span class="normal">4406</span>
<span class="normal">4407</span>
<span class="normal">4408</span>
<span class="normal">4409</span>
<span class="normal">4410</span>
<span class="normal">4411</span>
<span class="normal">4412</span>
<span class="normal">4413</span>
<span class="normal">4414</span>
<span class="normal">4415</span>
<span class="normal">4416</span>
<span class="normal">4417</span>
<span class="normal">4418</span>
<span class="normal">4419</span>
<span class="normal">4420</span>
<span class="normal">4421</span>
<span class="normal">4422</span>
<span class="normal">4423</span>
<span class="normal">4424</span>
<span class="normal">4425</span>
<span class="normal">4426</span>
<span class="normal">4427</span>
<span class="normal">4428</span>
<span class="normal">4429</span>
<span class="normal">4430</span>
<span class="normal">4431</span>
<span class="normal">4432</span>
<span class="normal">4433</span>
<span class="normal">4434</span>
<span class="normal">4435</span>
<span class="normal">4436</span>
<span class="normal">4437</span>
<span class="normal">4438</span>
<span class="normal">4439</span>
<span class="normal">4440</span>
<span class="normal">4441</span>
<span class="normal">4442</span>
<span class="normal">4443</span>
<span class="normal">4444</span>
<span class="normal">4445</span>
<span class="normal">4446</span>
<span class="normal">4447</span>
<span class="normal">4448</span>
<span class="normal">4449</span>
<span class="normal">4450</span>
<span class="normal">4451</span>
<span class="normal">4452</span>
<span class="normal">4453</span>
<span class="normal">4454</span>
<span class="normal">4455</span>
<span class="normal">4456</span>
<span class="normal">4457</span>
<span class="normal">4458</span>
<span class="normal">4459</span>
<span class="normal">4460</span>
<span class="normal">4461</span>
<span class="normal">4462</span>
<span class="normal">4463</span>
<span class="normal">4464</span>
<span class="normal">4465</span>
<span class="normal">4466</span>
<span class="normal">4467</span>
<span class="normal">4468</span>
<span class="normal">4469</span>
<span class="normal">4470</span>
<span class="normal">4471</span>
<span class="normal">4472</span>
<span class="normal">4473</span>
<span class="normal">4474</span>
<span class="normal">4475</span>
<span class="normal">4476</span>
<span class="normal">4477</span>
<span class="normal">4478</span>
<span class="normal">4479</span>
<span class="normal">4480</span>
<span class="normal">4481</span>
<span class="normal">4482</span>
<span class="normal">4483</span>
<span class="normal">4484</span>
<span class="normal">4485</span>
<span class="normal">4486</span>
<span class="normal">4487</span>
<span class="normal">4488</span>
<span class="normal">4489</span>
<span class="normal">4490</span>
<span class="normal">4491</span>
<span class="normal">4492</span>
<span class="normal">4493</span>
<span class="normal">4494</span>
<span class="normal">4495</span>
<span class="normal">4496</span>
<span class="normal">4497</span>
<span class="normal">4498</span>
<span class="normal">4499</span>
<span class="normal">4500</span>
<span class="normal">4501</span>
<span class="normal">4502</span>
<span class="normal">4503</span>
<span class="normal">4504</span>
<span class="normal">4505</span>
<span class="normal">4506</span>
<span class="normal">4507</span>
<span class="normal">4508</span>
<span class="normal">4509</span>
<span class="normal">4510</span>
<span class="normal">4511</span>
<span class="normal">4512</span>
<span class="normal">4513</span>
<span class="normal">4514</span>
<span class="normal">4515</span>
<span class="normal">4516</span>
<span class="normal">4517</span>
<span class="normal">4518</span>
<span class="normal">4519</span>
<span class="normal">4520</span>
<span class="normal">4521</span>
<span class="normal">4522</span>
<span class="normal">4523</span>
<span class="normal">4524</span>
<span class="normal">4525</span>
<span class="normal">4526</span>
<span class="normal">4527</span>
<span class="normal">4528</span>
<span class="normal">4529</span>
<span class="normal">4530</span>
<span class="normal">4531</span>
<span class="normal">4532</span>
<span class="normal">4533</span>
<span class="normal">4534</span>
<span class="normal">4535</span>
<span class="normal">4536</span>
<span class="normal">4537</span>
<span class="normal">4538</span>
<span class="normal">4539</span>
<span class="normal">4540</span>
<span class="normal">4541</span>
<span class="normal">4542</span>
<span class="normal">4543</span>
<span class="normal">4544</span>
<span class="normal">4545</span>
<span class="normal">4546</span>
<span class="normal">4547</span>
<span class="normal">4548</span>
<span class="normal">4549</span>
<span class="normal">4550</span>
<span class="normal">4551</span>
<span class="normal">4552</span>
<span class="normal">4553</span>
<span class="normal">4554</span>
<span class="normal">4555</span>
<span class="normal">4556</span>
<span class="normal">4557</span>
<span class="normal">4558</span>
<span class="normal">4559</span>
<span class="normal">4560</span>
<span class="normal">4561</span>
<span class="normal">4562</span>
<span class="normal">4563</span>
<span class="normal">4564</span>
<span class="normal">4565</span>
<span class="normal">4566</span>
<span class="normal">4567</span>
<span class="normal">4568</span>
<span class="normal">4569</span>
<span class="normal">4570</span>
<span class="normal">4571</span>
<span class="normal">4572</span>
<span class="normal">4573</span>
<span class="normal">4574</span>
<span class="normal">4575</span>
<span class="normal">4576</span>
<span class="normal">4577</span>
<span class="normal">4578</span>
<span class="normal">4579</span>
<span class="normal">4580</span>
<span class="normal">4581</span>
<span class="normal">4582</span>
<span class="normal">4583</span>
<span class="normal">4584</span>
<span class="normal">4585</span>
<span class="normal">4586</span>
<span class="normal">4587</span>
<span class="normal">4588</span>
<span class="normal">4589</span>
<span class="normal">4590</span>
<span class="normal">4591</span>
<span class="normal">4592</span>
<span class="normal">4593</span>
<span class="normal">4594</span>
<span class="normal">4595</span>
<span class="normal">4596</span>
<span class="normal">4597</span>
<span class="normal">4598</span>
<span class="normal">4599</span>
<span class="normal">4600</span>
<span class="normal">4601</span>
<span class="normal">4602</span>
<span class="normal">4603</span>
<span class="normal">4604</span>
<span class="normal">4605</span>
<span class="normal">4606</span>
<span class="normal">4607</span>
<span class="normal">4608</span>
<span class="normal">4609</span>
<span class="normal">4610</span>
<span class="normal">4611</span>
<span class="normal">4612</span>
<span class="normal">4613</span>
<span class="normal">4614</span>
<span class="normal">4615</span>
<span class="normal">4616</span>
<span class="normal">4617</span>
<span class="normal">4618</span>
<span class="normal">4619</span>
<span class="normal">4620</span>
<span class="normal">4621</span>
<span class="normal">4622</span>
<span class="normal">4623</span>
<span class="normal">4624</span>
<span class="normal">4625</span>
<span class="normal">4626</span>
<span class="normal">4627</span>
<span class="normal">4628</span>
<span class="normal">4629</span>
<span class="normal">4630</span>
<span class="normal">4631</span>
<span class="normal">4632</span>
<span class="normal">4633</span>
<span class="normal">4634</span>
<span class="normal">4635</span>
<span class="normal">4636</span>
<span class="normal">4637</span>
<span class="normal">4638</span>
<span class="normal">4639</span>
<span class="normal">4640</span>
<span class="normal">4641</span>
<span class="normal">4642</span>
<span class="normal">4643</span>
<span class="normal">4644</span>
<span class="normal">4645</span>
<span class="normal">4646</span>
<span class="normal">4647</span>
<span class="normal">4648</span>
<span class="normal">4649</span>
<span class="normal">4650</span>
<span class="normal">4651</span>
<span class="normal">4652</span>
<span class="normal">4653</span>
<span class="normal">4654</span>
<span class="normal">4655</span>
<span class="normal">4656</span>
<span class="normal">4657</span>
<span class="normal">4658</span>
<span class="normal">4659</span>
<span class="normal">4660</span>
<span class="normal">4661</span>
<span class="normal">4662</span>
<span class="normal">4663</span>
<span class="normal">4664</span>
<span class="normal">4665</span>
<span class="normal">4666</span>
<span class="normal">4667</span>
<span class="normal">4668</span>
<span class="normal">4669</span>
<span class="normal">4670</span>
<span class="normal">4671</span>
<span class="normal">4672</span>
<span class="normal">4673</span>
<span class="normal">4674</span>
<span class="normal">4675</span>
<span class="normal">4676</span>
<span class="normal">4677</span>
<span class="normal">4678</span>
<span class="normal">4679</span>
<span class="normal">4680</span>
<span class="normal">4681</span>
<span class="normal">4682</span>
<span class="normal">4683</span>
<span class="normal">4684</span>
<span class="normal">4685</span>
<span class="normal">4686</span>
<span class="normal">4687</span>
<span class="normal">4688</span>
<span class="normal">4689</span>
<span class="normal">4690</span>
<span class="normal">4691</span>
<span class="normal">4692</span>
<span class="normal">4693</span>
<span class="normal">4694</span>
<span class="normal">4695</span>
<span class="normal">4696</span>
<span class="normal">4697</span>
<span class="normal">4698</span>
<span class="normal">4699</span>
<span class="normal">4700</span>
<span class="normal">4701</span>
<span class="normal">4702</span>
<span class="normal">4703</span>
<span class="normal">4704</span>
<span class="normal">4705</span>
<span class="normal">4706</span>
<span class="normal">4707</span>
<span class="normal">4708</span>
<span class="normal">4709</span>
<span class="normal">4710</span>
<span class="normal">4711</span>
<span class="normal">4712</span>
<span class="normal">4713</span>
<span class="normal">4714</span>
<span class="normal">4715</span>
<span class="normal">4716</span>
<span class="normal">4717</span>
<span class="normal">4718</span>
<span class="normal">4719</span>
<span class="normal">4720</span>
<span class="normal">4721</span>
<span class="normal">4722</span>
<span class="normal">4723</span>
<span class="normal">4724</span>
<span class="normal">4725</span>
<span class="normal">4726</span>
<span class="normal">4727</span>
<span class="normal">4728</span>
<span class="normal">4729</span>
<span class="normal">4730</span>
<span class="normal">4731</span>
<span class="normal">4732</span>
<span class="normal">4733</span>
<span class="normal">4734</span>
<span class="normal">4735</span>
<span class="normal">4736</span>
<span class="normal">4737</span>
<span class="normal">4738</span>
<span class="normal">4739</span>
<span class="normal">4740</span>
<span class="normal">4741</span>
<span class="normal">4742</span>
<span class="normal">4743</span>
<span class="normal">4744</span>
<span class="normal">4745</span>
<span class="normal">4746</span>
<span class="normal">4747</span>
<span class="normal">4748</span>
<span class="normal">4749</span>
<span class="normal">4750</span>
<span class="normal">4751</span>
<span class="normal">4752</span>
<span class="normal">4753</span>
<span class="normal">4754</span>
<span class="normal">4755</span>
<span class="normal">4756</span>
<span class="normal">4757</span>
<span class="normal">4758</span>
<span class="normal">4759</span>
<span class="normal">4760</span>
<span class="normal">4761</span>
<span class="normal">4762</span>
<span class="normal">4763</span>
<span class="normal">4764</span>
<span class="normal">4765</span>
<span class="normal">4766</span>
<span class="normal">4767</span>
<span class="normal">4768</span>
<span class="normal">4769</span>
<span class="normal">4770</span>
<span class="normal">4771</span>
<span class="normal">4772</span>
<span class="normal">4773</span>
<span class="normal">4774</span>
<span class="normal">4775</span>
<span class="normal">4776</span>
<span class="normal">4777</span>
<span class="normal">4778</span>
<span class="normal">4779</span>
<span class="normal">4780</span>
<span class="normal">4781</span>
<span class="normal">4782</span>
<span class="normal">4783</span>
<span class="normal">4784</span>
<span class="normal">4785</span>
<span class="normal">4786</span>
<span class="normal">4787</span>
<span class="normal">4788</span>
<span class="normal">4789</span>
<span class="normal">4790</span>
<span class="normal">4791</span>
<span class="normal">4792</span>
<span class="normal">4793</span>
<span class="normal">4794</span>
<span class="normal">4795</span>
<span class="normal">4796</span>
<span class="normal">4797</span>
<span class="normal">4798</span>
<span class="normal">4799</span>
<span class="normal">4800</span>
<span class="normal">4801</span>
<span class="normal">4802</span>
<span class="normal">4803</span>
<span class="normal">4804</span>
<span class="normal">4805</span>
<span class="normal">4806</span>
<span class="normal">4807</span>
<span class="normal">4808</span>
<span class="normal">4809</span>
<span class="normal">4810</span>
<span class="normal">4811</span>
<span class="normal">4812</span>
<span class="normal">4813</span>
<span class="normal">4814</span>
<span class="normal">4815</span>
<span class="normal">4816</span>
<span class="normal">4817</span>
<span class="normal">4818</span>
<span class="normal">4819</span>
<span class="normal">4820</span>
<span class="normal">4821</span>
<span class="normal">4822</span>
<span class="normal">4823</span>
<span class="normal">4824</span>
<span class="normal">4825</span>
<span class="normal">4826</span>
<span class="normal">4827</span>
<span class="normal">4828</span>
<span class="normal">4829</span>
<span class="normal">4830</span>
<span class="normal">4831</span>
<span class="normal">4832</span>
<span class="normal">4833</span>
<span class="normal">4834</span>
<span class="normal">4835</span>
<span class="normal">4836</span>
<span class="normal">4837</span>
<span class="normal">4838</span>
<span class="normal">4839</span>
<span class="normal">4840</span>
<span class="normal">4841</span>
<span class="normal">4842</span>
<span class="normal">4843</span>
<span class="normal">4844</span>
<span class="normal">4845</span>
<span class="normal">4846</span>
<span class="normal">4847</span>
<span class="normal">4848</span>
<span class="normal">4849</span>
<span class="normal">4850</span>
<span class="normal">4851</span>
<span class="normal">4852</span>
<span class="normal">4853</span>
<span class="normal">4854</span>
<span class="normal">4855</span>
<span class="normal">4856</span>
<span class="normal">4857</span>
<span class="normal">4858</span>
<span class="normal">4859</span>
<span class="normal">4860</span>
<span class="normal">4861</span>
<span class="normal">4862</span>
<span class="normal">4863</span>
<span class="normal">4864</span>
<span class="normal">4865</span>
<span class="normal">4866</span>
<span class="normal">4867</span>
<span class="normal">4868</span>
<span class="normal">4869</span>
<span class="normal">4870</span>
<span class="normal">4871</span>
<span class="normal">4872</span>
<span class="normal">4873</span>
<span class="normal">4874</span>
<span class="normal">4875</span>
<span class="normal">4876</span>
<span class="normal">4877</span>
<span class="normal">4878</span>
<span class="normal">4879</span>
<span class="normal">4880</span>
<span class="normal">4881</span>
<span class="normal">4882</span>
<span class="normal">4883</span>
<span class="normal">4884</span>
<span class="normal">4885</span>
<span class="normal">4886</span>
<span class="normal">4887</span>
<span class="normal">4888</span>
<span class="normal">4889</span>
<span class="normal">4890</span>
<span class="normal">4891</span>
<span class="normal">4892</span>
<span class="normal">4893</span>
<span class="normal">4894</span>
<span class="normal">4895</span>
<span class="normal">4896</span>
<span class="normal">4897</span>
<span class="normal">4898</span>
<span class="normal">4899</span>
<span class="normal">4900</span>
<span class="normal">4901</span>
<span class="normal">4902</span>
<span class="normal">4903</span>
<span class="normal">4904</span>
<span class="normal">4905</span>
<span class="normal">4906</span>
<span class="normal">4907</span>
<span class="normal">4908</span>
<span class="normal">4909</span>
<span class="normal">4910</span>
<span class="normal">4911</span>
<span class="normal">4912</span>
<span class="normal">4913</span>
<span class="normal">4914</span>
<span class="normal">4915</span>
<span class="normal">4916</span>
<span class="normal">4917</span>
<span class="normal">4918</span>
<span class="normal">4919</span>
<span class="normal">4920</span>
<span class="normal">4921</span>
<span class="normal">4922</span>
<span class="normal">4923</span>
<span class="normal">4924</span>
<span class="normal">4925</span>
<span class="normal">4926</span>
<span class="normal">4927</span>
<span class="normal">4928</span>
<span class="normal">4929</span>
<span class="normal">4930</span>
<span class="normal">4931</span>
<span class="normal">4932</span>
<span class="normal">4933</span>
<span class="normal">4934</span>
<span class="normal">4935</span>
<span class="normal">4936</span>
<span class="normal">4937</span>
<span class="normal">4938</span>
<span class="normal">4939</span>
<span class="normal">4940</span>
<span class="normal">4941</span>
<span class="normal">4942</span>
<span class="normal">4943</span>
<span class="normal">4944</span>
<span class="normal">4945</span>
<span class="normal">4946</span>
<span class="normal">4947</span>
<span class="normal">4948</span>
<span class="normal">4949</span>
<span class="normal">4950</span>
<span class="normal">4951</span>
<span class="normal">4952</span>
<span class="normal">4953</span>
<span class="normal">4954</span>
<span class="normal">4955</span>
<span class="normal">4956</span>
<span class="normal">4957</span>
<span class="normal">4958</span>
<span class="normal">4959</span>
<span class="normal">4960</span>
<span class="normal">4961</span>
<span class="normal">4962</span>
<span class="normal">4963</span>
<span class="normal">4964</span>
<span class="normal">4965</span>
<span class="normal">4966</span>
<span class="normal">4967</span>
<span class="normal">4968</span>
<span class="normal">4969</span>
<span class="normal">4970</span>
<span class="normal">4971</span>
<span class="normal">4972</span>
<span class="normal">4973</span>
<span class="normal">4974</span>
<span class="normal">4975</span>
<span class="normal">4976</span>
<span class="normal">4977</span>
<span class="normal">4978</span>
<span class="normal">4979</span>
<span class="normal">4980</span>
<span class="normal">4981</span>
<span class="normal">4982</span>
<span class="normal">4983</span>
<span class="normal">4984</span>
<span class="normal">4985</span>
<span class="normal">4986</span>
<span class="normal">4987</span>
<span class="normal">4988</span>
<span class="normal">4989</span>
<span class="normal">4990</span>
<span class="normal">4991</span>
<span class="normal">4992</span>
<span class="normal">4993</span>
<span class="normal">4994</span>
<span class="normal">4995</span>
<span class="normal">4996</span>
<span class="normal">4997</span>
<span class="normal">4998</span>
<span class="normal">4999</span>
<span class="normal">5000</span>
<span class="normal">5001</span>
<span class="normal">5002</span>
<span class="normal">5003</span>
<span class="normal">5004</span>
<span class="normal">5005</span>
<span class="normal">5006</span>
<span class="normal">5007</span>
<span class="normal">5008</span>
<span class="normal">5009</span>
<span class="normal">5010</span>
<span class="normal">5011</span>
<span class="normal">5012</span>
<span class="normal">5013</span>
<span class="normal">5014</span>
<span class="normal">5015</span>
<span class="normal">5016</span>
<span class="normal">5017</span>
<span class="normal">5018</span>
<span class="normal">5019</span>
<span class="normal">5020</span>
<span class="normal">5021</span>
<span class="normal">5022</span>
<span class="normal">5023</span>
<span class="normal">5024</span>
<span class="normal">5025</span>
<span class="normal">5026</span>
<span class="normal">5027</span>
<span class="normal">5028</span>
<span class="normal">5029</span>
<span class="normal">5030</span>
<span class="normal">5031</span>
<span class="normal">5032</span>
<span class="normal">5033</span>
<span class="normal">5034</span>
<span class="normal">5035</span>
<span class="normal">5036</span>
<span class="normal">5037</span>
<span class="normal">5038</span>
<span class="normal">5039</span>
<span class="normal">5040</span>
<span class="normal">5041</span>
<span class="normal">5042</span>
<span class="normal">5043</span>
<span class="normal">5044</span>
<span class="normal">5045</span>
<span class="normal">5046</span>
<span class="normal">5047</span>
<span class="normal">5048</span>
<span class="normal">5049</span>
<span class="normal">5050</span>
<span class="normal">5051</span>
<span class="normal">5052</span>
<span class="normal">5053</span>
<span class="normal">5054</span>
<span class="normal">5055</span>
<span class="normal">5056</span>
<span class="normal">5057</span>
<span class="normal">5058</span>
<span class="normal">5059</span>
<span class="normal">5060</span>
<span class="normal">5061</span>
<span class="normal">5062</span>
<span class="normal">5063</span>
<span class="normal">5064</span>
<span class="normal">5065</span>
<span class="normal">5066</span>
<span class="normal">5067</span>
<span class="normal">5068</span>
<span class="normal">5069</span>
<span class="normal">5070</span>
<span class="normal">5071</span>
<span class="normal">5072</span>
<span class="normal">5073</span>
<span class="normal">5074</span>
<span class="normal">5075</span>
<span class="normal">5076</span>
<span class="normal">5077</span>
<span class="normal">5078</span>
<span class="normal">5079</span>
<span class="normal">5080</span>
<span class="normal">5081</span>
<span class="normal">5082</span>
<span class="normal">5083</span>
<span class="normal">5084</span>
<span class="normal">5085</span>
<span class="normal">5086</span>
<span class="normal">5087</span>
<span class="normal">5088</span>
<span class="normal">5089</span>
<span class="normal">5090</span>
<span class="normal">5091</span>
<span class="normal">5092</span>
<span class="normal">5093</span>
<span class="normal">5094</span>
<span class="normal">5095</span>
<span class="normal">5096</span>
<span class="normal">5097</span>
<span class="normal">5098</span>
<span class="normal">5099</span>
<span class="normal">5100</span>
<span class="normal">5101</span>
<span class="normal">5102</span>
<span class="normal">5103</span>
<span class="normal">5104</span>
<span class="normal">5105</span>
<span class="normal">5106</span>
<span class="normal">5107</span>
<span class="normal">5108</span>
<span class="normal">5109</span>
<span class="normal">5110</span>
<span class="normal">5111</span>
<span class="normal">5112</span>
<span class="normal">5113</span>
<span class="normal">5114</span>
<span class="normal">5115</span>
<span class="normal">5116</span>
<span class="normal">5117</span>
<span class="normal">5118</span>
<span class="normal">5119</span>
<span class="normal">5120</span>
<span class="normal">5121</span>
<span class="normal">5122</span>
<span class="normal">5123</span>
<span class="normal">5124</span>
<span class="normal">5125</span>
<span class="normal">5126</span>
<span class="normal">5127</span>
<span class="normal">5128</span>
<span class="normal">5129</span>
<span class="normal">5130</span>
<span class="normal">5131</span>
<span class="normal">5132</span>
<span class="normal">5133</span>
<span class="normal">5134</span>
<span class="normal">5135</span>
<span class="normal">5136</span>
<span class="normal">5137</span>
<span class="normal">5138</span>
<span class="normal">5139</span>
<span class="normal">5140</span>
<span class="normal">5141</span>
<span class="normal">5142</span>
<span class="normal">5143</span>
<span class="normal">5144</span>
<span class="normal">5145</span>
<span class="normal">5146</span>
<span class="normal">5147</span>
<span class="normal">5148</span>
<span class="normal">5149</span>
<span class="normal">5150</span>
<span class="normal">5151</span>
<span class="normal">5152</span>
<span class="normal">5153</span>
<span class="normal">5154</span>
<span class="normal">5155</span>
<span class="normal">5156</span>
<span class="normal">5157</span>
<span class="normal">5158</span>
<span class="normal">5159</span>
<span class="normal">5160</span>
<span class="normal">5161</span>
<span class="normal">5162</span>
<span class="normal">5163</span>
<span class="normal">5164</span>
<span class="normal">5165</span>
<span class="normal">5166</span>
<span class="normal">5167</span>
<span class="normal">5168</span>
<span class="normal">5169</span>
<span class="normal">5170</span>
<span class="normal">5171</span>
<span class="normal">5172</span>
<span class="normal">5173</span>
<span class="normal">5174</span>
<span class="normal">5175</span>
<span class="normal">5176</span>
<span class="normal">5177</span>
<span class="normal">5178</span>
<span class="normal">5179</span>
<span class="normal">5180</span>
<span class="normal">5181</span>
<span class="normal">5182</span>
<span class="normal">5183</span>
<span class="normal">5184</span>
<span class="normal">5185</span>
<span class="normal">5186</span>
<span class="normal">5187</span>
<span class="normal">5188</span>
<span class="normal">5189</span>
<span class="normal">5190</span>
<span class="normal">5191</span>
<span class="normal">5192</span>
<span class="normal">5193</span>
<span class="normal">5194</span>
<span class="normal">5195</span>
<span class="normal">5196</span>
<span class="normal">5197</span>
<span class="normal">5198</span>
<span class="normal">5199</span>
<span class="normal">5200</span>
<span class="normal">5201</span>
<span class="normal">5202</span>
<span class="normal">5203</span>
<span class="normal">5204</span>
<span class="normal">5205</span>
<span class="normal">5206</span>
<span class="normal">5207</span>
<span class="normal">5208</span>
<span class="normal">5209</span>
<span class="normal">5210</span>
<span class="normal">5211</span>
<span class="normal">5212</span>
<span class="normal">5213</span>
<span class="normal">5214</span>
<span class="normal">5215</span>
<span class="normal">5216</span>
<span class="normal">5217</span>
<span class="normal">5218</span>
<span class="normal">5219</span>
<span class="normal">5220</span>
<span class="normal">5221</span>
<span class="normal">5222</span>
<span class="normal">5223</span>
<span class="normal">5224</span>
<span class="normal">5225</span>
<span class="normal">5226</span>
<span class="normal">5227</span>
<span class="normal">5228</span>
<span class="normal">5229</span>
<span class="normal">5230</span>
<span class="normal">5231</span>
<span class="normal">5232</span>
<span class="normal">5233</span>
<span class="normal">5234</span>
<span class="normal">5235</span>
<span class="normal">5236</span>
<span class="normal">5237</span>
<span class="normal">5238</span>
<span class="normal">5239</span>
<span class="normal">5240</span>
<span class="normal">5241</span>
<span class="normal">5242</span>
<span class="normal">5243</span>
<span class="normal">5244</span>
<span class="normal">5245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SamGeo3Video</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Video segmentation and tracking with SAM3 for geospatial data.</span>

<span class="sd">    This class provides a simplified API for segmenting and tracking objects</span>
<span class="sd">    in videos or time series remote sensing images using SAM3.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from samgeo.samgeo3 import SamGeo3Video</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;path/to/video.mp4&quot;)  # or path to image sequence</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;person&quot;)  # text prompt</span>
<span class="sd">        &gt;&gt;&gt; sam.save_masks(&quot;output/&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gpus_to_use</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bpe_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the SamGeo3Video class.</span>

<span class="sd">        Args:</span>
<span class="sd">            gpus_to_use (List[int], optional): List of GPU indices to use.</span>
<span class="sd">                If None, uses all available GPUs. Defaults to None.</span>
<span class="sd">            bpe_path (str, optional): Path to the BPE tokenizer vocabulary.</span>
<span class="sd">                If None, uses the default path. Defaults to None.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to build_sam3_video_predictor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SAM3_META_AVAILABLE</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;SAM3 is not available. Please install it as:</span><span class="se">\n\t</span><span class="s2">&quot;</span>
                <span class="s2">&quot;pip install segment-geospatial[samgeo3]&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">SAM3_META_IMPORT_ERROR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Underlying import error:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">SAM3_META_IMPORT_ERROR</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

        <span class="c1"># Set up GPU configuration</span>
        <span class="k">if</span> <span class="n">gpus_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gpus_to_use</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus_to_use</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gpus_to_use</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">()]</span>

        <span class="c1"># Set up BPE path</span>
        <span class="k">if</span> <span class="n">bpe_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
            <span class="n">bpe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="s2">&quot;bpe_simple_vocab_16e6.txt.gz&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bpe_path</span><span class="p">):</span>
                <span class="n">bpe_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bpe_path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">bpe_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/giswqs/geospatial/resolve/main/bpe_simple_vocab_16e6.txt.gz&quot;</span>
                <span class="n">bpe_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">bpe_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using GPUs: </span><span class="si">{</span><span class="n">gpus_to_use</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">build_sam3_video_predictor</span><span class="p">(</span>
            <span class="n">gpus_to_use</span><span class="o">=</span><span class="n">gpus_to_use</span><span class="p">,</span> <span class="n">bpe_path</span><span class="o">=</span><span class="n">bpe_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpus_to_use</span> <span class="o">=</span> <span class="n">gpus_to_use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tif_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_video</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">video_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">frame_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a video or time series images for segmentation.</span>

<span class="sd">        The video can be:</span>
<span class="sd">        - An MP4 video file</span>
<span class="sd">        - A directory of JPEG frames</span>
<span class="sd">        - A directory of GeoTIFF images (for time series remote sensing data)</span>

<span class="sd">        Args:</span>
<span class="sd">            video_path (str): Path to the video file or image directory.</span>
<span class="sd">            output_dir (str, optional): Directory to save extracted frames.</span>
<span class="sd">                Only used when video_path is an MP4 file. Defaults to None.</span>
<span class="sd">            frame_rate (int, optional): Frame rate for extracting frames from video.</span>
<span class="sd">                Only used when video_path is an MP4 file. Defaults to None.</span>
<span class="sd">            prefix (str): Prefix for extracted frame filenames. Defaults to &quot;&quot;.</span>
<span class="sd">            bands (List[int], optional): List of band indices (1-based) to use for RGB</span>
<span class="sd">                when the input is a GeoTIFF directory with multi-band images. For example,</span>
<span class="sd">                [4, 3, 2] for NIR-R-G false color composite. If None, uses the</span>
<span class="sd">                first 3 bands for multi-band images. Defaults to None.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;video.mp4&quot;)  # Load MP4 video</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;frames/&quot;)  # Load from JPEG frames directory</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;landsat_ts/&quot;)  # Load GeoTIFF time series</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;landsat_ts/&quot;, bands=[4, 3, 2])  # NIR-R-G composite</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">video_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">video_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
                <span class="c1"># MP4 video file - extract frames</span>
                <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">make_temp_dir</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting frames to: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">common</span><span class="o">.</span><span class="n">video_to_images</span><span class="p">(</span>
                    <span class="n">video_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">frame_rate</span><span class="o">=</span><span class="n">frame_rate</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span>
                <span class="p">)</span>
                <span class="n">video_path</span> <span class="o">=</span> <span class="n">output_dir</span>

            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">video_path</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files found in </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="c1"># Check if it&#39;s a GeoTIFF directory</span>
                <span class="k">if</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tif_dir</span> <span class="o">=</span> <span class="n">video_path</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span> <span class="o">=</span> <span class="n">files</span>
                    <span class="c1"># Convert GeoTIFFs to JPEGs for SAM3</span>
                    <span class="n">video_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">geotiff_to_jpg_batch</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="n">bands</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted GeoTIFFs to JPEGs: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;video_path must be a string.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="n">video_path</span>

        <span class="c1"># Load frames for visualization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_video_frames</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

        <span class="c1"># Start a session</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;start_session&quot;</span><span class="p">,</span>
                <span class="n">resource_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames. Session started.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">embed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the video.</span>

<span class="sd">        Args:</span>
<span class="sd">            video_path (str): Path to video file.</span>
<span class="sd">            embed (bool, optional): Whether to embed the video. Defaults to True.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to Video.</span>

<span class="sd">        Returns:</span>
<span class="sd">            IPython.display.Video: The video object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Video</span>

        <span class="k">return</span> <span class="n">Video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="n">embed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_video_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load video frames for visualization.</span>

<span class="sd">        Args:</span>
<span class="sd">            video_path (str): Path to video file or frame directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">video_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">):</span>
            <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
            <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load any frames from video: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="s2">&quot;*.jpg&quot;</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">:</span>
                <span class="n">first_frame</span> <span class="o">=</span> <span class="n">load_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span> <span class="o">=</span> <span class="n">first_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No JPEG frames found in directory: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the current session, clearing all prompts and masks.</span>

<span class="sd">        Use this when you want to start fresh with new prompts on the same video.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;reset_session&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session reset.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the tracker without detecting any objects.</span>

<span class="sd">        This method initializes SAM3&#39;s video tracking state, which is required</span>
<span class="sd">        before using point prompts (add_point_prompts), box prompts (add_box_prompt),</span>
<span class="sd">        or mask prompts (add_mask_prompt).</span>

<span class="sd">        Call this method when you want to:</span>
<span class="sd">        - Use only point or box prompts without text-based detection</span>
<span class="sd">        - Add external masks from other segmentation models</span>
<span class="sd">        - Have full control over which objects to track</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_idx (int): Frame index to initialize the tracker on. Defaults to 0.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;video.mp4&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.init_tracker()  # Initialize without detecting anything</span>
<span class="sd">            &gt;&gt;&gt; sam.add_point_prompts([[500, 300]], [1], obj_id=1)  # Add object via point</span>
<span class="sd">            &gt;&gt;&gt; sam.add_box_prompt([100, 100, 200, 150], obj_id=2)  # Add object via box</span>
<span class="sd">            &gt;&gt;&gt; sam.propagate()  # Track through video</span>
<span class="sd">            &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;)</span>

<span class="sd">        Note:</span>
<span class="sd">            - This is equivalent to calling generate_masks() with a prompt that</span>
<span class="sd">              matches no objects, but provides a cleaner API.</span>
<span class="sd">            - The tracker must be initialized before adding point/box/mask prompts.</span>
<span class="sd">            - After init_tracker(), you can add objects using:</span>
<span class="sd">              - add_point_prompts() for point-based segmentation</span>
<span class="sd">              - add_box_prompt() for box-based segmentation</span>
<span class="sd">              - add_mask_prompt() for external mask tracking</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Reset prompts before initializing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Use a nonsense text prompt that won&#39;t match any real objects</span>
        <span class="c1"># This initializes the tracker state without detecting anything</span>
        <span class="n">_init_prompt</span> <span class="o">=</span> <span class="s2">&quot;__samgeo_init_tracker_placeholder_xyzzy_12345__&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">_init_prompt</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Run propagation to fully initialize the tracker state</span>
        <span class="c1"># This populates cached_frame_outputs which is required for point prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagate</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracker initialized. You can now add point, box, or mask prompts.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">propagate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate masks using a text prompt.</span>

<span class="sd">        This will segment all instances of the described object in the video</span>
<span class="sd">        and optionally track them through all frames.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): Text description of objects to segment (e.g., &quot;person&quot;, &quot;car&quot;).</span>
<span class="sd">            frame_idx (int): Frame index to add the prompt on. Defaults to 0.</span>
<span class="sd">            propagate (bool): Whether to propagate masks to all frames. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[int, Any]: Dictionary mapping frame index to mask outputs.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;building&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;tree&quot;, frame_idx=10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Reset prompts before adding new text prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Add text prompt</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span>
        <span class="c1"># Get object IDs - key is &#39;out_obj_ids&#39; from SAM3 video predictor</span>
        <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_obj_ids&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">,</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
            <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> object(s) matching &#39;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#39; on frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">propagate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagate</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_point_prompts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">points</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add point prompts to segment or refine an object.</span>

<span class="sd">        Args:</span>
<span class="sd">            points (List[List[float]]): List of [x, y] point coordinates.</span>
<span class="sd">                In pixel coordinates by default, or in the specified CRS.</span>
<span class="sd">            labels (List[int]): List of labels for each point.</span>
<span class="sd">                1 for positive (include), 0 for negative (exclude).</span>
<span class="sd">            obj_id (int): Object ID to associate with this prompt.</span>
<span class="sd">            frame_idx (int): Frame index to add the prompt on. Defaults to 0.</span>
<span class="sd">            point_crs (str, optional): Coordinate reference system for points</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot;). Only used with GeoTIFF time series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Response containing the mask output.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Add positive point</span>
<span class="sd">            &gt;&gt;&gt; sam.add_point_prompts([[500, 300]], [1], obj_id=1)</span>
<span class="sd">            &gt;&gt;&gt; # Add positive and negative points</span>
<span class="sd">            &gt;&gt;&gt; sam.add_point_prompts([[500, 300], [600, 400]], [1, 0], obj_id=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># Transform coordinates if CRS is provided</span>
        <span class="k">if</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">point_crs</span><span class="p">)</span>

        <span class="c1"># Convert to relative coordinates (0-1 range)</span>
        <span class="n">rel_points</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span><span class="p">,</span> <span class="n">y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>

        <span class="n">points_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rel_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">labels_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
                <span class="n">points</span><span class="o">=</span><span class="n">points_tensor</span><span class="p">,</span>
                <span class="n">point_labels</span><span class="o">=</span><span class="n">labels_tensor</span><span class="p">,</span>
                <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_box_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">box</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a bounding box prompt to segment an object.</span>

<span class="sd">        Args:</span>
<span class="sd">            box (List[float]): Bounding box in [x, y, width, height] format.</span>
<span class="sd">                In pixel coordinates by default, or in the specified CRS.</span>
<span class="sd">            obj_id (int): Object ID to associate with this prompt.</span>
<span class="sd">            frame_idx (int): Frame index to add the prompt on. Defaults to 0.</span>
<span class="sd">            box_crs (str, optional): Coordinate reference system for box</span>
<span class="sd">                (e.g., &quot;EPSG:4326&quot;). Only used with GeoTIFF time series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Response containing the mask output.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.add_box_prompt([100, 100, 200, 150], obj_id=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span>

        <span class="c1"># Transform coordinates if CRS is provided</span>
        <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert box corners to pixel coordinates</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">]])</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y</span>

        <span class="c1"># Convert to relative coordinates [cx, cy, w, h]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span>
        <span class="n">rel_w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span>
        <span class="n">rel_h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span>

        <span class="n">box_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">rel_w</span><span class="p">,</span> <span class="n">rel_h</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
                <span class="n">box</span><span class="o">=</span><span class="n">box_tensor</span><span class="p">,</span>
                <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_mask_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a mask prompt from an external segmentation model.</span>

<span class="sd">        This allows using masks generated by other segmentation models</span>
<span class="sd">        (e.g., YOLO, Detectron2, GroundingDINO, etc.) and leveraging SAM3&#39;s</span>
<span class="sd">        tracking capability to propagate them through the video.</span>

<span class="sd">        This is useful when SAM3&#39;s text prompts don&#39;t segment the exact objects</span>
<span class="sd">        you need. You can:</span>
<span class="sd">        1. Use another model to get accurate segmentation on the first frame</span>
<span class="sd">        2. Pass those masks to SAM3 using this method</span>
<span class="sd">        3. Use SAM3&#39;s tracking to propagate the masks through the video</span>

<span class="sd">        The method works by sampling positive points from the mask region and</span>
<span class="sd">        using SAM3&#39;s point prompt capability to segment and track the object.</span>

<span class="sd">        **Important**: The tracker must be initialized first by calling</span>
<span class="sd">        `init_tracker()` (recommended) or `generate_masks()` (alternative) with any text prompt before using `add_mask_prompt()`.</span>
<span class="sd">        This is a requirement of SAM3&#39;s video tracking architecture.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (np.ndarray): Binary mask array of shape (H, W) where</span>
<span class="sd">                True/1 indicates the object region. Can be bool or numeric.</span>
<span class="sd">                The mask should match the video frame dimensions.</span>
<span class="sd">            obj_id (int): Object ID to associate with this mask. Use different</span>
<span class="sd">                IDs for different objects you want to track.</span>
<span class="sd">            frame_idx (int): Frame index to add the mask on. Defaults to 0.</span>
<span class="sd">            num_points (int): Number of points to sample from the mask region.</span>
<span class="sd">                More points can improve accuracy. Defaults to 5.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Response containing the mask output with keys:</span>
<span class="sd">                - &quot;frame_index&quot;: The frame index where mask was added</span>
<span class="sd">                - &quot;outputs&quot;: Dict with &quot;out_obj_ids&quot; and mask data</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Workflow: Use external model + SAM3 tracking</span>
<span class="sd">            &gt;&gt;&gt; from your_segmentation_model import segment_objects</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Step 1: Get segmentation from another model on first frame</span>
<span class="sd">            &gt;&gt;&gt; first_frame = load_image(&quot;frames/0.jpg&quot;)</span>
<span class="sd">            &gt;&gt;&gt; external_masks = segment_objects(first_frame)  # Your model</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Step 2: Initialize SAM3 video tracker</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;frames/&quot;)  # Load video frames</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Step 3: Initialize tracker for external masks</span>
<span class="sd">            &gt;&gt;&gt; sam.init_tracker()  # Initialize tracker for external masks</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Step 4: Add external masks for tracking (use new obj_ids)</span>
<span class="sd">            &gt;&gt;&gt; for i, mask in enumerate(external_masks):</span>
<span class="sd">            ...     sam.add_mask_prompt(mask, obj_id=100+i, frame_idx=0)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Step 5: Propagate to track through video</span>
<span class="sd">            &gt;&gt;&gt; sam.propagate()</span>
<span class="sd">            &gt;&gt;&gt; sam.save_video(&quot;tracked_output.mp4&quot;)</span>

<span class="sd">        Note:</span>
<span class="sd">            - The tracker MUST be initialized first by calling either `init_tracker()` or `generate_masks()`</span>
<span class="sd">            - Each call to add_mask_prompt adds one object for tracking</span>
<span class="sd">            - Use different obj_id values for different objects</span>
<span class="sd">            - Use obj_ids different from those detected by generate_masks()</span>
<span class="sd">            - The mask should be binary (0/False for background, 1/True for object)</span>
<span class="sd">            - For best results, ensure mask dimensions match the video frame size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Check if tracker has been initialized (has propagated at least once)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">_ALL_INFERENCE_STATES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot find session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">; it might have expired&quot;</span>
            <span class="p">)</span>
        <span class="n">inference_state</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>

        <span class="c1"># Check if tracker is initialized by looking for cached outputs</span>
        <span class="n">has_cached_outputs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">inference_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cached_frame_outputs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">tracker_states</span> <span class="o">=</span> <span class="n">inference_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tracker_inference_states&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_cached_outputs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracker_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Tracker not initialized. Please call init_tracker() or &quot;</span>
                <span class="s2">&quot;generate_masks() first to initialize the tracker before adding &quot;</span>
                <span class="s2">&quot;mask prompts. Example: sam.init_tracker() or sam.generate_masks(&#39;object&#39;)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Convert mask to numpy array and ensure 2D</span>
        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Convert to binary</span>
        <span class="n">mask_np</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span><span class="p">):</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                <span class="n">mask_np</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">),</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Find coordinates where mask is True</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Empty mask for object </span><span class="si">{</span><span class="n">obj_id</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;frame_index&quot;</span><span class="p">:</span> <span class="n">frame_idx</span><span class="p">,</span>
                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;out_obj_ids&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;out_binary_masks&quot;</span><span class="p">:</span> <span class="p">[]},</span>
            <span class="p">}</span>

        <span class="c1"># Sample points from the mask region</span>
        <span class="c1"># Use stratified sampling for better coverage</span>
        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">n_points</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
            <span class="c1"># Use all points if fewer than requested</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sample points with good spatial coverage</span>
            <span class="c1"># Use k-means-like approach: divide mask into regions and sample from each</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>  <span class="c1"># All positive points</span>

        <span class="c1"># Use add_point_prompts to add the object</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_point_prompts</span><span class="p">(</span>
            <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">,</span>
            <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Added mask for object </span><span class="si">{</span><span class="n">obj_id</span><span class="si">}</span><span class="s2"> on frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2"> points.&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_masks_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">obj_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add multiple mask prompts from an external segmentation model.</span>

<span class="sd">        Convenience method to add multiple masks at once. This is equivalent</span>
<span class="sd">        to calling add_mask_prompt() for each mask.</span>

<span class="sd">        **Important**: The tracker must be initialized first by calling</span>
<span class="sd">        `generate_masks()` with any text prompt before using `add_masks_prompt()`.</span>
<span class="sd">        This is a requirement of SAM3&#39;s video tracking architecture.</span>

<span class="sd">        Args:</span>
<span class="sd">            masks (List[np.ndarray]): List of binary mask arrays, each of shape</span>
<span class="sd">                (H, W) where True/1 indicates the object region.</span>
<span class="sd">            obj_ids (List[int], optional): List of object IDs for each mask.</span>
<span class="sd">                If None, IDs will be assigned starting from 100 to avoid</span>
<span class="sd">                conflicts with objects detected by generate_masks().</span>
<span class="sd">            frame_idx (int): Frame index to add the masks on. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: List of responses, one for each mask added.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Get multiple object masks from external model</span>
<span class="sd">            &gt;&gt;&gt; masks = external_model.segment_all_objects(first_frame)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Initialize SAM3 and tracker</span>
<span class="sd">            &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">            &gt;&gt;&gt; sam.set_video(&quot;video.mp4&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.init_tracker()  # Initialize tracker first!</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Add all masks for tracking</span>
<span class="sd">            &gt;&gt;&gt; sam.add_masks_prompt(masks)  # Adds masks with IDs 100, 101, ...</span>
<span class="sd">            &gt;&gt;&gt; sam.propagate()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Start from 100 to avoid conflicts with text-prompt detected objects</span>
            <span class="n">obj_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of masks (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;number of obj_ids (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">oid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">obj_ids</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_mask_prompt</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="n">oid</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">)</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span><span class="si">}</span><span class="s2"> mask(s) for tracking.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">responses</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove one or more objects from tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj_id (Union[int, List[int]]): Object ID(s) to remove.</span>
<span class="sd">                Can be a single int or a list of ints.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;person&quot;)  # Finds 3 people</span>
<span class="sd">            &gt;&gt;&gt; sam.remove_object(2)  # Remove person with ID 2</span>
<span class="sd">            &gt;&gt;&gt; sam.remove_object([1, 3])  # Remove multiple objects at once</span>
<span class="sd">            &gt;&gt;&gt; sam.propagate()  # Re-propagate without removed objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Convert single int to list for uniform processing</span>
        <span class="n">obj_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj_id</span>

        <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">obj_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
                <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;remove_object&quot;</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                    <span class="n">obj_id</span><span class="o">=</span><span class="n">oid</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed object </span><span class="si">{</span><span class="n">obj_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed objects </span><span class="si">{</span><span class="n">obj_ids</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Propagate masks through all frames of the video.</span>

<span class="sd">        This tracks the segmented objects from the prompt frame through</span>
<span class="sd">        the entire video.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[int, Any]: Dictionary mapping frame index to mask outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

        <span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_stream_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;propagate_in_video&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">outputs_per_frame</span><span class="p">[</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;frame_index&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="n">outputs_per_frame</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Propagated masks to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs_per_frame</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs_per_frame</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the outputs_per_frame into a simpler structure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict mapping frame_idx to Dict mapping obj_id to mask array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">formatted</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">frame_idx</span><span class="p">,</span> <span class="n">outputs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">formatted</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Handle different output formats</span>
            <span class="k">if</span> <span class="s2">&quot;out_obj_ids&quot;</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="c1"># Format from propagate_in_video or add_prompt response</span>
                <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_obj_ids&quot;</span><span class="p">]</span>
                <span class="c1"># Try multiple possible mask keys</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;out_binary_masks&quot;</span><span class="p">,</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_mask_logits&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[])),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">,</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
                    <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                        <span class="n">formatted</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">][</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="k">elif</span> <span class="s2">&quot;object_ids&quot;</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="c1"># Format from add_prompt response</span>
                <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;object_ids&quot;</span><span class="p">]</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">,</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
                    <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                        <span class="n">formatted</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">][</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Already in {obj_id: mask} format</span>
                <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                        <span class="n">formatted</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">][</span><span class="n">obj_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">formatted</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_masks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">img_ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save segmentation masks to files.</span>

<span class="sd">        For GeoTIFF time series, masks are saved with georeferencing information.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): Directory to save mask files.</span>
<span class="sd">            img_ext (str): Image extension for output files. Defaults to &quot;png&quot;.</span>
<span class="sd">                For GeoTIFF time series, this is overridden to &quot;tif&quot;.</span>
<span class="sd">            dtype (str): Data type for mask values. Defaults to &quot;uint8&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: List of saved file paths.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;building&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.save_masks(&quot;output/masks/&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to save. Please run generate_masks() first.&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Prepare mask data using our custom formatter</span>
        <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">formatted_outputs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No masks to save.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">num_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">)))</span>
        <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check if we have GeoTIFF source</span>
        <span class="n">is_geotiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_geotiff</span><span class="p">:</span>
            <span class="n">img_ext</span> <span class="o">=</span> <span class="s2">&quot;tif&quot;</span>

        <span class="c1"># Determine frame dimensions once</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">first_frame</span> <span class="o">=</span> <span class="n">load_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">first_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">formatted_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Saving masks&quot;</span><span class="p">):</span>
            <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Combine all object masks with unique IDs</span>
            <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="c1"># Resize mask if needed</span>
                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                        <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_id</span>

            <span class="c1"># Determine output path</span>
            <span class="k">if</span> <span class="n">is_geotiff</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_mask.</span><span class="si">{</span><span class="n">img_ext</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">crs_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_digits</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">img_ext</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">crs_source</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_geotiff</span><span class="p">:</span>
                <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">crs_source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mask_array</span><span class="p">)</span>
                <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

            <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> mask files to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_video</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">frame_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save segmentation results as a video with blended masks.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path (str): Path to save the output video (MP4).</span>
<span class="sd">            fps (int): Frames per second for the output video. Defaults to 30.</span>
<span class="sd">            alpha (float): Opacity for mask overlay. Defaults to 0.6.</span>
<span class="sd">            dpi (int): DPI for rendering. Defaults to 200.</span>
<span class="sd">            frame_stride (int): Process every nth frame. Defaults to 1.</span>
<span class="sd">            show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs</span>
<span class="sd">                on the video. If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">                If a dict, maps object IDs to custom labels (e.g., player names).</span>
<span class="sd">                Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Path to the saved video.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;car&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;)</span>
<span class="sd">            &gt;&gt;&gt; # With custom labels</span>
<span class="sd">            &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;, show_ids={1: &quot;Player A&quot;, 2: &quot;Player B&quot;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to save. Please run generate_masks() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Create temporary directory for frames</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">make_temp_dir</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Save blended frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_blended_frames</span><span class="p">(</span>
            <span class="n">temp_dir</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">frame_stride</span><span class="o">=</span><span class="n">frame_stride</span><span class="p">,</span>
            <span class="n">show_ids</span><span class="o">=</span><span class="n">show_ids</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create video from frames</span>
        <span class="n">common</span><span class="o">.</span><span class="n">images_to_video</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved video to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_blended_frames</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">frame_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save frames with blended mask overlays.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): Directory to save blended frames.</span>
<span class="sd">            alpha (float): Opacity for mask overlay.</span>
<span class="sd">            dpi (int): DPI for rendering (not used in optimized version).</span>
<span class="sd">            frame_stride (int): Process every nth frame.</span>
<span class="sd">            show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs.</span>
<span class="sd">                If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">                If a dict, maps object IDs to custom labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">)</span>
        <span class="n">num_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_frames</span><span class="p">))</span>

        <span class="c1"># Pre-compute colors (tab10 colormap)</span>
        <span class="n">tab10_colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>  <span class="c1"># blue</span>
            <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>  <span class="c1"># orange</span>
            <span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">44</span><span class="p">),</span>  <span class="c1"># green</span>
            <span class="p">(</span><span class="mi">214</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>  <span class="c1"># red</span>
            <span class="p">(</span><span class="mi">148</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">189</span><span class="p">),</span>  <span class="c1"># purple</span>
            <span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>  <span class="c1"># brown</span>
            <span class="p">(</span><span class="mi">227</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">194</span><span class="p">),</span>  <span class="c1"># pink</span>
            <span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">),</span>  <span class="c1"># gray</span>
            <span class="p">(</span><span class="mi">188</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span>  <span class="c1"># olive</span>
            <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">207</span><span class="p">),</span>  <span class="c1"># cyan</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">frame_stride</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Rendering frames&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">frame_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">formatted_outputs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Load frame</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>

            <span class="n">frame_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">frame_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Create overlay for all masks</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">mask_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>
            <span class="n">labels_to_draw</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_id</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">color</span> <span class="o">=</span> <span class="n">tab10_colors</span><span class="p">[</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">]</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

                <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                        <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Add color to overlay where mask is present</span>
                <span class="n">mask_bool</span> <span class="o">=</span> <span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">,</span> <span class="n">color</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">overlay</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">])</span>
                <span class="n">mask_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mask_combined</span><span class="p">,</span> <span class="n">mask_np</span><span class="p">)</span>

                <span class="c1"># Collect label info</span>
                <span class="k">if</span> <span class="n">show_ids</span><span class="p">:</span>
                    <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bool</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">show_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
                        <span class="n">labels_to_draw</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>

            <span class="c1"># Blend overlay with frame</span>
            <span class="n">mask_3d</span> <span class="o">=</span> <span class="n">mask_combined</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">blended</span> <span class="o">=</span> <span class="n">frame_np</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mask_3d</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">overlay</span> <span class="o">*</span> <span class="p">(</span><span class="n">mask_3d</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">blended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Draw labels using OpenCV</span>
            <span class="k">for</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">labels_to_draw</span><span class="p">:</span>
                <span class="c1"># Get text size for background rectangle</span>
                <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span>
                <span class="n">font_scale</span> <span class="o">=</span> <span class="mf">0.7</span>
                <span class="n">thickness</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="p">(</span><span class="n">text_w</span><span class="p">,</span> <span class="n">text_h</span><span class="p">),</span> <span class="n">baseline</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_scale</span><span class="p">,</span> <span class="n">thickness</span>
                <span class="p">)</span>

                <span class="c1"># Draw background rectangle</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">text_w</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">pad</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">text_h</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">pad</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">text_w</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pad</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">text_h</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">baseline</span>

                <span class="c1"># Semi-transparent background</span>
                <span class="n">sub_img</span> <span class="o">=</span> <span class="n">blended</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">sub_img</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bg_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">blend_rect</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_img</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="n">bg_color</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="n">blended</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">blend_rect</span>
                    <span class="p">)</span>

                <span class="c1"># Draw text</span>
                <span class="n">text_x</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">text_w</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">text_y</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">text_h</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span>
                    <span class="n">blended</span><span class="p">,</span>
                    <span class="n">label</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">),</span>
                    <span class="n">font</span><span class="p">,</span>
                    <span class="n">font_scale</span><span class="p">,</span>
                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
                    <span class="n">thickness</span><span class="p">,</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Save frame</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_digits</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">blended</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_frame</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display a single frame with mask overlay.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_idx (int): Frame index to display. Defaults to 0.</span>
<span class="sd">            figsize (Tuple[int, int]): Figure size. Defaults to (12, 8).</span>
<span class="sd">            alpha (float): Opacity for mask overlay. Defaults to 0.6.</span>
<span class="sd">            show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs.</span>
<span class="sd">                If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">                If a dict, maps object IDs to custom labels (e.g., player names).</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            axis (str): Axis visibility setting. Defaults to &quot;off&quot;.</span>
<span class="sd">            output (str, optional): Path to save the figure. Defaults to None.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;tree&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.show_frame(0)  # Show first frame</span>
<span class="sd">            &gt;&gt;&gt; sam.show_frame(50, output=&quot;frame_50.png&quot;)  # Save frame 50</span>
<span class="sd">            &gt;&gt;&gt; # With custom labels</span>
<span class="sd">            &gt;&gt;&gt; sam.show_frame(0, show_ids={1: &quot;Player A&quot;, 2: &quot;Player B&quot;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to show. Please run generate_masks() first.&quot;</span><span class="p">)</span>

        <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">frame_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">formatted_outputs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2"> not in outputs.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Load frame</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>

        <span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">size</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># Overlay masks</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_id</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">alpha</span><span class="p">])</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                    <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span><span class="p">),</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>

            <span class="c1"># Add object ID label</span>
            <span class="k">if</span> <span class="n">show_ids</span><span class="p">:</span>
                <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
                    <span class="c1"># Determine label text</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">show_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="n">cx</span><span class="p">,</span>
                        <span class="n">cy</span><span class="p">,</span>
                        <span class="n">label</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                        <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                            <span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved frame to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_frames</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frame_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">ncols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">figsize_per_frame</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display multiple frames with mask overlays in a grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_stride (int): Show every nth frame. Defaults to 10.</span>
<span class="sd">            ncols (int): Number of columns in the grid. Defaults to 3.</span>
<span class="sd">            figsize_per_frame (Tuple[int, int]): Size per subplot. Defaults to (6, 4).</span>
<span class="sd">            alpha (float): Opacity for mask overlay. Defaults to 0.6.</span>
<span class="sd">            show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs.</span>
<span class="sd">                If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">                If a dict, maps object IDs to custom labels (e.g., player names).</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; sam.generate_masks(&quot;person&quot;)</span>
<span class="sd">            &gt;&gt;&gt; sam.show_frames(frame_stride=30, ncols=4)</span>
<span class="sd">            &gt;&gt;&gt; # With custom labels</span>
<span class="sd">            &gt;&gt;&gt; sam.show_frames(show_ids={1: &quot;Player A&quot;, 2: &quot;Player B&quot;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to show. Please run generate_masks() first.&quot;</span><span class="p">)</span>

        <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>
        <span class="n">frame_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">),</span> <span class="n">frame_stride</span><span class="p">))</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="p">,</span>
            <span class="n">ncols</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize_per_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize_per_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">axes</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Load frame</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>

            <span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">size</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="n">formatted_outputs</span><span class="p">:</span>
                <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_id</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">alpha</span><span class="p">])</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

                    <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
                    <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">):</span>
                        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                            <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span><span class="p">),</span>
                            <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">show_ids</span><span class="p">:</span>
                        <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
                            <span class="c1"># Determine label text</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="n">show_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                                <span class="n">cx</span><span class="p">,</span>
                                <span class="n">cy</span><span class="p">,</span>
                                <span class="n">label</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="p">)</span>

        <span class="c1"># Hide unused subplots</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the current session and free GPU resources.</span>

<span class="sd">        Call this when you&#39;re done with the current video and want to</span>
<span class="sd">        process a new one, or when you want to free up memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
                <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;close_session&quot;</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session closed.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shutdown the predictor and free all GPU resources.</span>

<span class="sd">        Call this when you&#39;re completely done with video segmentation.</span>
<span class="sd">        After calling this, you cannot use this instance anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictor shutdown complete.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Destructor to clean up resources.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.__del__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__del__</span><span class="p">()</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.__del__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Destructor to clean up resources.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5239</span>
<span class="normal">5240</span>
<span class="normal">5241</span>
<span class="normal">5242</span>
<span class="normal">5243</span>
<span class="normal">5244</span>
<span class="normal">5245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Destructor to clean up resources.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;session_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">gpus_to_use</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bpe_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the SamGeo3Video class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>gpus_to_use</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of GPU indices to use.
If None, uses all available GPUs. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bpe_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the BPE tokenizer vocabulary.
If None, uses the default path. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to build_sam3_video_predictor.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3932</span>
<span class="normal">3933</span>
<span class="normal">3934</span>
<span class="normal">3935</span>
<span class="normal">3936</span>
<span class="normal">3937</span>
<span class="normal">3938</span>
<span class="normal">3939</span>
<span class="normal">3940</span>
<span class="normal">3941</span>
<span class="normal">3942</span>
<span class="normal">3943</span>
<span class="normal">3944</span>
<span class="normal">3945</span>
<span class="normal">3946</span>
<span class="normal">3947</span>
<span class="normal">3948</span>
<span class="normal">3949</span>
<span class="normal">3950</span>
<span class="normal">3951</span>
<span class="normal">3952</span>
<span class="normal">3953</span>
<span class="normal">3954</span>
<span class="normal">3955</span>
<span class="normal">3956</span>
<span class="normal">3957</span>
<span class="normal">3958</span>
<span class="normal">3959</span>
<span class="normal">3960</span>
<span class="normal">3961</span>
<span class="normal">3962</span>
<span class="normal">3963</span>
<span class="normal">3964</span>
<span class="normal">3965</span>
<span class="normal">3966</span>
<span class="normal">3967</span>
<span class="normal">3968</span>
<span class="normal">3969</span>
<span class="normal">3970</span>
<span class="normal">3971</span>
<span class="normal">3972</span>
<span class="normal">3973</span>
<span class="normal">3974</span>
<span class="normal">3975</span>
<span class="normal">3976</span>
<span class="normal">3977</span>
<span class="normal">3978</span>
<span class="normal">3979</span>
<span class="normal">3980</span>
<span class="normal">3981</span>
<span class="normal">3982</span>
<span class="normal">3983</span>
<span class="normal">3984</span>
<span class="normal">3985</span>
<span class="normal">3986</span>
<span class="normal">3987</span>
<span class="normal">3988</span>
<span class="normal">3989</span>
<span class="normal">3990</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">gpus_to_use</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bpe_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the SamGeo3Video class.</span>

<span class="sd">    Args:</span>
<span class="sd">        gpus_to_use (List[int], optional): List of GPU indices to use.</span>
<span class="sd">            If None, uses all available GPUs. Defaults to None.</span>
<span class="sd">        bpe_path (str, optional): Path to the BPE tokenizer vocabulary.</span>
<span class="sd">            If None, uses the default path. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to build_sam3_video_predictor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">SAM3_META_AVAILABLE</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;SAM3 is not available. Please install it as:</span><span class="se">\n\t</span><span class="s2">&quot;</span>
            <span class="s2">&quot;pip install segment-geospatial[samgeo3]&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">SAM3_META_IMPORT_ERROR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Underlying import error:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">SAM3_META_IMPORT_ERROR</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

    <span class="c1"># Set up GPU configuration</span>
    <span class="k">if</span> <span class="n">gpus_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gpus_to_use</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gpus_to_use</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gpus_to_use</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">()]</span>

    <span class="c1"># Set up BPE path</span>
    <span class="k">if</span> <span class="n">bpe_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">bpe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="s2">&quot;bpe_simple_vocab_16e6.txt.gz&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bpe_path</span><span class="p">):</span>
            <span class="n">bpe_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bpe_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">bpe_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/giswqs/geospatial/resolve/main/bpe_simple_vocab_16e6.txt.gz&quot;</span>
            <span class="n">bpe_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">bpe_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using GPUs: </span><span class="si">{</span><span class="n">gpus_to_use</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">build_sam3_video_predictor</span><span class="p">(</span>
        <span class="n">gpus_to_use</span><span class="o">=</span><span class="n">gpus_to_use</span><span class="p">,</span> <span class="n">bpe_path</span><span class="o">=</span><span class="n">bpe_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gpus_to_use</span> <span class="o">=</span> <span class="n">gpus_to_use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tif_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.add_box_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_box_prompt</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">box_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.add_box_prompt" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a bounding box prompt to segment an object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>box</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box in [x, y, width, height] format.
In pixel coordinates by default, or in the specified CRS.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>obj_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object ID to associate with this prompt.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to add the prompt on. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for box
(e.g., "EPSG:4326"). Only used with GeoTIFF time series.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Response containing the mask output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.add_box_prompt([100, 100, 200, 150], obj_id=1)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4311</span>
<span class="normal">4312</span>
<span class="normal">4313</span>
<span class="normal">4314</span>
<span class="normal">4315</span>
<span class="normal">4316</span>
<span class="normal">4317</span>
<span class="normal">4318</span>
<span class="normal">4319</span>
<span class="normal">4320</span>
<span class="normal">4321</span>
<span class="normal">4322</span>
<span class="normal">4323</span>
<span class="normal">4324</span>
<span class="normal">4325</span>
<span class="normal">4326</span>
<span class="normal">4327</span>
<span class="normal">4328</span>
<span class="normal">4329</span>
<span class="normal">4330</span>
<span class="normal">4331</span>
<span class="normal">4332</span>
<span class="normal">4333</span>
<span class="normal">4334</span>
<span class="normal">4335</span>
<span class="normal">4336</span>
<span class="normal">4337</span>
<span class="normal">4338</span>
<span class="normal">4339</span>
<span class="normal">4340</span>
<span class="normal">4341</span>
<span class="normal">4342</span>
<span class="normal">4343</span>
<span class="normal">4344</span>
<span class="normal">4345</span>
<span class="normal">4346</span>
<span class="normal">4347</span>
<span class="normal">4348</span>
<span class="normal">4349</span>
<span class="normal">4350</span>
<span class="normal">4351</span>
<span class="normal">4352</span>
<span class="normal">4353</span>
<span class="normal">4354</span>
<span class="normal">4355</span>
<span class="normal">4356</span>
<span class="normal">4357</span>
<span class="normal">4358</span>
<span class="normal">4359</span>
<span class="normal">4360</span>
<span class="normal">4361</span>
<span class="normal">4362</span>
<span class="normal">4363</span>
<span class="normal">4364</span>
<span class="normal">4365</span>
<span class="normal">4366</span>
<span class="normal">4367</span>
<span class="normal">4368</span>
<span class="normal">4369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_box_prompt</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">box</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">box_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a bounding box prompt to segment an object.</span>

<span class="sd">    Args:</span>
<span class="sd">        box (List[float]): Bounding box in [x, y, width, height] format.</span>
<span class="sd">            In pixel coordinates by default, or in the specified CRS.</span>
<span class="sd">        obj_id (int): Object ID to associate with this prompt.</span>
<span class="sd">        frame_idx (int): Frame index to add the prompt on. Defaults to 0.</span>
<span class="sd">        box_crs (str, optional): Coordinate reference system for box</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot;). Only used with GeoTIFF time series.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Response containing the mask output.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.add_box_prompt([100, 100, 200, 150], obj_id=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span>

    <span class="c1"># Transform coordinates if CRS is provided</span>
    <span class="k">if</span> <span class="n">box_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Convert box corners to pixel coordinates</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">]])</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">box_crs</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y</span>

    <span class="c1"># Convert to relative coordinates [cx, cy, w, h]</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span>
    <span class="n">rel_w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span>
    <span class="n">rel_h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span>

    <span class="n">box_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">rel_w</span><span class="p">,</span> <span class="n">rel_h</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
            <span class="n">box</span><span class="o">=</span><span class="n">box_tensor</span><span class="p">,</span>
            <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_mask_prompt</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a mask prompt from an external segmentation model.</p>
<p>This allows using masks generated by other segmentation models
(e.g., YOLO, Detectron2, GroundingDINO, etc.) and leveraging SAM3's
tracking capability to propagate them through the video.</p>
<p>This is useful when SAM3's text prompts don't segment the exact objects
you need. You can:
1. Use another model to get accurate segmentation on the first frame
2. Pass those masks to SAM3 using this method
3. Use SAM3's tracking to propagate the masks through the video</p>
<p>The method works by sampling positive points from the mask region and
using SAM3's point prompt capability to segment and track the object.</p>
<p><strong>Important</strong>: The tracker must be initialized first by calling
<code>init_tracker()</code> (recommended) or <code>generate_masks()</code> (alternative) with any text prompt before using <code>add_mask_prompt()</code>.
This is a requirement of SAM3's video tracking architecture.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Binary mask array of shape (H, W) where
True/1 indicates the object region. Can be bool or numeric.
The mask should match the video frame dimensions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>obj_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object ID to associate with this mask. Use different
IDs for different objects you want to track.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to add the mask on. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_points</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of points to sample from the mask region.
More points can improve accuracy. Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Response containing the mask output with keys:
- "frame_index": The frame index where mask was added
- "outputs": Dict with "out_obj_ids" and mask data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt--workflow-use-external-model-sam3-tracking">Workflow: Use external model + SAM3 tracking<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--workflow-use-external-model-sam3-tracking" title="Permanent link">&para;</a></h4>
<p>from your_segmentation_model import segment_objects</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-1-get-segmentation-from-another-model-on-first-frame">Step 1: Get segmentation from another model on first frame<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-1-get-segmentation-from-another-model-on-first-frame" title="Permanent link">&para;</a></h4>
<p>first_frame = load_image("frames/0.jpg")
external_masks = segment_objects(first_frame)  # Your model</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-2-initialize-sam3-video-tracker">Step 2: Initialize SAM3 video tracker<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-2-initialize-sam3-video-tracker" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3Video()
sam.set_video("frames/")  # Load video frames</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-3-initialize-tracker-for-external-masks">Step 3: Initialize tracker for external masks<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-3-initialize-tracker-for-external-masks" title="Permanent link">&para;</a></h4>
<p>sam.init_tracker()  # Initialize tracker for external masks</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-4-add-external-masks-for-tracking-use-new-obj_ids">Step 4: Add external masks for tracking (use new obj_ids)<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-4-add-external-masks-for-tracking-use-new-obj_ids" title="Permanent link">&para;</a></h4>
<p>for i, mask in enumerate(external_masks):
...     sam.add_mask_prompt(mask, obj_id=100+i, frame_idx=0)</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-5-propagate-to-track-through-video">Step 5: Propagate to track through video<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_mask_prompt--step-5-propagate-to-track-through-video" title="Permanent link">&para;</a></h4>
<p>sam.propagate()
sam.save_video("tracked_output.mp4")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>The tracker MUST be initialized first by calling either <code>init_tracker()</code> or <code>generate_masks()</code></li>
<li>Each call to add_mask_prompt adds one object for tracking</li>
<li>Use different obj_id values for different objects</li>
<li>Use obj_ids different from those detected by generate_masks()</li>
<li>The mask should be binary (0/False for background, 1/True for object)</li>
<li>For best results, ensure mask dimensions match the video frame size</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4371</span>
<span class="normal">4372</span>
<span class="normal">4373</span>
<span class="normal">4374</span>
<span class="normal">4375</span>
<span class="normal">4376</span>
<span class="normal">4377</span>
<span class="normal">4378</span>
<span class="normal">4379</span>
<span class="normal">4380</span>
<span class="normal">4381</span>
<span class="normal">4382</span>
<span class="normal">4383</span>
<span class="normal">4384</span>
<span class="normal">4385</span>
<span class="normal">4386</span>
<span class="normal">4387</span>
<span class="normal">4388</span>
<span class="normal">4389</span>
<span class="normal">4390</span>
<span class="normal">4391</span>
<span class="normal">4392</span>
<span class="normal">4393</span>
<span class="normal">4394</span>
<span class="normal">4395</span>
<span class="normal">4396</span>
<span class="normal">4397</span>
<span class="normal">4398</span>
<span class="normal">4399</span>
<span class="normal">4400</span>
<span class="normal">4401</span>
<span class="normal">4402</span>
<span class="normal">4403</span>
<span class="normal">4404</span>
<span class="normal">4405</span>
<span class="normal">4406</span>
<span class="normal">4407</span>
<span class="normal">4408</span>
<span class="normal">4409</span>
<span class="normal">4410</span>
<span class="normal">4411</span>
<span class="normal">4412</span>
<span class="normal">4413</span>
<span class="normal">4414</span>
<span class="normal">4415</span>
<span class="normal">4416</span>
<span class="normal">4417</span>
<span class="normal">4418</span>
<span class="normal">4419</span>
<span class="normal">4420</span>
<span class="normal">4421</span>
<span class="normal">4422</span>
<span class="normal">4423</span>
<span class="normal">4424</span>
<span class="normal">4425</span>
<span class="normal">4426</span>
<span class="normal">4427</span>
<span class="normal">4428</span>
<span class="normal">4429</span>
<span class="normal">4430</span>
<span class="normal">4431</span>
<span class="normal">4432</span>
<span class="normal">4433</span>
<span class="normal">4434</span>
<span class="normal">4435</span>
<span class="normal">4436</span>
<span class="normal">4437</span>
<span class="normal">4438</span>
<span class="normal">4439</span>
<span class="normal">4440</span>
<span class="normal">4441</span>
<span class="normal">4442</span>
<span class="normal">4443</span>
<span class="normal">4444</span>
<span class="normal">4445</span>
<span class="normal">4446</span>
<span class="normal">4447</span>
<span class="normal">4448</span>
<span class="normal">4449</span>
<span class="normal">4450</span>
<span class="normal">4451</span>
<span class="normal">4452</span>
<span class="normal">4453</span>
<span class="normal">4454</span>
<span class="normal">4455</span>
<span class="normal">4456</span>
<span class="normal">4457</span>
<span class="normal">4458</span>
<span class="normal">4459</span>
<span class="normal">4460</span>
<span class="normal">4461</span>
<span class="normal">4462</span>
<span class="normal">4463</span>
<span class="normal">4464</span>
<span class="normal">4465</span>
<span class="normal">4466</span>
<span class="normal">4467</span>
<span class="normal">4468</span>
<span class="normal">4469</span>
<span class="normal">4470</span>
<span class="normal">4471</span>
<span class="normal">4472</span>
<span class="normal">4473</span>
<span class="normal">4474</span>
<span class="normal">4475</span>
<span class="normal">4476</span>
<span class="normal">4477</span>
<span class="normal">4478</span>
<span class="normal">4479</span>
<span class="normal">4480</span>
<span class="normal">4481</span>
<span class="normal">4482</span>
<span class="normal">4483</span>
<span class="normal">4484</span>
<span class="normal">4485</span>
<span class="normal">4486</span>
<span class="normal">4487</span>
<span class="normal">4488</span>
<span class="normal">4489</span>
<span class="normal">4490</span>
<span class="normal">4491</span>
<span class="normal">4492</span>
<span class="normal">4493</span>
<span class="normal">4494</span>
<span class="normal">4495</span>
<span class="normal">4496</span>
<span class="normal">4497</span>
<span class="normal">4498</span>
<span class="normal">4499</span>
<span class="normal">4500</span>
<span class="normal">4501</span>
<span class="normal">4502</span>
<span class="normal">4503</span>
<span class="normal">4504</span>
<span class="normal">4505</span>
<span class="normal">4506</span>
<span class="normal">4507</span>
<span class="normal">4508</span>
<span class="normal">4509</span>
<span class="normal">4510</span>
<span class="normal">4511</span>
<span class="normal">4512</span>
<span class="normal">4513</span>
<span class="normal">4514</span>
<span class="normal">4515</span>
<span class="normal">4516</span>
<span class="normal">4517</span>
<span class="normal">4518</span>
<span class="normal">4519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_mask_prompt</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a mask prompt from an external segmentation model.</span>

<span class="sd">    This allows using masks generated by other segmentation models</span>
<span class="sd">    (e.g., YOLO, Detectron2, GroundingDINO, etc.) and leveraging SAM3&#39;s</span>
<span class="sd">    tracking capability to propagate them through the video.</span>

<span class="sd">    This is useful when SAM3&#39;s text prompts don&#39;t segment the exact objects</span>
<span class="sd">    you need. You can:</span>
<span class="sd">    1. Use another model to get accurate segmentation on the first frame</span>
<span class="sd">    2. Pass those masks to SAM3 using this method</span>
<span class="sd">    3. Use SAM3&#39;s tracking to propagate the masks through the video</span>

<span class="sd">    The method works by sampling positive points from the mask region and</span>
<span class="sd">    using SAM3&#39;s point prompt capability to segment and track the object.</span>

<span class="sd">    **Important**: The tracker must be initialized first by calling</span>
<span class="sd">    `init_tracker()` (recommended) or `generate_masks()` (alternative) with any text prompt before using `add_mask_prompt()`.</span>
<span class="sd">    This is a requirement of SAM3&#39;s video tracking architecture.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask (np.ndarray): Binary mask array of shape (H, W) where</span>
<span class="sd">            True/1 indicates the object region. Can be bool or numeric.</span>
<span class="sd">            The mask should match the video frame dimensions.</span>
<span class="sd">        obj_id (int): Object ID to associate with this mask. Use different</span>
<span class="sd">            IDs for different objects you want to track.</span>
<span class="sd">        frame_idx (int): Frame index to add the mask on. Defaults to 0.</span>
<span class="sd">        num_points (int): Number of points to sample from the mask region.</span>
<span class="sd">            More points can improve accuracy. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Response containing the mask output with keys:</span>
<span class="sd">            - &quot;frame_index&quot;: The frame index where mask was added</span>
<span class="sd">            - &quot;outputs&quot;: Dict with &quot;out_obj_ids&quot; and mask data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Workflow: Use external model + SAM3 tracking</span>
<span class="sd">        &gt;&gt;&gt; from your_segmentation_model import segment_objects</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Step 1: Get segmentation from another model on first frame</span>
<span class="sd">        &gt;&gt;&gt; first_frame = load_image(&quot;frames/0.jpg&quot;)</span>
<span class="sd">        &gt;&gt;&gt; external_masks = segment_objects(first_frame)  # Your model</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Step 2: Initialize SAM3 video tracker</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;frames/&quot;)  # Load video frames</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Step 3: Initialize tracker for external masks</span>
<span class="sd">        &gt;&gt;&gt; sam.init_tracker()  # Initialize tracker for external masks</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Step 4: Add external masks for tracking (use new obj_ids)</span>
<span class="sd">        &gt;&gt;&gt; for i, mask in enumerate(external_masks):</span>
<span class="sd">        ...     sam.add_mask_prompt(mask, obj_id=100+i, frame_idx=0)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Step 5: Propagate to track through video</span>
<span class="sd">        &gt;&gt;&gt; sam.propagate()</span>
<span class="sd">        &gt;&gt;&gt; sam.save_video(&quot;tracked_output.mp4&quot;)</span>

<span class="sd">    Note:</span>
<span class="sd">        - The tracker MUST be initialized first by calling either `init_tracker()` or `generate_masks()`</span>
<span class="sd">        - Each call to add_mask_prompt adds one object for tracking</span>
<span class="sd">        - Use different obj_id values for different objects</span>
<span class="sd">        - Use obj_ids different from those detected by generate_masks()</span>
<span class="sd">        - The mask should be binary (0/False for background, 1/True for object)</span>
<span class="sd">        - For best results, ensure mask dimensions match the video frame size</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if tracker has been initialized (has propagated at least once)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">_ALL_INFERENCE_STATES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cannot find session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">; it might have expired&quot;</span>
        <span class="p">)</span>
    <span class="n">inference_state</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>

    <span class="c1"># Check if tracker is initialized by looking for cached outputs</span>
    <span class="n">has_cached_outputs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">inference_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cached_frame_outputs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="n">tracker_states</span> <span class="o">=</span> <span class="n">inference_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tracker_inference_states&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_cached_outputs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracker_states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Tracker not initialized. Please call init_tracker() or &quot;</span>
            <span class="s2">&quot;generate_masks() first to initialize the tracker before adding &quot;</span>
            <span class="s2">&quot;mask prompts. Example: sam.init_tracker() or sam.generate_masks(&#39;object&#39;)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Convert mask to numpy array and ensure 2D</span>
    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># Convert to binary</span>
    <span class="n">mask_np</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
    <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span><span class="p">):</span>
        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">mask_np</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">),</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Find coordinates where mask is True</span>
    <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Empty mask for object </span><span class="si">{</span><span class="n">obj_id</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;frame_index&quot;</span><span class="p">:</span> <span class="n">frame_idx</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;out_obj_ids&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;out_binary_masks&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="p">}</span>

    <span class="c1"># Sample points from the mask region</span>
    <span class="c1"># Use stratified sampling for better coverage</span>
    <span class="n">n_points</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">n_points</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
        <span class="c1"># Use all points if fewer than requested</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Sample points with good spatial coverage</span>
        <span class="c1"># Use k-means-like approach: divide mask into regions and sample from each</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>  <span class="c1"># All positive points</span>

    <span class="c1"># Use add_point_prompts to add the object</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_point_prompts</span><span class="p">(</span>
        <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">,</span>
        <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Added mask for object </span><span class="si">{</span><span class="n">obj_id</span><span class="si">}</span><span class="s2"> on frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2"> points.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.add_masks_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_masks_prompt</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">obj_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add multiple mask prompts from an external segmentation model.</p>
<p>Convenience method to add multiple masks at once. This is equivalent
to calling add_mask_prompt() for each mask.</p>
<p><strong>Important</strong>: The tracker must be initialized first by calling
<code>generate_masks()</code> with any text prompt before using <code>add_masks_prompt()</code>.
This is a requirement of SAM3's video tracking architecture.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>masks</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of binary mask arrays, each of shape
(H, W) where True/1 indicates the object region.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>obj_ids</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of object IDs for each mask.
If None, IDs will be assigned starting from 100 to avoid
conflicts with objects detected by generate_masks().</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to add the masks on. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[Dict[str, Any]]: List of responses, one for each mask added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_masks_prompt--get-multiple-object-masks-from-external-model">Get multiple object masks from external model<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--get-multiple-object-masks-from-external-model" title="Permanent link">&para;</a></h4>
<p>masks = external_model.segment_all_objects(first_frame)</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_masks_prompt--initialize-sam3-and-tracker">Initialize SAM3 and tracker<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--initialize-sam3-and-tracker" title="Permanent link">&para;</a></h4>
<p>sam = SamGeo3Video()
sam.set_video("video.mp4")
sam.init_tracker()  # Initialize tracker first!</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_masks_prompt--add-all-masks-for-tracking">Add all masks for tracking<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_masks_prompt--add-all-masks-for-tracking" title="Permanent link">&para;</a></h4>
<p>sam.add_masks_prompt(masks)  # Adds masks with IDs 100, 101, ...
sam.propagate()</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4521</span>
<span class="normal">4522</span>
<span class="normal">4523</span>
<span class="normal">4524</span>
<span class="normal">4525</span>
<span class="normal">4526</span>
<span class="normal">4527</span>
<span class="normal">4528</span>
<span class="normal">4529</span>
<span class="normal">4530</span>
<span class="normal">4531</span>
<span class="normal">4532</span>
<span class="normal">4533</span>
<span class="normal">4534</span>
<span class="normal">4535</span>
<span class="normal">4536</span>
<span class="normal">4537</span>
<span class="normal">4538</span>
<span class="normal">4539</span>
<span class="normal">4540</span>
<span class="normal">4541</span>
<span class="normal">4542</span>
<span class="normal">4543</span>
<span class="normal">4544</span>
<span class="normal">4545</span>
<span class="normal">4546</span>
<span class="normal">4547</span>
<span class="normal">4548</span>
<span class="normal">4549</span>
<span class="normal">4550</span>
<span class="normal">4551</span>
<span class="normal">4552</span>
<span class="normal">4553</span>
<span class="normal">4554</span>
<span class="normal">4555</span>
<span class="normal">4556</span>
<span class="normal">4557</span>
<span class="normal">4558</span>
<span class="normal">4559</span>
<span class="normal">4560</span>
<span class="normal">4561</span>
<span class="normal">4562</span>
<span class="normal">4563</span>
<span class="normal">4564</span>
<span class="normal">4565</span>
<span class="normal">4566</span>
<span class="normal">4567</span>
<span class="normal">4568</span>
<span class="normal">4569</span>
<span class="normal">4570</span>
<span class="normal">4571</span>
<span class="normal">4572</span>
<span class="normal">4573</span>
<span class="normal">4574</span>
<span class="normal">4575</span>
<span class="normal">4576</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_masks_prompt</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">obj_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add multiple mask prompts from an external segmentation model.</span>

<span class="sd">    Convenience method to add multiple masks at once. This is equivalent</span>
<span class="sd">    to calling add_mask_prompt() for each mask.</span>

<span class="sd">    **Important**: The tracker must be initialized first by calling</span>
<span class="sd">    `generate_masks()` with any text prompt before using `add_masks_prompt()`.</span>
<span class="sd">    This is a requirement of SAM3&#39;s video tracking architecture.</span>

<span class="sd">    Args:</span>
<span class="sd">        masks (List[np.ndarray]): List of binary mask arrays, each of shape</span>
<span class="sd">            (H, W) where True/1 indicates the object region.</span>
<span class="sd">        obj_ids (List[int], optional): List of object IDs for each mask.</span>
<span class="sd">            If None, IDs will be assigned starting from 100 to avoid</span>
<span class="sd">            conflicts with objects detected by generate_masks().</span>
<span class="sd">        frame_idx (int): Frame index to add the masks on. Defaults to 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Dict[str, Any]]: List of responses, one for each mask added.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Get multiple object masks from external model</span>
<span class="sd">        &gt;&gt;&gt; masks = external_model.segment_all_objects(first_frame)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Initialize SAM3 and tracker</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;video.mp4&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.init_tracker()  # Initialize tracker first!</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Add all masks for tracking</span>
<span class="sd">        &gt;&gt;&gt; sam.add_masks_prompt(masks)  # Adds masks with IDs 100, 101, ...</span>
<span class="sd">        &gt;&gt;&gt; sam.propagate()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">obj_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Start from 100 to avoid conflicts with text-prompt detected objects</span>
        <span class="n">obj_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of masks (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;number of obj_ids (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">oid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">obj_ids</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_mask_prompt</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="n">oid</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">)</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span><span class="si">}</span><span class="s2"> mask(s) for tracking.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">responses</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.add_point_prompts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_point_prompts</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">point_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add point prompts to segment or refine an object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>points</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of [x, y] point coordinates.
In pixel coordinates by default, or in the specified CRS.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of labels for each point.
1 for positive (include), 0 for negative (exclude).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>obj_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object ID to associate with this prompt.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to add the prompt on. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>point_crs</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coordinate reference system for points
(e.g., "EPSG:4326"). Only used with GeoTIFF time series.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Response containing the mask output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-point">Add positive point<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-point" title="Permanent link">&para;</a></h4>
<p>sam.add_point_prompts([[500, 300]], [1], obj_id=1)</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-and-negative-points">Add positive and negative points<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.add_point_prompts--add-positive-and-negative-points" title="Permanent link">&para;</a></h4>
<p>sam.add_point_prompts([[500, 300], [600, 400]], [1, 0], obj_id=1)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4252</span>
<span class="normal">4253</span>
<span class="normal">4254</span>
<span class="normal">4255</span>
<span class="normal">4256</span>
<span class="normal">4257</span>
<span class="normal">4258</span>
<span class="normal">4259</span>
<span class="normal">4260</span>
<span class="normal">4261</span>
<span class="normal">4262</span>
<span class="normal">4263</span>
<span class="normal">4264</span>
<span class="normal">4265</span>
<span class="normal">4266</span>
<span class="normal">4267</span>
<span class="normal">4268</span>
<span class="normal">4269</span>
<span class="normal">4270</span>
<span class="normal">4271</span>
<span class="normal">4272</span>
<span class="normal">4273</span>
<span class="normal">4274</span>
<span class="normal">4275</span>
<span class="normal">4276</span>
<span class="normal">4277</span>
<span class="normal">4278</span>
<span class="normal">4279</span>
<span class="normal">4280</span>
<span class="normal">4281</span>
<span class="normal">4282</span>
<span class="normal">4283</span>
<span class="normal">4284</span>
<span class="normal">4285</span>
<span class="normal">4286</span>
<span class="normal">4287</span>
<span class="normal">4288</span>
<span class="normal">4289</span>
<span class="normal">4290</span>
<span class="normal">4291</span>
<span class="normal">4292</span>
<span class="normal">4293</span>
<span class="normal">4294</span>
<span class="normal">4295</span>
<span class="normal">4296</span>
<span class="normal">4297</span>
<span class="normal">4298</span>
<span class="normal">4299</span>
<span class="normal">4300</span>
<span class="normal">4301</span>
<span class="normal">4302</span>
<span class="normal">4303</span>
<span class="normal">4304</span>
<span class="normal">4305</span>
<span class="normal">4306</span>
<span class="normal">4307</span>
<span class="normal">4308</span>
<span class="normal">4309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_point_prompts</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">obj_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">point_crs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add point prompts to segment or refine an object.</span>

<span class="sd">    Args:</span>
<span class="sd">        points (List[List[float]]): List of [x, y] point coordinates.</span>
<span class="sd">            In pixel coordinates by default, or in the specified CRS.</span>
<span class="sd">        labels (List[int]): List of labels for each point.</span>
<span class="sd">            1 for positive (include), 0 for negative (exclude).</span>
<span class="sd">        obj_id (int): Object ID to associate with this prompt.</span>
<span class="sd">        frame_idx (int): Frame index to add the prompt on. Defaults to 0.</span>
<span class="sd">        point_crs (str, optional): Coordinate reference system for points</span>
<span class="sd">            (e.g., &quot;EPSG:4326&quot;). Only used with GeoTIFF time series.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Response containing the mask output.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Add positive point</span>
<span class="sd">        &gt;&gt;&gt; sam.add_point_prompts([[500, 300]], [1], obj_id=1)</span>
<span class="sd">        &gt;&gt;&gt; # Add positive and negative points</span>
<span class="sd">        &gt;&gt;&gt; sam.add_point_prompts([[500, 300], [600, 400]], [1, 0], obj_id=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Transform coordinates if CRS is provided</span>
    <span class="k">if</span> <span class="n">point_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">coords_to_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">point_crs</span><span class="p">)</span>

    <span class="c1"># Convert to relative coordinates (0-1 range)</span>
    <span class="n">rel_points</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_width</span><span class="p">,</span> <span class="n">y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_height</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>

    <span class="n">points_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rel_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">labels_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
            <span class="n">points</span><span class="o">=</span><span class="n">points_tensor</span><span class="p">,</span>
            <span class="n">point_labels</span><span class="o">=</span><span class="n">labels_tensor</span><span class="p">,</span>
            <span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.close" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">close</span><span class="p">()</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.close" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Close the current session and free GPU resources.</p>
<p>Call this when you're done with the current video and want to
process a new one, or when you want to free up memory.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5213</span>
<span class="normal">5214</span>
<span class="normal">5215</span>
<span class="normal">5216</span>
<span class="normal">5217</span>
<span class="normal">5218</span>
<span class="normal">5219</span>
<span class="normal">5220</span>
<span class="normal">5221</span>
<span class="normal">5222</span>
<span class="normal">5223</span>
<span class="normal">5224</span>
<span class="normal">5225</span>
<span class="normal">5226</span>
<span class="normal">5227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close the current session and free GPU resources.</span>

<span class="sd">    Call this when you&#39;re done with the current video and want to</span>
<span class="sd">    process a new one, or when you want to free up memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;close_session&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session closed.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.generate_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_masks</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.generate_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate masks using a text prompt.</p>
<p>This will segment all instances of the described object in the video
and optionally track them through all frames.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text description of objects to segment (e.g., "person", "car").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to add the prompt on. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>propagate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to propagate masks to all frames. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="int">int</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[int, Any]: Dictionary mapping frame index to mask outputs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.generate_masks("building")
sam.generate_masks("tree", frame_idx=10)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4200</span>
<span class="normal">4201</span>
<span class="normal">4202</span>
<span class="normal">4203</span>
<span class="normal">4204</span>
<span class="normal">4205</span>
<span class="normal">4206</span>
<span class="normal">4207</span>
<span class="normal">4208</span>
<span class="normal">4209</span>
<span class="normal">4210</span>
<span class="normal">4211</span>
<span class="normal">4212</span>
<span class="normal">4213</span>
<span class="normal">4214</span>
<span class="normal">4215</span>
<span class="normal">4216</span>
<span class="normal">4217</span>
<span class="normal">4218</span>
<span class="normal">4219</span>
<span class="normal">4220</span>
<span class="normal">4221</span>
<span class="normal">4222</span>
<span class="normal">4223</span>
<span class="normal">4224</span>
<span class="normal">4225</span>
<span class="normal">4226</span>
<span class="normal">4227</span>
<span class="normal">4228</span>
<span class="normal">4229</span>
<span class="normal">4230</span>
<span class="normal">4231</span>
<span class="normal">4232</span>
<span class="normal">4233</span>
<span class="normal">4234</span>
<span class="normal">4235</span>
<span class="normal">4236</span>
<span class="normal">4237</span>
<span class="normal">4238</span>
<span class="normal">4239</span>
<span class="normal">4240</span>
<span class="normal">4241</span>
<span class="normal">4242</span>
<span class="normal">4243</span>
<span class="normal">4244</span>
<span class="normal">4245</span>
<span class="normal">4246</span>
<span class="normal">4247</span>
<span class="normal">4248</span>
<span class="normal">4249</span>
<span class="normal">4250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">propagate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate masks using a text prompt.</span>

<span class="sd">    This will segment all instances of the described object in the video</span>
<span class="sd">    and optionally track them through all frames.</span>

<span class="sd">    Args:</span>
<span class="sd">        prompt (str): Text description of objects to segment (e.g., &quot;person&quot;, &quot;car&quot;).</span>
<span class="sd">        frame_idx (int): Frame index to add the prompt on. Defaults to 0.</span>
<span class="sd">        propagate (bool): Whether to propagate masks to all frames. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[int, Any]: Dictionary mapping frame index to mask outputs.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;building&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;tree&quot;, frame_idx=10)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="c1"># Reset prompts before adding new text prompt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># Add text prompt</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span>
    <span class="c1"># Get object IDs - key is &#39;out_obj_ids&#39; from SAM3 video predictor</span>
    <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out_obj_ids&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">,</span> <span class="s2">&quot;tolist&quot;</span><span class="p">):</span>
        <span class="n">obj_ids</span> <span class="o">=</span> <span class="n">obj_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_objects</span><span class="si">}</span><span class="s2"> object(s) matching &#39;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#39; on frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">propagate</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagate</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.init_tracker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_tracker</span><span class="p">(</span><span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.init_tracker" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the tracker without detecting any objects.</p>
<p>This method initializes SAM3's video tracking state, which is required
before using point prompts (add_point_prompts), box prompts (add_box_prompt),
or mask prompts (add_mask_prompt).</p>
<p>Call this method when you want to:
- Use only point or box prompts without text-based detection
- Add external masks from other segmentation models
- Have full control over which objects to track</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to initialize the tracker on. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3Video()
sam.set_video("video.mp4")
sam.init_tracker()  # Initialize without detecting anything
sam.add_point_prompts([[500, 300]], [1], obj_id=1)  # Add object via point
sam.add_box_prompt([100, 100, 200, 150], obj_id=2)  # Add object via box
sam.propagate()  # Track through video
sam.save_video("output.mp4")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>This is equivalent to calling generate_masks() with a prompt that
  matches no objects, but provides a cleaner API.</li>
<li>The tracker must be initialized before adding point/box/mask prompts.</li>
<li>After init_tracker(), you can add objects using:</li>
<li>add_point_prompts() for point-based segmentation</li>
<li>add_box_prompt() for box-based segmentation</li>
<li>add_mask_prompt() for external mask tracking</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4142</span>
<span class="normal">4143</span>
<span class="normal">4144</span>
<span class="normal">4145</span>
<span class="normal">4146</span>
<span class="normal">4147</span>
<span class="normal">4148</span>
<span class="normal">4149</span>
<span class="normal">4150</span>
<span class="normal">4151</span>
<span class="normal">4152</span>
<span class="normal">4153</span>
<span class="normal">4154</span>
<span class="normal">4155</span>
<span class="normal">4156</span>
<span class="normal">4157</span>
<span class="normal">4158</span>
<span class="normal">4159</span>
<span class="normal">4160</span>
<span class="normal">4161</span>
<span class="normal">4162</span>
<span class="normal">4163</span>
<span class="normal">4164</span>
<span class="normal">4165</span>
<span class="normal">4166</span>
<span class="normal">4167</span>
<span class="normal">4168</span>
<span class="normal">4169</span>
<span class="normal">4170</span>
<span class="normal">4171</span>
<span class="normal">4172</span>
<span class="normal">4173</span>
<span class="normal">4174</span>
<span class="normal">4175</span>
<span class="normal">4176</span>
<span class="normal">4177</span>
<span class="normal">4178</span>
<span class="normal">4179</span>
<span class="normal">4180</span>
<span class="normal">4181</span>
<span class="normal">4182</span>
<span class="normal">4183</span>
<span class="normal">4184</span>
<span class="normal">4185</span>
<span class="normal">4186</span>
<span class="normal">4187</span>
<span class="normal">4188</span>
<span class="normal">4189</span>
<span class="normal">4190</span>
<span class="normal">4191</span>
<span class="normal">4192</span>
<span class="normal">4193</span>
<span class="normal">4194</span>
<span class="normal">4195</span>
<span class="normal">4196</span>
<span class="normal">4197</span>
<span class="normal">4198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the tracker without detecting any objects.</span>

<span class="sd">    This method initializes SAM3&#39;s video tracking state, which is required</span>
<span class="sd">    before using point prompts (add_point_prompts), box prompts (add_box_prompt),</span>
<span class="sd">    or mask prompts (add_mask_prompt).</span>

<span class="sd">    Call this method when you want to:</span>
<span class="sd">    - Use only point or box prompts without text-based detection</span>
<span class="sd">    - Add external masks from other segmentation models</span>
<span class="sd">    - Have full control over which objects to track</span>

<span class="sd">    Args:</span>
<span class="sd">        frame_idx (int): Frame index to initialize the tracker on. Defaults to 0.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;video.mp4&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.init_tracker()  # Initialize without detecting anything</span>
<span class="sd">        &gt;&gt;&gt; sam.add_point_prompts([[500, 300]], [1], obj_id=1)  # Add object via point</span>
<span class="sd">        &gt;&gt;&gt; sam.add_box_prompt([100, 100, 200, 150], obj_id=2)  # Add object via box</span>
<span class="sd">        &gt;&gt;&gt; sam.propagate()  # Track through video</span>
<span class="sd">        &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;)</span>

<span class="sd">    Note:</span>
<span class="sd">        - This is equivalent to calling generate_masks() with a prompt that</span>
<span class="sd">          matches no objects, but provides a cleaner API.</span>
<span class="sd">        - The tracker must be initialized before adding point/box/mask prompts.</span>
<span class="sd">        - After init_tracker(), you can add objects using:</span>
<span class="sd">          - add_point_prompts() for point-based segmentation</span>
<span class="sd">          - add_box_prompt() for box-based segmentation</span>
<span class="sd">          - add_mask_prompt() for external mask tracking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="c1"># Reset prompts before initializing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># Use a nonsense text prompt that won&#39;t match any real objects</span>
    <span class="c1"># This initializes the tracker state without detecting anything</span>
    <span class="n">_init_prompt</span> <span class="o">=</span> <span class="s2">&quot;__samgeo_init_tracker_placeholder_xyzzy_12345__&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;add_prompt&quot;</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">_init_prompt</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Run propagation to fully initialize the tracker state</span>
    <span class="c1"># This populates cached_frame_outputs which is required for point prompts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">propagate</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracker initialized. You can now add point, box, or mask prompts.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.propagate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">propagate</span><span class="p">()</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.propagate" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Propagate masks through all frames of the video.</p>
<p>This tracks the segmented objects from the prompt frame through
the entire video.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="int">int</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[int, Any]: Dictionary mapping frame index to mask outputs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4611</span>
<span class="normal">4612</span>
<span class="normal">4613</span>
<span class="normal">4614</span>
<span class="normal">4615</span>
<span class="normal">4616</span>
<span class="normal">4617</span>
<span class="normal">4618</span>
<span class="normal">4619</span>
<span class="normal">4620</span>
<span class="normal">4621</span>
<span class="normal">4622</span>
<span class="normal">4623</span>
<span class="normal">4624</span>
<span class="normal">4625</span>
<span class="normal">4626</span>
<span class="normal">4627</span>
<span class="normal">4628</span>
<span class="normal">4629</span>
<span class="normal">4630</span>
<span class="normal">4631</span>
<span class="normal">4632</span>
<span class="normal">4633</span>
<span class="normal">4634</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Propagate masks through all frames of the video.</span>

<span class="sd">    This tracks the segmented objects from the prompt frame through</span>
<span class="sd">    the entire video.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[int, Any]: Dictionary mapping frame index to mask outputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_stream_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;propagate_in_video&quot;</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">):</span>
        <span class="n">outputs_per_frame</span><span class="p">[</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;frame_index&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="n">outputs_per_frame</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Propagated masks to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs_per_frame</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs_per_frame</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.remove_object" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_object</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.remove_object" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Remove one or more objects from tracking.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>obj_id</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="int">int</span>, <span title="typing.List">List</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Object ID(s) to remove.
Can be a single int or a list of ints.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.generate_masks("person")  # Finds 3 people
sam.remove_object(2)  # Remove person with ID 2
sam.remove_object([1, 3])  # Remove multiple objects at once
sam.propagate()  # Re-propagate without removed objects</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4578</span>
<span class="normal">4579</span>
<span class="normal">4580</span>
<span class="normal">4581</span>
<span class="normal">4582</span>
<span class="normal">4583</span>
<span class="normal">4584</span>
<span class="normal">4585</span>
<span class="normal">4586</span>
<span class="normal">4587</span>
<span class="normal">4588</span>
<span class="normal">4589</span>
<span class="normal">4590</span>
<span class="normal">4591</span>
<span class="normal">4592</span>
<span class="normal">4593</span>
<span class="normal">4594</span>
<span class="normal">4595</span>
<span class="normal">4596</span>
<span class="normal">4597</span>
<span class="normal">4598</span>
<span class="normal">4599</span>
<span class="normal">4600</span>
<span class="normal">4601</span>
<span class="normal">4602</span>
<span class="normal">4603</span>
<span class="normal">4604</span>
<span class="normal">4605</span>
<span class="normal">4606</span>
<span class="normal">4607</span>
<span class="normal">4608</span>
<span class="normal">4609</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove one or more objects from tracking.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj_id (Union[int, List[int]]): Object ID(s) to remove.</span>
<span class="sd">            Can be a single int or a list of ints.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;person&quot;)  # Finds 3 people</span>
<span class="sd">        &gt;&gt;&gt; sam.remove_object(2)  # Remove person with ID 2</span>
<span class="sd">        &gt;&gt;&gt; sam.remove_object([1, 3])  # Remove multiple objects at once</span>
<span class="sd">        &gt;&gt;&gt; sam.propagate()  # Re-propagate without removed objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="c1"># Convert single int to list for uniform processing</span>
    <span class="n">obj_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_id</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj_id</span>

    <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">obj_ids</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;remove_object&quot;</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">obj_id</span><span class="o">=</span><span class="n">oid</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed object </span><span class="si">{</span><span class="n">obj_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed objects </span><span class="si">{</span><span class="n">obj_ids</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.reset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reset</span><span class="p">()</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.reset" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Reset the current session, clearing all prompts and masks.</p>
<p>Use this when you want to start fresh with new prompts on the same video.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4125</span>
<span class="normal">4126</span>
<span class="normal">4127</span>
<span class="normal">4128</span>
<span class="normal">4129</span>
<span class="normal">4130</span>
<span class="normal">4131</span>
<span class="normal">4132</span>
<span class="normal">4133</span>
<span class="normal">4134</span>
<span class="normal">4135</span>
<span class="normal">4136</span>
<span class="normal">4137</span>
<span class="normal">4138</span>
<span class="normal">4139</span>
<span class="normal">4140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset the current session, clearing all prompts and masks.</span>

<span class="sd">    Use this when you want to start fresh with new prompts on the same video.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No session active. Please call set_video() first.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;reset_session&quot;</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session reset.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.save_masks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_masks</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">img_ext</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.save_masks" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save segmentation masks to files.</p>
<p>For GeoTIFF time series, masks are saved with georeferencing information.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save mask files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>img_ext</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Image extension for output files. Defaults to "png".
For GeoTIFF time series, this is overridden to "tif".</p>
              </div>
            </td>
            <td>
                  <code>&#39;png&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data type for mask values. Defaults to "uint8".</p>
              </div>
            </td>
            <td>
                  <code>&#39;uint8&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List[str]: List of saved file paths.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.generate_masks("building")
sam.save_masks("output/masks/")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4706</span>
<span class="normal">4707</span>
<span class="normal">4708</span>
<span class="normal">4709</span>
<span class="normal">4710</span>
<span class="normal">4711</span>
<span class="normal">4712</span>
<span class="normal">4713</span>
<span class="normal">4714</span>
<span class="normal">4715</span>
<span class="normal">4716</span>
<span class="normal">4717</span>
<span class="normal">4718</span>
<span class="normal">4719</span>
<span class="normal">4720</span>
<span class="normal">4721</span>
<span class="normal">4722</span>
<span class="normal">4723</span>
<span class="normal">4724</span>
<span class="normal">4725</span>
<span class="normal">4726</span>
<span class="normal">4727</span>
<span class="normal">4728</span>
<span class="normal">4729</span>
<span class="normal">4730</span>
<span class="normal">4731</span>
<span class="normal">4732</span>
<span class="normal">4733</span>
<span class="normal">4734</span>
<span class="normal">4735</span>
<span class="normal">4736</span>
<span class="normal">4737</span>
<span class="normal">4738</span>
<span class="normal">4739</span>
<span class="normal">4740</span>
<span class="normal">4741</span>
<span class="normal">4742</span>
<span class="normal">4743</span>
<span class="normal">4744</span>
<span class="normal">4745</span>
<span class="normal">4746</span>
<span class="normal">4747</span>
<span class="normal">4748</span>
<span class="normal">4749</span>
<span class="normal">4750</span>
<span class="normal">4751</span>
<span class="normal">4752</span>
<span class="normal">4753</span>
<span class="normal">4754</span>
<span class="normal">4755</span>
<span class="normal">4756</span>
<span class="normal">4757</span>
<span class="normal">4758</span>
<span class="normal">4759</span>
<span class="normal">4760</span>
<span class="normal">4761</span>
<span class="normal">4762</span>
<span class="normal">4763</span>
<span class="normal">4764</span>
<span class="normal">4765</span>
<span class="normal">4766</span>
<span class="normal">4767</span>
<span class="normal">4768</span>
<span class="normal">4769</span>
<span class="normal">4770</span>
<span class="normal">4771</span>
<span class="normal">4772</span>
<span class="normal">4773</span>
<span class="normal">4774</span>
<span class="normal">4775</span>
<span class="normal">4776</span>
<span class="normal">4777</span>
<span class="normal">4778</span>
<span class="normal">4779</span>
<span class="normal">4780</span>
<span class="normal">4781</span>
<span class="normal">4782</span>
<span class="normal">4783</span>
<span class="normal">4784</span>
<span class="normal">4785</span>
<span class="normal">4786</span>
<span class="normal">4787</span>
<span class="normal">4788</span>
<span class="normal">4789</span>
<span class="normal">4790</span>
<span class="normal">4791</span>
<span class="normal">4792</span>
<span class="normal">4793</span>
<span class="normal">4794</span>
<span class="normal">4795</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_masks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">img_ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save segmentation masks to files.</span>

<span class="sd">    For GeoTIFF time series, masks are saved with georeferencing information.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir (str): Directory to save mask files.</span>
<span class="sd">        img_ext (str): Image extension for output files. Defaults to &quot;png&quot;.</span>
<span class="sd">            For GeoTIFF time series, this is overridden to &quot;tif&quot;.</span>
<span class="sd">        dtype (str): Data type for mask values. Defaults to &quot;uint8&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: List of saved file paths.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;building&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.save_masks(&quot;output/masks/&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to save. Please run generate_masks() first.&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Prepare mask data using our custom formatter</span>
    <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">formatted_outputs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No masks to save.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">num_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">)))</span>
    <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check if we have GeoTIFF source</span>
    <span class="n">is_geotiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">is_geotiff</span><span class="p">:</span>
        <span class="n">img_ext</span> <span class="o">=</span> <span class="s2">&quot;tif&quot;</span>

    <span class="c1"># Determine frame dimensions once</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">first_frame</span> <span class="o">=</span> <span class="n">load_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">first_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">formatted_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Saving masks&quot;</span><span class="p">):</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Combine all object masks with unique IDs</span>
        <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="c1"># Resize mask if needed</span>
            <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                    <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">mask_array</span><span class="p">[</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_id</span>

        <span class="c1"># Determine output path</span>
        <span class="k">if</span> <span class="n">is_geotiff</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_mask.</span><span class="si">{</span><span class="n">img_ext</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">crs_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tif_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_digits</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">img_ext</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">crs_source</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_geotiff</span><span class="p">:</span>
            <span class="n">common</span><span class="o">.</span><span class="n">array_to_image</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">crs_source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mask_array</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

        <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> mask files to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.save_video" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_video</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">frame_stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.save_video" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save segmentation results as a video with blended masks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the output video (MP4).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frames per second for the output video. Defaults to 30.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Opacity for mask overlay. Defaults to 0.6.</p>
              </div>
            </td>
            <td>
                  <code>0.6</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dpi</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DPI for rendering. Defaults to 200.</p>
              </div>
            </td>
            <td>
                  <code>200</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Process every nth frame. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_ids</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="typing.Dict">Dict</span>[<span title="int">int</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show object IDs
on the video. If True, shows numeric IDs. If False, hides IDs.
If a dict, maps object IDs to custom labels (e.g., player names).
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved video.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.generate_masks("car")
sam.save_video("output.mp4")</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.save_video--with-custom-labels">With custom labels<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.save_video--with-custom-labels" title="Permanent link">&para;</a></h4>
<p>sam.save_video("output.mp4", show_ids={1: "Player A", 2: "Player B"})</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4797</span>
<span class="normal">4798</span>
<span class="normal">4799</span>
<span class="normal">4800</span>
<span class="normal">4801</span>
<span class="normal">4802</span>
<span class="normal">4803</span>
<span class="normal">4804</span>
<span class="normal">4805</span>
<span class="normal">4806</span>
<span class="normal">4807</span>
<span class="normal">4808</span>
<span class="normal">4809</span>
<span class="normal">4810</span>
<span class="normal">4811</span>
<span class="normal">4812</span>
<span class="normal">4813</span>
<span class="normal">4814</span>
<span class="normal">4815</span>
<span class="normal">4816</span>
<span class="normal">4817</span>
<span class="normal">4818</span>
<span class="normal">4819</span>
<span class="normal">4820</span>
<span class="normal">4821</span>
<span class="normal">4822</span>
<span class="normal">4823</span>
<span class="normal">4824</span>
<span class="normal">4825</span>
<span class="normal">4826</span>
<span class="normal">4827</span>
<span class="normal">4828</span>
<span class="normal">4829</span>
<span class="normal">4830</span>
<span class="normal">4831</span>
<span class="normal">4832</span>
<span class="normal">4833</span>
<span class="normal">4834</span>
<span class="normal">4835</span>
<span class="normal">4836</span>
<span class="normal">4837</span>
<span class="normal">4838</span>
<span class="normal">4839</span>
<span class="normal">4840</span>
<span class="normal">4841</span>
<span class="normal">4842</span>
<span class="normal">4843</span>
<span class="normal">4844</span>
<span class="normal">4845</span>
<span class="normal">4846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_video</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">frame_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save segmentation results as a video with blended masks.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path (str): Path to save the output video (MP4).</span>
<span class="sd">        fps (int): Frames per second for the output video. Defaults to 30.</span>
<span class="sd">        alpha (float): Opacity for mask overlay. Defaults to 0.6.</span>
<span class="sd">        dpi (int): DPI for rendering. Defaults to 200.</span>
<span class="sd">        frame_stride (int): Process every nth frame. Defaults to 1.</span>
<span class="sd">        show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs</span>
<span class="sd">            on the video. If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">            If a dict, maps object IDs to custom labels (e.g., player names).</span>
<span class="sd">            Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the saved video.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;car&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # With custom labels</span>
<span class="sd">        &gt;&gt;&gt; sam.save_video(&quot;output.mp4&quot;, show_ids={1: &quot;Player A&quot;, 2: &quot;Player B&quot;})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to save. Please run generate_masks() first.&quot;</span><span class="p">)</span>

    <span class="c1"># Create temporary directory for frames</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">make_temp_dir</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save blended frames</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_save_blended_frames</span><span class="p">(</span>
        <span class="n">temp_dir</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
        <span class="n">frame_stride</span><span class="o">=</span><span class="n">frame_stride</span><span class="p">,</span>
        <span class="n">show_ids</span><span class="o">=</span><span class="n">show_ids</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create video from frames</span>
    <span class="n">common</span><span class="o">.</span><span class="n">images_to_video</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved video to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.set_video" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.set_video" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load a video or time series images for segmentation.</p>
<p>The video can be:
- An MP4 video file
- A directory of JPEG frames
- A directory of GeoTIFF images (for time series remote sensing data)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>video_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the video file or image directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save extracted frames.
Only used when video_path is an MP4 file. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame_rate</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame rate for extracting frames from video.
Only used when video_path is an MP4 file. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for extracted frame filenames. Defaults to "".</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bands</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of band indices (1-based) to use for RGB
when the input is a GeoTIFF directory with multi-band images. For example,
[4, 3, 2] for NIR-R-G false color composite. If None, uses the
first 3 bands for multi-band images. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam = SamGeo3Video()
sam.set_video("video.mp4")  # Load MP4 video
sam.set_video("frames/")  # Load from JPEG frames directory
sam.set_video("landsat_ts/")  # Load GeoTIFF time series
sam.set_video("landsat_ts/", bands=[4, 3, 2])  # NIR-R-G composite</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3992</span>
<span class="normal">3993</span>
<span class="normal">3994</span>
<span class="normal">3995</span>
<span class="normal">3996</span>
<span class="normal">3997</span>
<span class="normal">3998</span>
<span class="normal">3999</span>
<span class="normal">4000</span>
<span class="normal">4001</span>
<span class="normal">4002</span>
<span class="normal">4003</span>
<span class="normal">4004</span>
<span class="normal">4005</span>
<span class="normal">4006</span>
<span class="normal">4007</span>
<span class="normal">4008</span>
<span class="normal">4009</span>
<span class="normal">4010</span>
<span class="normal">4011</span>
<span class="normal">4012</span>
<span class="normal">4013</span>
<span class="normal">4014</span>
<span class="normal">4015</span>
<span class="normal">4016</span>
<span class="normal">4017</span>
<span class="normal">4018</span>
<span class="normal">4019</span>
<span class="normal">4020</span>
<span class="normal">4021</span>
<span class="normal">4022</span>
<span class="normal">4023</span>
<span class="normal">4024</span>
<span class="normal">4025</span>
<span class="normal">4026</span>
<span class="normal">4027</span>
<span class="normal">4028</span>
<span class="normal">4029</span>
<span class="normal">4030</span>
<span class="normal">4031</span>
<span class="normal">4032</span>
<span class="normal">4033</span>
<span class="normal">4034</span>
<span class="normal">4035</span>
<span class="normal">4036</span>
<span class="normal">4037</span>
<span class="normal">4038</span>
<span class="normal">4039</span>
<span class="normal">4040</span>
<span class="normal">4041</span>
<span class="normal">4042</span>
<span class="normal">4043</span>
<span class="normal">4044</span>
<span class="normal">4045</span>
<span class="normal">4046</span>
<span class="normal">4047</span>
<span class="normal">4048</span>
<span class="normal">4049</span>
<span class="normal">4050</span>
<span class="normal">4051</span>
<span class="normal">4052</span>
<span class="normal">4053</span>
<span class="normal">4054</span>
<span class="normal">4055</span>
<span class="normal">4056</span>
<span class="normal">4057</span>
<span class="normal">4058</span>
<span class="normal">4059</span>
<span class="normal">4060</span>
<span class="normal">4061</span>
<span class="normal">4062</span>
<span class="normal">4063</span>
<span class="normal">4064</span>
<span class="normal">4065</span>
<span class="normal">4066</span>
<span class="normal">4067</span>
<span class="normal">4068</span>
<span class="normal">4069</span>
<span class="normal">4070</span>
<span class="normal">4071</span>
<span class="normal">4072</span>
<span class="normal">4073</span>
<span class="normal">4074</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_video</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">video_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frame_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a video or time series images for segmentation.</span>

<span class="sd">    The video can be:</span>
<span class="sd">    - An MP4 video file</span>
<span class="sd">    - A directory of JPEG frames</span>
<span class="sd">    - A directory of GeoTIFF images (for time series remote sensing data)</span>

<span class="sd">    Args:</span>
<span class="sd">        video_path (str): Path to the video file or image directory.</span>
<span class="sd">        output_dir (str, optional): Directory to save extracted frames.</span>
<span class="sd">            Only used when video_path is an MP4 file. Defaults to None.</span>
<span class="sd">        frame_rate (int, optional): Frame rate for extracting frames from video.</span>
<span class="sd">            Only used when video_path is an MP4 file. Defaults to None.</span>
<span class="sd">        prefix (str): Prefix for extracted frame filenames. Defaults to &quot;&quot;.</span>
<span class="sd">        bands (List[int], optional): List of band indices (1-based) to use for RGB</span>
<span class="sd">            when the input is a GeoTIFF directory with multi-band images. For example,</span>
<span class="sd">            [4, 3, 2] for NIR-R-G false color composite. If None, uses the</span>
<span class="sd">            first 3 bands for multi-band images. Defaults to None.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam = SamGeo3Video()</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;video.mp4&quot;)  # Load MP4 video</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;frames/&quot;)  # Load from JPEG frames directory</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;landsat_ts/&quot;)  # Load GeoTIFF time series</span>
<span class="sd">        &gt;&gt;&gt; sam.set_video(&quot;landsat_ts/&quot;, bands=[4, 3, 2])  # NIR-R-G composite</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">video_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
            <span class="n">video_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
            <span class="c1"># MP4 video file - extract frames</span>
            <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">make_temp_dir</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting frames to: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">common</span><span class="o">.</span><span class="n">video_to_images</span><span class="p">(</span>
                <span class="n">video_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">frame_rate</span><span class="o">=</span><span class="n">frame_rate</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span>
            <span class="p">)</span>
            <span class="n">video_path</span> <span class="o">=</span> <span class="n">output_dir</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">video_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files found in </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># Check if it&#39;s a GeoTIFF directory</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tif_source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tif_dir</span> <span class="o">=</span> <span class="n">video_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tif_names</span> <span class="o">=</span> <span class="n">files</span>
                <span class="c1"># Convert GeoTIFFs to JPEGs for SAM3</span>
                <span class="n">video_path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">geotiff_to_jpg_batch</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="n">bands</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted GeoTIFFs to JPEGs: </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">video_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path </span><span class="si">{</span><span class="n">video_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;video_path must be a string.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="n">video_path</span>

    <span class="c1"># Load frames for visualization</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_load_video_frames</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>

    <span class="c1"># Start a session</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;start_session&quot;</span><span class="p">,</span>
            <span class="n">resource_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames. Session started.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.show_frame" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_frame</span><span class="p">(</span><span class="n">frame_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">show_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.show_frame" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Display a single frame with mask overlay.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>frame_idx</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frame index to display. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Figure size. Defaults to (12, 8).</p>
              </div>
            </td>
            <td>
                  <code>(12, 8)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Opacity for mask overlay. Defaults to 0.6.</p>
              </div>
            </td>
            <td>
                  <code>0.6</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_ids</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="typing.Dict">Dict</span>[<span title="int">int</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show object IDs.
If True, shows numeric IDs. If False, hides IDs.
If a dict, maps object IDs to custom labels (e.g., player names).
Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>axis</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Axis visibility setting. Defaults to "off".</p>
              </div>
            </td>
            <td>
                  <code>&#39;off&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to save the figure. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.generate_masks("tree")
sam.show_frame(0)  # Show first frame
sam.show_frame(50, output="frame_50.png")  # Save frame 50</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.show_frame--with-custom-labels">With custom labels<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.show_frame--with-custom-labels" title="Permanent link">&para;</a></h4>
<p>sam.show_frame(0, show_ids={1: "Player A", 2: "Player B"})</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4991</span>
<span class="normal">4992</span>
<span class="normal">4993</span>
<span class="normal">4994</span>
<span class="normal">4995</span>
<span class="normal">4996</span>
<span class="normal">4997</span>
<span class="normal">4998</span>
<span class="normal">4999</span>
<span class="normal">5000</span>
<span class="normal">5001</span>
<span class="normal">5002</span>
<span class="normal">5003</span>
<span class="normal">5004</span>
<span class="normal">5005</span>
<span class="normal">5006</span>
<span class="normal">5007</span>
<span class="normal">5008</span>
<span class="normal">5009</span>
<span class="normal">5010</span>
<span class="normal">5011</span>
<span class="normal">5012</span>
<span class="normal">5013</span>
<span class="normal">5014</span>
<span class="normal">5015</span>
<span class="normal">5016</span>
<span class="normal">5017</span>
<span class="normal">5018</span>
<span class="normal">5019</span>
<span class="normal">5020</span>
<span class="normal">5021</span>
<span class="normal">5022</span>
<span class="normal">5023</span>
<span class="normal">5024</span>
<span class="normal">5025</span>
<span class="normal">5026</span>
<span class="normal">5027</span>
<span class="normal">5028</span>
<span class="normal">5029</span>
<span class="normal">5030</span>
<span class="normal">5031</span>
<span class="normal">5032</span>
<span class="normal">5033</span>
<span class="normal">5034</span>
<span class="normal">5035</span>
<span class="normal">5036</span>
<span class="normal">5037</span>
<span class="normal">5038</span>
<span class="normal">5039</span>
<span class="normal">5040</span>
<span class="normal">5041</span>
<span class="normal">5042</span>
<span class="normal">5043</span>
<span class="normal">5044</span>
<span class="normal">5045</span>
<span class="normal">5046</span>
<span class="normal">5047</span>
<span class="normal">5048</span>
<span class="normal">5049</span>
<span class="normal">5050</span>
<span class="normal">5051</span>
<span class="normal">5052</span>
<span class="normal">5053</span>
<span class="normal">5054</span>
<span class="normal">5055</span>
<span class="normal">5056</span>
<span class="normal">5057</span>
<span class="normal">5058</span>
<span class="normal">5059</span>
<span class="normal">5060</span>
<span class="normal">5061</span>
<span class="normal">5062</span>
<span class="normal">5063</span>
<span class="normal">5064</span>
<span class="normal">5065</span>
<span class="normal">5066</span>
<span class="normal">5067</span>
<span class="normal">5068</span>
<span class="normal">5069</span>
<span class="normal">5070</span>
<span class="normal">5071</span>
<span class="normal">5072</span>
<span class="normal">5073</span>
<span class="normal">5074</span>
<span class="normal">5075</span>
<span class="normal">5076</span>
<span class="normal">5077</span>
<span class="normal">5078</span>
<span class="normal">5079</span>
<span class="normal">5080</span>
<span class="normal">5081</span>
<span class="normal">5082</span>
<span class="normal">5083</span>
<span class="normal">5084</span>
<span class="normal">5085</span>
<span class="normal">5086</span>
<span class="normal">5087</span>
<span class="normal">5088</span>
<span class="normal">5089</span>
<span class="normal">5090</span>
<span class="normal">5091</span>
<span class="normal">5092</span>
<span class="normal">5093</span>
<span class="normal">5094</span>
<span class="normal">5095</span>
<span class="normal">5096</span>
<span class="normal">5097</span>
<span class="normal">5098</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_frame</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">frame_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display a single frame with mask overlay.</span>

<span class="sd">    Args:</span>
<span class="sd">        frame_idx (int): Frame index to display. Defaults to 0.</span>
<span class="sd">        figsize (Tuple[int, int]): Figure size. Defaults to (12, 8).</span>
<span class="sd">        alpha (float): Opacity for mask overlay. Defaults to 0.6.</span>
<span class="sd">        show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs.</span>
<span class="sd">            If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">            If a dict, maps object IDs to custom labels (e.g., player names).</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        axis (str): Axis visibility setting. Defaults to &quot;off&quot;.</span>
<span class="sd">        output (str, optional): Path to save the figure. Defaults to None.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;tree&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.show_frame(0)  # Show first frame</span>
<span class="sd">        &gt;&gt;&gt; sam.show_frame(50, output=&quot;frame_50.png&quot;)  # Save frame 50</span>
<span class="sd">        &gt;&gt;&gt; # With custom labels</span>
<span class="sd">        &gt;&gt;&gt; sam.show_frame(0, show_ids={1: &quot;Player A&quot;, 2: &quot;Player B&quot;})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to show. Please run generate_masks() first.&quot;</span><span class="p">)</span>

    <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">frame_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">formatted_outputs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2"> not in outputs.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Load frame</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>

    <span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">size</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1"># Overlay masks</span>
    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_id</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">alpha</span><span class="p">])</span>
        <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
        <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">):</span>
            <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="p">(</span><span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span><span class="p">),</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>

        <span class="c1"># Add object ID label</span>
        <span class="k">if</span> <span class="n">show_ids</span><span class="p">:</span>
            <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
                <span class="c1"># Determine label text</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">show_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">cx</span><span class="p">,</span>
                    <span class="n">cy</span><span class="p">,</span>
                    <span class="n">label</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                        <span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved frame to </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.show_frames" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_frames</span><span class="p">(</span><span class="n">frame_stride</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize_per_frame</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">show_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.show_frames" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Display multiple frames with mask overlays in a grid.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>frame_stride</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Show every nth frame. Defaults to 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ncols</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of columns in the grid. Defaults to 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>figsize_per_frame</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size per subplot. Defaults to (6, 4).</p>
              </div>
            </td>
            <td>
                  <code>(6, 4)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Opacity for mask overlay. Defaults to 0.6.</p>
              </div>
            </td>
            <td>
                  <code>0.6</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_ids</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="bool">bool</span>, <span title="typing.Dict">Dict</span>[<span title="int">int</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show object IDs.
If True, shows numeric IDs. If False, hides IDs.
If a dict, maps object IDs to custom labels (e.g., player names).
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sam.generate_masks("person")
sam.show_frames(frame_stride=30, ncols=4)</p>
<h4 id="samgeo.samgeo3.SamGeo3Video.show_frames--with-custom-labels">With custom labels<a class="headerlink" href="#samgeo.samgeo3.SamGeo3Video.show_frames--with-custom-labels" title="Permanent link">&para;</a></h4>
<p>sam.show_frames(show_ids={1: "Player A", 2: "Player B"})</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5100</span>
<span class="normal">5101</span>
<span class="normal">5102</span>
<span class="normal">5103</span>
<span class="normal">5104</span>
<span class="normal">5105</span>
<span class="normal">5106</span>
<span class="normal">5107</span>
<span class="normal">5108</span>
<span class="normal">5109</span>
<span class="normal">5110</span>
<span class="normal">5111</span>
<span class="normal">5112</span>
<span class="normal">5113</span>
<span class="normal">5114</span>
<span class="normal">5115</span>
<span class="normal">5116</span>
<span class="normal">5117</span>
<span class="normal">5118</span>
<span class="normal">5119</span>
<span class="normal">5120</span>
<span class="normal">5121</span>
<span class="normal">5122</span>
<span class="normal">5123</span>
<span class="normal">5124</span>
<span class="normal">5125</span>
<span class="normal">5126</span>
<span class="normal">5127</span>
<span class="normal">5128</span>
<span class="normal">5129</span>
<span class="normal">5130</span>
<span class="normal">5131</span>
<span class="normal">5132</span>
<span class="normal">5133</span>
<span class="normal">5134</span>
<span class="normal">5135</span>
<span class="normal">5136</span>
<span class="normal">5137</span>
<span class="normal">5138</span>
<span class="normal">5139</span>
<span class="normal">5140</span>
<span class="normal">5141</span>
<span class="normal">5142</span>
<span class="normal">5143</span>
<span class="normal">5144</span>
<span class="normal">5145</span>
<span class="normal">5146</span>
<span class="normal">5147</span>
<span class="normal">5148</span>
<span class="normal">5149</span>
<span class="normal">5150</span>
<span class="normal">5151</span>
<span class="normal">5152</span>
<span class="normal">5153</span>
<span class="normal">5154</span>
<span class="normal">5155</span>
<span class="normal">5156</span>
<span class="normal">5157</span>
<span class="normal">5158</span>
<span class="normal">5159</span>
<span class="normal">5160</span>
<span class="normal">5161</span>
<span class="normal">5162</span>
<span class="normal">5163</span>
<span class="normal">5164</span>
<span class="normal">5165</span>
<span class="normal">5166</span>
<span class="normal">5167</span>
<span class="normal">5168</span>
<span class="normal">5169</span>
<span class="normal">5170</span>
<span class="normal">5171</span>
<span class="normal">5172</span>
<span class="normal">5173</span>
<span class="normal">5174</span>
<span class="normal">5175</span>
<span class="normal">5176</span>
<span class="normal">5177</span>
<span class="normal">5178</span>
<span class="normal">5179</span>
<span class="normal">5180</span>
<span class="normal">5181</span>
<span class="normal">5182</span>
<span class="normal">5183</span>
<span class="normal">5184</span>
<span class="normal">5185</span>
<span class="normal">5186</span>
<span class="normal">5187</span>
<span class="normal">5188</span>
<span class="normal">5189</span>
<span class="normal">5190</span>
<span class="normal">5191</span>
<span class="normal">5192</span>
<span class="normal">5193</span>
<span class="normal">5194</span>
<span class="normal">5195</span>
<span class="normal">5196</span>
<span class="normal">5197</span>
<span class="normal">5198</span>
<span class="normal">5199</span>
<span class="normal">5200</span>
<span class="normal">5201</span>
<span class="normal">5202</span>
<span class="normal">5203</span>
<span class="normal">5204</span>
<span class="normal">5205</span>
<span class="normal">5206</span>
<span class="normal">5207</span>
<span class="normal">5208</span>
<span class="normal">5209</span>
<span class="normal">5210</span>
<span class="normal">5211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_frames</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">frame_stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">ncols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">figsize_per_frame</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="n">show_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display multiple frames with mask overlays in a grid.</span>

<span class="sd">    Args:</span>
<span class="sd">        frame_stride (int): Show every nth frame. Defaults to 10.</span>
<span class="sd">        ncols (int): Number of columns in the grid. Defaults to 3.</span>
<span class="sd">        figsize_per_frame (Tuple[int, int]): Size per subplot. Defaults to (6, 4).</span>
<span class="sd">        alpha (float): Opacity for mask overlay. Defaults to 0.6.</span>
<span class="sd">        show_ids (Union[bool, Dict[int, str]]): Whether to show object IDs.</span>
<span class="sd">            If True, shows numeric IDs. If False, hides IDs.</span>
<span class="sd">            If a dict, maps object IDs to custom labels (e.g., player names).</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sam.generate_masks(&quot;person&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sam.show_frames(frame_stride=30, ncols=4)</span>
<span class="sd">        &gt;&gt;&gt; # With custom labels</span>
<span class="sd">        &gt;&gt;&gt; sam.show_frames(show_ids={1: &quot;Player A&quot;, 2: &quot;Player B&quot;})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_per_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks to show. Please run generate_masks() first.&quot;</span><span class="p">)</span>

    <span class="n">formatted_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_outputs</span><span class="p">()</span>
    <span class="n">frame_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">),</span> <span class="n">frame_stride</span><span class="p">))</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">nrows</span><span class="p">,</span>
        <span class="n">ncols</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize_per_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">figsize_per_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">axes</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">frame_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load frame</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>

        <span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame_idx</span> <span class="ow">in</span> <span class="n">formatted_outputs</span><span class="p">:</span>
            <span class="n">frame_data</span> <span class="o">=</span> <span class="n">formatted_outputs</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">frame_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_id</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">cmap</span><span class="p">(</span><span class="n">obj_id</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">alpha</span><span class="p">])</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

                <span class="c1"># Resize mask if it doesn&#39;t match frame dimensions</span>
                <span class="k">if</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">):</span>
                    <span class="n">mask_np</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                        <span class="n">mask_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">w_frame</span><span class="p">,</span> <span class="n">h_frame</span><span class="p">),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">mask_image</span> <span class="o">=</span> <span class="n">mask_np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h_frame</span><span class="p">,</span> <span class="n">w_frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_image</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_ids</span><span class="p">:</span>
                    <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_np</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
                        <span class="c1"># Determine label text</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">show_ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">show_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                            <span class="n">cx</span><span class="p">,</span>
                            <span class="n">cy</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

    <span class="c1"># Hide unused subplots</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.show_video" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.show_video" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show the video.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>video_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to video file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>embed</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to embed the video. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to Video.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IPython.display.Video: The video object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4076</span>
<span class="normal">4077</span>
<span class="normal">4078</span>
<span class="normal">4079</span>
<span class="normal">4080</span>
<span class="normal">4081</span>
<span class="normal">4082</span>
<span class="normal">4083</span>
<span class="normal">4084</span>
<span class="normal">4085</span>
<span class="normal">4086</span>
<span class="normal">4087</span>
<span class="normal">4088</span>
<span class="normal">4089</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">embed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show the video.</span>

<span class="sd">    Args:</span>
<span class="sd">        video_path (str): Path to video file.</span>
<span class="sd">        embed (bool, optional): Whether to embed the video. Defaults to True.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to Video.</span>

<span class="sd">    Returns:</span>
<span class="sd">        IPython.display.Video: The video object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Video</span>

    <span class="k">return</span> <span class="n">Video</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="n">embed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="samgeo.samgeo3.SamGeo3Video.shutdown" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shutdown</span><span class="p">()</span></code>

<a href="#samgeo.samgeo3.SamGeo3Video.shutdown" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Shutdown the predictor and free all GPU resources.</p>
<p>Call this when you're completely done with video segmentation.
After calling this, you cannot use this instance anymore.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5229</span>
<span class="normal">5230</span>
<span class="normal">5231</span>
<span class="normal">5232</span>
<span class="normal">5233</span>
<span class="normal">5234</span>
<span class="normal">5235</span>
<span class="normal">5236</span>
<span class="normal">5237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shutdown the predictor and free all GPU resources.</span>

<span class="sd">    Call this when you&#39;re completely done with video segmentation.</span>
<span class="sd">    After calling this, you cannot use this instance anymore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictor shutdown complete.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="samgeo.samgeo3.draw_box_on_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">draw_box_on_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.draw_box_on_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Draw a bounding box on an image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="PIL.Image.Image">Image</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The image to draw on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bounding box in XYWH format [x, y, width, height].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RGB color for the box. Default is green.</p>
              </div>
            </td>
            <td>
                  <code>(0, 255, 0)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thickness</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Line thickness in pixels.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIL.Image.Image: Image with box drawn.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3866</span>
<span class="normal">3867</span>
<span class="normal">3868</span>
<span class="normal">3869</span>
<span class="normal">3870</span>
<span class="normal">3871</span>
<span class="normal">3872</span>
<span class="normal">3873</span>
<span class="normal">3874</span>
<span class="normal">3875</span>
<span class="normal">3876</span>
<span class="normal">3877</span>
<span class="normal">3878</span>
<span class="normal">3879</span>
<span class="normal">3880</span>
<span class="normal">3881</span>
<span class="normal">3882</span>
<span class="normal">3883</span>
<span class="normal">3884</span>
<span class="normal">3885</span>
<span class="normal">3886</span>
<span class="normal">3887</span>
<span class="normal">3888</span>
<span class="normal">3889</span>
<span class="normal">3890</span>
<span class="normal">3891</span>
<span class="normal">3892</span>
<span class="normal">3893</span>
<span class="normal">3894</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">draw_box_on_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw a bounding box on an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (PIL.Image.Image or np.ndarray): The image to draw on.</span>
<span class="sd">        box (List[float]): Bounding box in XYWH format [x, y, width, height].</span>
<span class="sd">        color (Tuple[int, int, int]): RGB color for the box. Default is green.</span>
<span class="sd">        thickness (int): Line thickness in pixels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PIL.Image.Image: Image with box drawn.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageDraw</span>

    <span class="c1"># Convert numpy array to PIL Image if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Make a copy to avoid modifying the original</span>
    <span class="n">image_copy</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image_copy</span><span class="p">)</span>

    <span class="c1"># Extract box coordinates (XYWH format)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span>

    <span class="c1"># Draw rectangle</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">],</span> <span class="n">outline</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">thickness</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image_copy</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="samgeo.samgeo3.generate_colors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_colors</span><span class="p">(</span><span class="n">n_colors</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.generate_colors" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate colors for the masks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n_colors</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of colors to generate. Defaults to 256.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of samples to generate. Defaults to 5000.</p>
              </div>
            </td>
            <td>
                  <code>5000</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: The generated colors in RGB format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3763</span>
<span class="normal">3764</span>
<span class="normal">3765</span>
<span class="normal">3766</span>
<span class="normal">3767</span>
<span class="normal">3768</span>
<span class="normal">3769</span>
<span class="normal">3770</span>
<span class="normal">3771</span>
<span class="normal">3772</span>
<span class="normal">3773</span>
<span class="normal">3774</span>
<span class="normal">3775</span>
<span class="normal">3776</span>
<span class="normal">3777</span>
<span class="normal">3778</span>
<span class="normal">3779</span>
<span class="normal">3780</span>
<span class="normal">3781</span>
<span class="normal">3782</span>
<span class="normal">3783</span>
<span class="normal">3784</span>
<span class="normal">3785</span>
<span class="normal">3786</span>
<span class="normal">3787</span>
<span class="normal">3788</span>
<span class="normal">3789</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_colors</span><span class="p">(</span><span class="n">n_colors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate colors for the masks.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_colors (int, optional): The number of colors to generate. Defaults to 256.</span>
<span class="sd">        n_samples (int, optional): The number of samples to generate. Defaults to 5000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The generated colors in RGB format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Random RGB samples</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Step 2: Convert to LAB for perceptual uniformity</span>
    <span class="c1"># print(f&quot;Converting {n_samples} RGB samples to LAB color space...&quot;)</span>
    <span class="n">lab</span> <span class="o">=</span> <span class="n">rgb2lab</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># print(&quot;Conversion to LAB complete.&quot;)</span>
    <span class="c1"># Step 3: k-means clustering in LAB</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_colors</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># print(f&quot;Fitting KMeans with {n_colors} clusters on {n_samples} samples...&quot;)</span>
    <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
    <span class="c1"># print(&quot;KMeans fitting complete.&quot;)</span>
    <span class="n">centers_lab</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
    <span class="c1"># Step 4: Convert LAB back to RGB</span>
    <span class="n">colors_rgb</span> <span class="o">=</span> <span class="n">lab2rgb</span><span class="p">(</span><span class="n">centers_lab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">colors_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">colors_rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">colors_rgb</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="samgeo.samgeo3.plot_bbox" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_bbox</span><span class="p">(</span><span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">box_format</span><span class="o">=</span><span class="s1">&#39;XYXY&#39;</span><span class="p">,</span> <span class="n">relative_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.plot_bbox" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot the bounding box on the image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>img_height</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The height of the image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>img_width</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of the image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The bounding box.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>box_format</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The format of the bounding box.</p>
              </div>
            </td>
            <td>
                  <code>&#39;XYXY&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>relative_coords</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the coordinates are relative to the image.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The color of the bounding box.</p>
              </div>
            </td>
            <td>
                  <code>&#39;r&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>linestyle</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The line style of the bounding box.</p>
              </div>
            </td>
            <td>
                  <code>&#39;solid&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text to display in the bounding box.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.axes.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axis to plot the bounding box on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3792</span>
<span class="normal">3793</span>
<span class="normal">3794</span>
<span class="normal">3795</span>
<span class="normal">3796</span>
<span class="normal">3797</span>
<span class="normal">3798</span>
<span class="normal">3799</span>
<span class="normal">3800</span>
<span class="normal">3801</span>
<span class="normal">3802</span>
<span class="normal">3803</span>
<span class="normal">3804</span>
<span class="normal">3805</span>
<span class="normal">3806</span>
<span class="normal">3807</span>
<span class="normal">3808</span>
<span class="normal">3809</span>
<span class="normal">3810</span>
<span class="normal">3811</span>
<span class="normal">3812</span>
<span class="normal">3813</span>
<span class="normal">3814</span>
<span class="normal">3815</span>
<span class="normal">3816</span>
<span class="normal">3817</span>
<span class="normal">3818</span>
<span class="normal">3819</span>
<span class="normal">3820</span>
<span class="normal">3821</span>
<span class="normal">3822</span>
<span class="normal">3823</span>
<span class="normal">3824</span>
<span class="normal">3825</span>
<span class="normal">3826</span>
<span class="normal">3827</span>
<span class="normal">3828</span>
<span class="normal">3829</span>
<span class="normal">3830</span>
<span class="normal">3831</span>
<span class="normal">3832</span>
<span class="normal">3833</span>
<span class="normal">3834</span>
<span class="normal">3835</span>
<span class="normal">3836</span>
<span class="normal">3837</span>
<span class="normal">3838</span>
<span class="normal">3839</span>
<span class="normal">3840</span>
<span class="normal">3841</span>
<span class="normal">3842</span>
<span class="normal">3843</span>
<span class="normal">3844</span>
<span class="normal">3845</span>
<span class="normal">3846</span>
<span class="normal">3847</span>
<span class="normal">3848</span>
<span class="normal">3849</span>
<span class="normal">3850</span>
<span class="normal">3851</span>
<span class="normal">3852</span>
<span class="normal">3853</span>
<span class="normal">3854</span>
<span class="normal">3855</span>
<span class="normal">3856</span>
<span class="normal">3857</span>
<span class="normal">3858</span>
<span class="normal">3859</span>
<span class="normal">3860</span>
<span class="normal">3861</span>
<span class="normal">3862</span>
<span class="normal">3863</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_bbox</span><span class="p">(</span>
    <span class="n">img_height</span><span class="p">,</span>
    <span class="n">img_width</span><span class="p">,</span>
    <span class="n">box</span><span class="p">,</span>
    <span class="n">box_format</span><span class="o">=</span><span class="s2">&quot;XYXY&quot;</span><span class="p">,</span>
    <span class="n">relative_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot the bounding box on the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        img_height (int): The height of the image.</span>
<span class="sd">        img_width (int): The width of the image.</span>
<span class="sd">        box (np.ndarray): The bounding box.</span>
<span class="sd">        box_format (str): The format of the bounding box.</span>
<span class="sd">        relative_coords (bool): Whether the coordinates are relative to the image.</span>
<span class="sd">        color (str): The color of the bounding box.</span>
<span class="sd">        linestyle (str): The line style of the bounding box.</span>
<span class="sd">        text (str): The text to display in the bounding box.</span>
<span class="sd">        ax (matplotlib.axes.Axes, optional): The axis to plot the bounding box on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert box to numpy array if it&#39;s a tensor</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">):</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">):</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">box_format</span> <span class="o">==</span> <span class="s2">&quot;XYXY&quot;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">elif</span> <span class="n">box_format</span> <span class="o">==</span> <span class="s2">&quot;XYWH&quot;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span>
    <span class="k">elif</span> <span class="n">box_format</span> <span class="o">==</span> <span class="s2">&quot;CxCyWH&quot;</span><span class="p">:</span>
        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid box_format </span><span class="si">{</span><span class="n">box_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">relative_coords</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">*=</span> <span class="n">img_width</span>
        <span class="n">w</span> <span class="o">*=</span> <span class="n">img_width</span>
        <span class="n">y</span> <span class="o">*=</span> <span class="n">img_height</span>
        <span class="n">h</span> <span class="o">*=</span> <span class="n">img_height</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">facecolor</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;facecolor&quot;</span><span class="p">:</span> <span class="n">facecolor</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="samgeo.samgeo3.plot_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#samgeo.samgeo3.plot_mask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Plot the mask on the image.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The mask to plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>color</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The color of the mask.</p>
              </div>
            </td>
            <td>
                  <code>&#39;r&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.axes.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The axis to plot the mask on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The alpha value for the mask.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>samgeo/samgeo3.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3897</span>
<span class="normal">3898</span>
<span class="normal">3899</span>
<span class="normal">3900</span>
<span class="normal">3901</span>
<span class="normal">3902</span>
<span class="normal">3903</span>
<span class="normal">3904</span>
<span class="normal">3905</span>
<span class="normal">3906</span>
<span class="normal">3907</span>
<span class="normal">3908</span>
<span class="normal">3909</span>
<span class="normal">3910</span>
<span class="normal">3911</span>
<span class="normal">3912</span>
<span class="normal">3913</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot the mask on the image.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask (np.ndarray): The mask to plot.</span>
<span class="sd">        color (str): The color of the mask.</span>
<span class="sd">        ax (matplotlib.axes.Axes, optional): The axis to plot the mask on.</span>
<span class="sd">        alpha (float): The alpha value for the mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im_h</span><span class="p">,</span> <span class="n">im_w</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">im_h</span><span class="p">,</span> <span class="n">im_w</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mask_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_rgb</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="n">mask_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">alpha</span>
    <span class="c1"># Use the provided ax or the current axis</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_img</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    2026-02-28
  </span>

    
    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "search.highlight"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>